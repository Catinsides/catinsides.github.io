<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 如何编写自己的MVC框架 · catinsides.github.io</title><meta name="description" content="如何编写自己的MVC框架 - catinsides"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://catinsides.github.io/atom.xml" title="catinsides.github.io"><meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="catinsides.github.io" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/Catinsides" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">如何编写自己的MVC框架</h1><div class="post-info">2017年1月26日</div><div class="post-content"><p>MVC是一种软件设计模式。顾名思义，这些字母分别代表着模型（Model）、视图（View）和控制器（Controller）。PHP中的MVC旨在分离业务与逻辑层，使得开发过程中的结构清晰，大大提高了效率。当下有很多流行的PHP框架均使用了MVC模式。如果是新手入门，查看这些框架的源代码肯定会一头雾水，毫无思路。上手新框架等于重新开始学习，这必然会消耗不必要的精力和时间。而学习MVC框架最好的方式就是自己动手写一个框架，既学习了设计模式，又巩固了编程能力，何乐而不为。更重要的是，在开发过程中能够将自己的想法融入到框架中去，从而实现各种功能。</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>这篇文章是我<a target="_blank" rel="noopener" href="https://www.google.com.hk/#newwindow=1&safe=active&q=code+your+own+php+mvc+framework">Google</a>学习很多文章后的总结。将各路大神的代码汇总，然后择取出MVC必要的元素，根据个人需要编写出的小型框架，而非使用Composer组装出的框架。这个框架包含以下特点：</p>
<ul>
<li>MVC结构</li>
<li>单一入口</li>
<li>自动加载类</li>
<li>数据库封装</li>
</ul>
<p>根据这个思路，开始coding.</p>
<h3 id="MVC流程"><a href="#MVC流程" class="headerlink" title="MVC流程"></a>MVC流程</h3><p>日常上网过程中可以简化理解为人与服务器中数据库交互的过程。<br>每一次网页上的请求发送到服务器，服务端将请求通过控制器处理后，再传送到模型。<br>模型内包含业务逻辑，负责处理如何与数据库交换数据，数据处理完成后，发送到视图。<br>视图将传来的数据渲染后，最终返还用户。这样便完成了一次请求。<br>熟悉MVC流程后，就有了框架的宏观印象，方便理清结构。</p>
<h3 id="编写框架"><a href="#编写框架" class="headerlink" title="编写框架"></a>编写框架</h3><h4 id="建立目录"><a href="#建立目录" class="headerlink" title="建立目录"></a>建立目录</h4><p>首先，在项目目录下建立如下文件和文件夹:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">|--application</span><br><span class="line">|    |--controllers</span><br><span class="line">|    |--models</span><br><span class="line">|    |--views</span><br><span class="line">|--config</span><br><span class="line">|--framework</span><br><span class="line">|--.htaccess</span><br><span class="line">|--index.php</span><br></pre></td></tr></table></figure>

<p><code>application</code> 内放置用户编写的MVC文件；<br><code>config</code> 内放置数据库设置文件；<br><code>framework</code> 内放置框架的核心文件；<br><code>.htaccess</code> 为重定向文件；<br><code>index.php</code> 为入口文件。</p>
<h4 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h4><p><code>.htaccess</code>是服务器的配置文件，它用来将所有的请求转到入口文件处理。这样一来，网页程序便有了单一入口，掌控用户请求，避免熊孩子的无理取闹（笑。还可以生成对搜索引擎友好的URL。配置内容如下：<br>Apache服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RewriteEngine on</span><br><span class="line"> RewriteCond %&#123;REQUEST_FILENAME&#125; !-f</span><br><span class="line"> RewriteCond %&#123;REQUEST_FILENAME&#125; !-d</span><br><span class="line"> RewriteRule ^(.+)$ index.php/$1 [L]</span><br></pre></td></tr></table></figure>
<p>nginx服务器：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    if(!-<span class="attribute">e</span> <span class="variable">$request_filename</span>)&#123;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^(.+)$</span> /index.php/<span class="variable">$1</span> <span class="literal">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="入口文件"><a href="#入口文件" class="headerlink" title="入口文件"></a>入口文件</h4><p>打开同目录下的index.php文件，输入以下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;./framework/framework.php&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>内容很简单，就是包含核心文件夹内的入口文件。其实在这里可以定义一些预定义常量方便调用，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;APP_PATH&#x27;</span>, <span class="keyword">__DIR__</span>.<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;APP_DEBUG&#x27;</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;APP_URL&#x27;</span>, <span class="string">&#x27;http://localhost&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="核心文件"><a href="#核心文件" class="headerlink" title="核心文件"></a>核心文件</h4><p>外入口文件(index.php)将请求传递给核心文件的内入口文件(framework.php)后，接下来的工作由核心文件完成。framework.php的内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;FRAME_PATH&#x27;</span>) <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;FRAME_PATH&#x27;</span>, <span class="keyword">__DIR__</span>.<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;APP_PATH&#x27;</span>) <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;APP_PATH&#x27;</span>, <span class="title function_ invoke__">dirname</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_FILENAME&#x27;</span>]).<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;APP_DEBUG&#x27;</span>) <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;APP_DEBUG&#x27;</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;CONFIG_PATH&#x27;</span>) <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;CONFIG_PATH&#x27;</span>, APP_PATH.<span class="string">&#x27;config/&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;RUNTIME_PATH&#x27;</span>) <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;RUNTIME_PATH&#x27;</span>, APP_PATH.<span class="string">&#x27;runtime/&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> APP_PATH . <span class="string">&#x27;config/config.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> FRAME_PATH . <span class="string">&#x27;Core.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$framework</span> = <span class="keyword">new</span> <span class="title class_">Core</span>;</span><br><span class="line"><span class="variable">$framework</span>-&gt;<span class="title function_ invoke__">run</span>();</span><br></pre></td></tr></table></figure>

<p>同样，在这里进行预定义常量和包含文件的工作，并实例化核心文件，让网页程序得以运行。题外话：看了一些外国人写的教程，大部分都喜欢用<code>$framework-&gt;bootstrap()</code>, 而这个<code>bootstrap()</code>并非代表着前端框架Bootstrap（原谅我脑洞大，第一个想到的就是这个），而是一种命名习惯吧。<br>从上述代码可以看出，包含了两个文件，其中<code>config.php</code>是数据库配置文件，要把它存放在<code>config</code>文件夹内，其内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;DB_NAME&#x27;</span>, <span class="string">&#x27;test_db&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;DB_USER&#x27;</span>, <span class="string">&#x27;root&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;DB_PASSWORD&#x27;</span>, <span class="string">&#x27;1234&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;DB_HOST&#x27;</span>, <span class="string">&#x27;localhost&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>根据个人情况修改即可。<br>回到<code>framework</code>文件夹，建立<code>Core.php</code>，这是框架核心文件，内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Core</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">spl_autoload_register</span>(<span class="keyword">array</span>(<span class="variable">$this</span>, <span class="string">&#x27;loadClass&#x27;</span>));</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">setReporting</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">removeMagicQuotes</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">unregisterGlobals</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">route</span>();</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">route</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$controllerName</span> = <span class="string">&#x27;Index&#x27;</span>;</span><br><span class="line">        <span class="variable">$action</span> = <span class="string">&#x27;index&#x27;</span>;</span><br><span class="line">        <span class="variable">$param</span> = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable">$url</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>] : <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$url</span>) &#123;      </span><br><span class="line">                <span class="variable">$urlArray</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$url</span>);</span><br><span class="line">                <span class="variable">$urlArray</span> = <span class="title function_ invoke__">array_filter</span>(<span class="variable">$urlArray</span>);</span><br><span class="line">                <span class="variable">$controllerName</span> = <span class="title function_ invoke__">ucfirst</span>(<span class="variable">$urlArray</span>[<span class="number">0</span>]);</span><br><span class="line">                <span class="title function_ invoke__">array_shift</span>(<span class="variable">$urlArray</span>);</span><br><span class="line">                <span class="variable">$action</span> = <span class="variable">$urlArray</span> ? <span class="variable">$urlArray</span>[<span class="number">0</span>] : <span class="string">&#x27;index&#x27;</span>;</span><br><span class="line">                <span class="title function_ invoke__">array_shift</span>(<span class="variable">$urlArray</span>);</span><br><span class="line">                <span class="variable">$param</span> = <span class="variable">$urlArray</span> ? <span class="variable">$urlArray</span> : <span class="keyword">array</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$controller</span> = <span class="variable">$controllerName</span> . <span class="string">&#x27;Controller&#x27;</span>;</span><br><span class="line">        <span class="variable">$dispatch</span> = <span class="keyword">new</span> <span class="variable">$controller</span>(<span class="variable">$controllerName</span>, <span class="variable">$action</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">int</span>)<span class="title function_ invoke__">method_exists</span>(<span class="variable">$controller</span>, <span class="variable">$action</span>)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">call_user_func_array</span>(<span class="keyword">array</span>(<span class="variable">$dispatch</span>, <span class="variable">$action</span>), <span class="variable">$param</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="variable">$controller</span> . <span class="string">&quot;控制器不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setReporting</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (APP_DEBUG === <span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">error_reporting</span>(E_ALL);</span><br><span class="line">            <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_errors&#x27;</span>,<span class="string">&#x27;On&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">error_reporting</span>(E_ALL);</span><br><span class="line">            <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_errors&#x27;</span>,<span class="string">&#x27;Off&#x27;</span>);</span><br><span class="line">            <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;log_errors&#x27;</span>, <span class="string">&#x27;On&#x27;</span>);</span><br><span class="line">            <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;error_log&#x27;</span>, RUNTIME_PATH. <span class="string">&#x27;logs/error.log&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stripSlashesDeep</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$value</span> = <span class="title function_ invoke__">is_array</span>(<span class="variable">$value</span>) ? <span class="title function_ invoke__">array_map</span>(<span class="keyword">array</span>(<span class="variable">$this</span>, <span class="string">&#x27;stripSlashesDeep&#x27;</span>), <span class="variable">$value</span>) : <span class="title function_ invoke__">stripslashes</span>(<span class="variable">$value</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">removeMagicQuotes</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">get_magic_quotes_gpc</span>()) &#123;</span><br><span class="line">            <span class="variable">$_GET</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>) ? <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">stripSlashesDeep</span>(<span class="variable">$_GET</span> ) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="variable">$_POST</span> = <span class="keyword">isset</span>(<span class="variable">$_POST</span>) ? <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">stripSlashesDeep</span>(<span class="variable">$_POST</span> ) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="variable">$_COOKIE</span> = <span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>) ? <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">stripSlashesDeep</span>(<span class="variable">$_COOKIE</span>) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="variable">$_SESSION</span> = <span class="keyword">isset</span>(<span class="variable">$_SESSION</span>) ? <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">stripSlashesDeep</span>(<span class="variable">$_SESSION</span>) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unregisterGlobals</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">ini_get</span>(<span class="string">&#x27;register_globals&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$array</span> = <span class="keyword">array</span>(<span class="string">&#x27;_SESSION&#x27;</span>, <span class="string">&#x27;_POST&#x27;</span>, <span class="string">&#x27;_GET&#x27;</span>, <span class="string">&#x27;_COOKIE&#x27;</span>, <span class="string">&#x27;_REQUEST&#x27;</span>, <span class="string">&#x27;_SERVER&#x27;</span>, <span class="string">&#x27;_ENV&#x27;</span>, <span class="string">&#x27;_FILES&#x27;</span>);</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$array</span> <span class="keyword">as</span> <span class="variable">$value</span>) &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$GLOBALS</span>[<span class="variable">$value</span>] <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$var</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable">$var</span> === <span class="variable">$GLOBALS</span>[<span class="variable">$key</span>]) &#123;</span><br><span class="line">                        <span class="keyword">unset</span>(<span class="variable">$GLOBALS</span>[<span class="variable">$key</span>]);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">loadClass</span>(<span class="params"><span class="variable">$class</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$frameworks</span> = FRAME_PATH . <span class="variable">$class</span> . <span class="string">&#x27;.class.php&#x27;</span>;</span><br><span class="line">        <span class="variable">$controllers</span> = APP_PATH . <span class="string">&#x27;application/controllers/&#x27;</span> . <span class="variable">$class</span> . <span class="string">&#x27;.class.php&#x27;</span>;</span><br><span class="line">        <span class="variable">$models</span> = APP_PATH . <span class="string">&#x27;application/models/&#x27;</span> . <span class="variable">$class</span> . <span class="string">&#x27;.class.php&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$frameworks</span>)) &#123;</span><br><span class="line">            <span class="keyword">include</span> <span class="variable">$frameworks</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$controllers</span>)) &#123;</span><br><span class="line">            <span class="keyword">include</span> <span class="variable">$controllers</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$models</span>)) &#123;</span><br><span class="line">            <span class="keyword">include</span> <span class="variable">$models</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;控制器类或模型类不存在！&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从<code>run()</code>中可以理解这一核心文件的运行机制，首先<code>spl_autoload_register()</code>用于自动加载类文件，在以后的类实例化中，可以方便的直接调用，而不是一个一个的require;接下来<code>setReporting()</code>用来开启调试模式，并记录到日志中;<code>removeMagicQuotes()</code>用于移除敏感字符;<code>unregisterGlobals()</code>用于检测并移除系统全局变量，避免如<code>_GET</code>不到变量的问题。准备工作完成后，<code>route()</code>方法截取URL，将形如：<br><code>localhost/?url=controller/action/parameters</code><br>的URL分离为<code>controller</code>,<code>action</code>和<code>parameters</code>，其中<code>controller</code>即<code>application</code>文件夹下用户自定义的控制器类文件，<code>action</code>为相应类文件内的方法，<code>parameters</code>为传入方法内的变量。实例化控制器后，并调用view方法。<br>这里的URL有点古怪，因为使用是<code>GET</code>方法获取的。如果想去掉<code>?url</code>也未尝不可，使用<code>$_SERVER[&#39;PATH_INFO&#39;]</code>可获取<code>index.php</code>后的内容，以<code>/</code>分离可获取控制器和方法；而<code>？</code>后的内容可以使用<code>$_SERVER[&#39;QUERY_STRING&#39;]</code>获取。<code>PATHINFO</code>的URL模式对搜索引擎更加友好。</p>
<h4 id="MVC基类"><a href="#MVC基类" class="headerlink" title="MVC基类"></a>MVC基类</h4><p>接下来，在核心文件夹内创建<code>Controller.class.php</code>,<code>Model.class.php</code>和<code>View.class.php</code>三个基类文件，用户创建的子类文件需要继承基类文件，所以可以把一些常用的方法写入到这个文件内，日后使用时直接调用即可。同时，因为这些基类文件负责着整体的MVC流程，所以其中要包含一些总体调度方法。<br><code>Controller.class.php</code>内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_controller</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_action</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_view</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$controller</span>, <span class="variable">$action</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_controller = <span class="variable">$controller</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_action = <span class="variable">$action</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_view = <span class="keyword">new</span> <span class="title class_">View</span>(<span class="variable">$controller</span>, <span class="variable">$action</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">assign</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_view-&gt;<span class="title function_ invoke__">assign</span>(<span class="variable">$name</span>, <span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_view-&gt;<span class="title function_ invoke__">render</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从代码内容可知，控制器基类用于分配变量和传递变量给视图，所以在控制器子类中，可以直接使用<code>$this-&gt;render()</code> 进行渲染。<br><code>Model.class.php</code>内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Model</span> <span class="keyword">extends</span> <span class="title">Sql</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$_model</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$_table</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">connect</span>(DB_HOST, DB_USER, DB_PASSWORD, DB_NAME);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;_model = <span class="title function_ invoke__">get_class</span>(<span class="variable">$this</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;_model = <span class="title function_ invoke__">substr</span>(<span class="variable">$this</span>-&gt;_model, <span class="number">0</span>, -<span class="number">5</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;_table = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$this</span>-&gt;_model);</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>此类继承自数据库基类<code>Sql.class.php</code>,其内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sql</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_dbHandle</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_result</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"><span class="variable">$host</span>, <span class="variable">$user</span>, <span class="variable">$pass</span>, <span class="variable">$dbname</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable">$dsn</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;mysql:host=%s;dbname=%s;charset=utf8&quot;</span>, <span class="variable">$host</span>, <span class="variable">$dbname</span>);</span><br><span class="line">            <span class="variable">$option</span> = <span class="keyword">array</span>(PDO::<span class="variable constant_">ATTR_DEFAULT_FETCH_MODE</span> =&gt; PDO::<span class="variable constant_">FETCH_ASSOC</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;_dbHandle = <span class="keyword">new</span> <span class="title function_ invoke__">PDO</span>(<span class="variable">$dsn</span>, <span class="variable">$user</span>, <span class="variable">$pass</span>, <span class="variable">$option</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PDOException <span class="variable">$e</span>) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">&#x27;错误: &#x27;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"><span class="variable">$id</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$sql</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;select * from `%s` where `id` = &#x27;%s&#x27;&quot;</span>, <span class="variable">$this</span>-&gt;_table, <span class="variable">$id</span>);</span><br><span class="line">        <span class="variable">$sth</span> = <span class="variable language_">$this</span>-&gt;_dbHandle-&gt;<span class="title function_ invoke__">prepare</span>(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="variable">$sth</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$sth</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">    &#125;     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里只封装了普通查询的方法，可以以这个方法为模板编写其他的CURD方法。再以后的使用过程中，就可以直接使用封装后的方法操作数据库<br><code>View.class.php</code>内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">View</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$variables</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_controller</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_action</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$controller</span>, <span class="variable">$action</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_controller = <span class="variable">$controller</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_action = <span class="variable">$action</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">assign</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;variables[<span class="variable">$name</span>] = <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">extract</span>(<span class="variable">$this</span>-&gt;variables);</span><br><span class="line">        <span class="comment">//加载自定义模板</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，框架的核心部分就完成了。测试框架时，像使用其他框架一样，在<code>application</code>文件夹内的子文件夹分别建立用户类文件，并继承基类文件，写入测试方法和语句即可。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>当我翻阅了很多编写入门级MVC框架教程之后，发现很多代码内容都是一样的。比如截取URL和自动加载类的方法。查看这些源码很容易理解其原理和过程。由于目前能力有限，我还不能倒背如流般的coding出这些代码，只得借鉴大神的代码，让自己学习和巩固。在开发过程中，也可以使用其他人造好的轮子，利用<code>Composer</code>下载到项目文件夹内，然后根据命名空间规则引用，就可以使用了。这样便极大的加快了项目的开发速度。但是我不喜欢黑箱操作，单纯的调用API反而更容易让人摸不着北。创造，才是一件令人开心的事。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/02/07/SCRAPY%E7%88%AC%E5%8F%96%E6%99%BA%E8%81%94%E6%8B%9B%E8%81%98%E4%BF%A1%E6%81%AF/" class="prev">上一篇</a><a href="/2016/12/26/Leetcode.Database-%E9%A2%98%E8%A7%A3%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%8B%EF%BC%89/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2024 <a href="https://catinsides.github.io">catinsides</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>