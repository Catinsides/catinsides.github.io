<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>catinsides.github.io</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/css/highlight.css">

  
  <meta property="og:type" content="website">
<meta property="og:title" content="catinsides.github.io">
<meta property="og:url" content="https://catinsides.github.io/page/2/index.html">
<meta property="og:site_name" content="catinsides.github.io">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="catinsides">
<meta name="twitter:card" content="summary"><meta name="generator" content="Hexo 7.1.1"></head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1 id="title">
    <a href="/">catinsides.github.io</a>
  </h1>
  <nav>
    
    
      
      <a class="nav-link" href="/">Home</a>
    
      
        <span class="nav-spacer">×</span>
      
      <a class="nav-link" href="/archives">Archives</a>
    
      
        <span class="nav-spacer">×</span>
      
      <a class="nav-link" target="_blank" rel="noopener" href="https://github.com/Catinsides">Github</a>
    
    
  </nav>
</header>

    <div id="content">
      
  
    <article id="post-如何编写自己的MVC框架" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2017/01/26/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E8%87%AA%E5%B7%B1%E7%9A%84MVC%E6%A1%86%E6%9E%B6/">如何编写自己的MVC框架</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2017-01-26T06:22:56.000Z" itemprop="datePublished">一月 26, 2017, 2:22 下午</time>

          
            × <span class="article-word-count">2.5k words</span>
            
            × <span class="article-time-to-read">11 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>MVC是一种软件设计模式。顾名思义，这些字母分别代表着模型（Model）、视图（View）和控制器（Controller）。PHP中的MVC旨在分离业务与逻辑层，使得开发过程中的结构清晰，大大提高了效率。当下有很多流行的PHP框架均使用了MVC模式。如果是新手入门，查看这些框架的源代码肯定会一头雾水，毫无思路。上手新框架等于重新开始学习，这必然会消耗不必要的精力和时间。而学习MVC框架最好的方式就是自己动手写一个框架，既学习了设计模式，又巩固了编程能力，何乐而不为。更重要的是，在开发过程中能够将自己的想法融入到框架中去，从而实现各种功能。</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>这篇文章是我<a target="_blank" rel="noopener" href="https://www.google.com.hk/#newwindow=1&safe=active&q=code+your+own+php+mvc+framework">Google</a>学习很多文章后的总结。将各路大神的代码汇总，然后择取出MVC必要的元素，根据个人需要编写出的小型框架，而非使用Composer组装出的框架。这个框架包含以下特点：</p>
<ul>
<li>MVC结构</li>
<li>单一入口</li>
<li>自动加载类</li>
<li>数据库封装</li>
</ul>
<p>根据这个思路，开始coding.</p>
<h3 id="MVC流程"><a href="#MVC流程" class="headerlink" title="MVC流程"></a>MVC流程</h3><p>日常上网过程中可以简化理解为人与服务器中数据库交互的过程。<br>每一次网页上的请求发送到服务器，服务端将请求通过控制器处理后，再传送到模型。<br>模型内包含业务逻辑，负责处理如何与数据库交换数据，数据处理完成后，发送到视图。<br>视图将传来的数据渲染后，最终返还用户。这样便完成了一次请求。<br>熟悉MVC流程后，就有了框架的宏观印象，方便理清结构。</p>
<h3 id="编写框架"><a href="#编写框架" class="headerlink" title="编写框架"></a>编写框架</h3><h4 id="建立目录"><a href="#建立目录" class="headerlink" title="建立目录"></a>建立目录</h4><p>首先，在项目目录下建立如下文件和文件夹:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">|--application</span><br><span class="line">|    |--controllers</span><br><span class="line">|    |--models</span><br><span class="line">|    |--views</span><br><span class="line">|--config</span><br><span class="line">|--framework</span><br><span class="line">|--.htaccess</span><br><span class="line">|--index.php</span><br></pre></td></tr></table></figure>

<p><code>application</code> 内放置用户编写的MVC文件；<br><code>config</code> 内放置数据库设置文件；<br><code>framework</code> 内放置框架的核心文件；<br><code>.htaccess</code> 为重定向文件；<br><code>index.php</code> 为入口文件。</p>
<h4 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h4><p><code>.htaccess</code>是服务器的配置文件，它用来将所有的请求转到入口文件处理。这样一来，网页程序便有了单一入口，掌控用户请求，避免熊孩子的无理取闹（笑。还可以生成对搜索引擎友好的URL。配置内容如下：<br>Apache服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RewriteEngine on</span><br><span class="line"> RewriteCond %&#123;REQUEST_FILENAME&#125; !-f</span><br><span class="line"> RewriteCond %&#123;REQUEST_FILENAME&#125; !-d</span><br><span class="line"> RewriteRule ^(.+)$ index.php/$1 [L]</span><br></pre></td></tr></table></figure>
<p>nginx服务器：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    if(!-<span class="attribute">e</span> <span class="variable">$request_filename</span>)&#123;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^(.+)$</span> /index.php/<span class="variable">$1</span> <span class="literal">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="入口文件"><a href="#入口文件" class="headerlink" title="入口文件"></a>入口文件</h4><p>打开同目录下的index.php文件，输入以下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;./framework/framework.php&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>内容很简单，就是包含核心文件夹内的入口文件。其实在这里可以定义一些预定义常量方便调用，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;APP_PATH&#x27;</span>, <span class="keyword">__DIR__</span>.<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;APP_DEBUG&#x27;</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;APP_URL&#x27;</span>, <span class="string">&#x27;http://localhost&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="核心文件"><a href="#核心文件" class="headerlink" title="核心文件"></a>核心文件</h4><p>外入口文件(index.php)将请求传递给核心文件的内入口文件(framework.php)后，接下来的工作由核心文件完成。framework.php的内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;FRAME_PATH&#x27;</span>) <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;FRAME_PATH&#x27;</span>, <span class="keyword">__DIR__</span>.<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;APP_PATH&#x27;</span>) <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;APP_PATH&#x27;</span>, <span class="title function_ invoke__">dirname</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_FILENAME&#x27;</span>]).<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;APP_DEBUG&#x27;</span>) <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;APP_DEBUG&#x27;</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;CONFIG_PATH&#x27;</span>) <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;CONFIG_PATH&#x27;</span>, APP_PATH.<span class="string">&#x27;config/&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;RUNTIME_PATH&#x27;</span>) <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;RUNTIME_PATH&#x27;</span>, APP_PATH.<span class="string">&#x27;runtime/&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> APP_PATH . <span class="string">&#x27;config/config.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> FRAME_PATH . <span class="string">&#x27;Core.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$framework</span> = <span class="keyword">new</span> <span class="title class_">Core</span>;</span><br><span class="line"><span class="variable">$framework</span>-&gt;<span class="title function_ invoke__">run</span>();</span><br></pre></td></tr></table></figure>

<p>同样，在这里进行预定义常量和包含文件的工作，并实例化核心文件，让网页程序得以运行。题外话：看了一些外国人写的教程，大部分都喜欢用<code>$framework-&gt;bootstrap()</code>, 而这个<code>bootstrap()</code>并非代表着前端框架Bootstrap（原谅我脑洞大，第一个想到的就是这个），而是一种命名习惯吧。<br>从上述代码可以看出，包含了两个文件，其中<code>config.php</code>是数据库配置文件，要把它存放在<code>config</code>文件夹内，其内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;DB_NAME&#x27;</span>, <span class="string">&#x27;test_db&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;DB_USER&#x27;</span>, <span class="string">&#x27;root&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;DB_PASSWORD&#x27;</span>, <span class="string">&#x27;1234&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;DB_HOST&#x27;</span>, <span class="string">&#x27;localhost&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>根据个人情况修改即可。<br>回到<code>framework</code>文件夹，建立<code>Core.php</code>，这是框架核心文件，内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Core</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">spl_autoload_register</span>(<span class="keyword">array</span>(<span class="variable">$this</span>, <span class="string">&#x27;loadClass&#x27;</span>));</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">setReporting</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">removeMagicQuotes</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">unregisterGlobals</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">route</span>();</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">route</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$controllerName</span> = <span class="string">&#x27;Index&#x27;</span>;</span><br><span class="line">        <span class="variable">$action</span> = <span class="string">&#x27;index&#x27;</span>;</span><br><span class="line">        <span class="variable">$param</span> = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable">$url</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>] : <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$url</span>) &#123;      </span><br><span class="line">                <span class="variable">$urlArray</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$url</span>);</span><br><span class="line">                <span class="variable">$urlArray</span> = <span class="title function_ invoke__">array_filter</span>(<span class="variable">$urlArray</span>);</span><br><span class="line">                <span class="variable">$controllerName</span> = <span class="title function_ invoke__">ucfirst</span>(<span class="variable">$urlArray</span>[<span class="number">0</span>]);</span><br><span class="line">                <span class="title function_ invoke__">array_shift</span>(<span class="variable">$urlArray</span>);</span><br><span class="line">                <span class="variable">$action</span> = <span class="variable">$urlArray</span> ? <span class="variable">$urlArray</span>[<span class="number">0</span>] : <span class="string">&#x27;index&#x27;</span>;</span><br><span class="line">                <span class="title function_ invoke__">array_shift</span>(<span class="variable">$urlArray</span>);</span><br><span class="line">                <span class="variable">$param</span> = <span class="variable">$urlArray</span> ? <span class="variable">$urlArray</span> : <span class="keyword">array</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$controller</span> = <span class="variable">$controllerName</span> . <span class="string">&#x27;Controller&#x27;</span>;</span><br><span class="line">        <span class="variable">$dispatch</span> = <span class="keyword">new</span> <span class="variable">$controller</span>(<span class="variable">$controllerName</span>, <span class="variable">$action</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">int</span>)<span class="title function_ invoke__">method_exists</span>(<span class="variable">$controller</span>, <span class="variable">$action</span>)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">call_user_func_array</span>(<span class="keyword">array</span>(<span class="variable">$dispatch</span>, <span class="variable">$action</span>), <span class="variable">$param</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="variable">$controller</span> . <span class="string">&quot;控制器不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setReporting</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (APP_DEBUG === <span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">error_reporting</span>(E_ALL);</span><br><span class="line">            <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_errors&#x27;</span>,<span class="string">&#x27;On&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">error_reporting</span>(E_ALL);</span><br><span class="line">            <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_errors&#x27;</span>,<span class="string">&#x27;Off&#x27;</span>);</span><br><span class="line">            <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;log_errors&#x27;</span>, <span class="string">&#x27;On&#x27;</span>);</span><br><span class="line">            <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;error_log&#x27;</span>, RUNTIME_PATH. <span class="string">&#x27;logs/error.log&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stripSlashesDeep</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$value</span> = <span class="title function_ invoke__">is_array</span>(<span class="variable">$value</span>) ? <span class="title function_ invoke__">array_map</span>(<span class="keyword">array</span>(<span class="variable">$this</span>, <span class="string">&#x27;stripSlashesDeep&#x27;</span>), <span class="variable">$value</span>) : <span class="title function_ invoke__">stripslashes</span>(<span class="variable">$value</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">removeMagicQuotes</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">get_magic_quotes_gpc</span>()) &#123;</span><br><span class="line">            <span class="variable">$_GET</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>) ? <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">stripSlashesDeep</span>(<span class="variable">$_GET</span> ) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="variable">$_POST</span> = <span class="keyword">isset</span>(<span class="variable">$_POST</span>) ? <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">stripSlashesDeep</span>(<span class="variable">$_POST</span> ) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="variable">$_COOKIE</span> = <span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>) ? <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">stripSlashesDeep</span>(<span class="variable">$_COOKIE</span>) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="variable">$_SESSION</span> = <span class="keyword">isset</span>(<span class="variable">$_SESSION</span>) ? <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">stripSlashesDeep</span>(<span class="variable">$_SESSION</span>) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unregisterGlobals</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">ini_get</span>(<span class="string">&#x27;register_globals&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$array</span> = <span class="keyword">array</span>(<span class="string">&#x27;_SESSION&#x27;</span>, <span class="string">&#x27;_POST&#x27;</span>, <span class="string">&#x27;_GET&#x27;</span>, <span class="string">&#x27;_COOKIE&#x27;</span>, <span class="string">&#x27;_REQUEST&#x27;</span>, <span class="string">&#x27;_SERVER&#x27;</span>, <span class="string">&#x27;_ENV&#x27;</span>, <span class="string">&#x27;_FILES&#x27;</span>);</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$array</span> <span class="keyword">as</span> <span class="variable">$value</span>) &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$GLOBALS</span>[<span class="variable">$value</span>] <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$var</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable">$var</span> === <span class="variable">$GLOBALS</span>[<span class="variable">$key</span>]) &#123;</span><br><span class="line">                        <span class="keyword">unset</span>(<span class="variable">$GLOBALS</span>[<span class="variable">$key</span>]);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">loadClass</span>(<span class="params"><span class="variable">$class</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$frameworks</span> = FRAME_PATH . <span class="variable">$class</span> . <span class="string">&#x27;.class.php&#x27;</span>;</span><br><span class="line">        <span class="variable">$controllers</span> = APP_PATH . <span class="string">&#x27;application/controllers/&#x27;</span> . <span class="variable">$class</span> . <span class="string">&#x27;.class.php&#x27;</span>;</span><br><span class="line">        <span class="variable">$models</span> = APP_PATH . <span class="string">&#x27;application/models/&#x27;</span> . <span class="variable">$class</span> . <span class="string">&#x27;.class.php&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$frameworks</span>)) &#123;</span><br><span class="line">            <span class="keyword">include</span> <span class="variable">$frameworks</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$controllers</span>)) &#123;</span><br><span class="line">            <span class="keyword">include</span> <span class="variable">$controllers</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$models</span>)) &#123;</span><br><span class="line">            <span class="keyword">include</span> <span class="variable">$models</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;控制器类或模型类不存在！&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从<code>run()</code>中可以理解这一核心文件的运行机制，首先<code>spl_autoload_register()</code>用于自动加载类文件，在以后的类实例化中，可以方便的直接调用，而不是一个一个的require;接下来<code>setReporting()</code>用来开启调试模式，并记录到日志中;<code>removeMagicQuotes()</code>用于移除敏感字符;<code>unregisterGlobals()</code>用于检测并移除系统全局变量，避免如<code>_GET</code>不到变量的问题。准备工作完成后，<code>route()</code>方法截取URL，将形如：<br><code>localhost/?url=controller/action/parameters</code><br>的URL分离为<code>controller</code>,<code>action</code>和<code>parameters</code>，其中<code>controller</code>即<code>application</code>文件夹下用户自定义的控制器类文件，<code>action</code>为相应类文件内的方法，<code>parameters</code>为传入方法内的变量。实例化控制器后，并调用view方法。<br>这里的URL有点古怪，因为使用是<code>GET</code>方法获取的。如果想去掉<code>?url</code>也未尝不可，使用<code>$_SERVER[&#39;PATH_INFO&#39;]</code>可获取<code>index.php</code>后的内容，以<code>/</code>分离可获取控制器和方法；而<code>？</code>后的内容可以使用<code>$_SERVER[&#39;QUERY_STRING&#39;]</code>获取。<code>PATHINFO</code>的URL模式对搜索引擎更加友好。</p>
<h4 id="MVC基类"><a href="#MVC基类" class="headerlink" title="MVC基类"></a>MVC基类</h4><p>接下来，在核心文件夹内创建<code>Controller.class.php</code>,<code>Model.class.php</code>和<code>View.class.php</code>三个基类文件，用户创建的子类文件需要继承基类文件，所以可以把一些常用的方法写入到这个文件内，日后使用时直接调用即可。同时，因为这些基类文件负责着整体的MVC流程，所以其中要包含一些总体调度方法。<br><code>Controller.class.php</code>内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_controller</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_action</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_view</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$controller</span>, <span class="variable">$action</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_controller = <span class="variable">$controller</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_action = <span class="variable">$action</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_view = <span class="keyword">new</span> <span class="title class_">View</span>(<span class="variable">$controller</span>, <span class="variable">$action</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">assign</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_view-&gt;<span class="title function_ invoke__">assign</span>(<span class="variable">$name</span>, <span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_view-&gt;<span class="title function_ invoke__">render</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从代码内容可知，控制器基类用于分配变量和传递变量给视图，所以在控制器子类中，可以直接使用<code>$this-&gt;render()</code> 进行渲染。<br><code>Model.class.php</code>内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Model</span> <span class="keyword">extends</span> <span class="title">Sql</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$_model</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$_table</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">connect</span>(DB_HOST, DB_USER, DB_PASSWORD, DB_NAME);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;_model = <span class="title function_ invoke__">get_class</span>(<span class="variable">$this</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;_model = <span class="title function_ invoke__">substr</span>(<span class="variable">$this</span>-&gt;_model, <span class="number">0</span>, -<span class="number">5</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;_table = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$this</span>-&gt;_model);</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>此类继承自数据库基类<code>Sql.class.php</code>,其内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sql</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_dbHandle</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_result</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"><span class="variable">$host</span>, <span class="variable">$user</span>, <span class="variable">$pass</span>, <span class="variable">$dbname</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable">$dsn</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;mysql:host=%s;dbname=%s;charset=utf8&quot;</span>, <span class="variable">$host</span>, <span class="variable">$dbname</span>);</span><br><span class="line">            <span class="variable">$option</span> = <span class="keyword">array</span>(PDO::<span class="variable constant_">ATTR_DEFAULT_FETCH_MODE</span> =&gt; PDO::<span class="variable constant_">FETCH_ASSOC</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;_dbHandle = <span class="keyword">new</span> <span class="title function_ invoke__">PDO</span>(<span class="variable">$dsn</span>, <span class="variable">$user</span>, <span class="variable">$pass</span>, <span class="variable">$option</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PDOException <span class="variable">$e</span>) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">&#x27;错误: &#x27;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"><span class="variable">$id</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$sql</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;select * from `%s` where `id` = &#x27;%s&#x27;&quot;</span>, <span class="variable">$this</span>-&gt;_table, <span class="variable">$id</span>);</span><br><span class="line">        <span class="variable">$sth</span> = <span class="variable language_">$this</span>-&gt;_dbHandle-&gt;<span class="title function_ invoke__">prepare</span>(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="variable">$sth</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$sth</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">    &#125;     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里只封装了普通查询的方法，可以以这个方法为模板编写其他的CURD方法。再以后的使用过程中，就可以直接使用封装后的方法操作数据库<br><code>View.class.php</code>内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">View</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$variables</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_controller</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_action</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$controller</span>, <span class="variable">$action</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_controller = <span class="variable">$controller</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_action = <span class="variable">$action</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">assign</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;variables[<span class="variable">$name</span>] = <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">extract</span>(<span class="variable">$this</span>-&gt;variables);</span><br><span class="line">        <span class="comment">//加载自定义模板</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，框架的核心部分就完成了。测试框架时，像使用其他框架一样，在<code>application</code>文件夹内的子文件夹分别建立用户类文件，并继承基类文件，写入测试方法和语句即可。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>当我翻阅了很多编写入门级MVC框架教程之后，发现很多代码内容都是一样的。比如截取URL和自动加载类的方法。查看这些源码很容易理解其原理和过程。由于目前能力有限，我还不能倒背如流般的coding出这些代码，只得借鉴大神的代码，让自己学习和巩固。在开发过程中，也可以使用其他人造好的轮子，利用<code>Composer</code>下载到项目文件夹内，然后根据命名空间规则引用，就可以使用了。这样便极大的加快了项目的开发速度。但是我不喜欢黑箱操作，单纯的调用API反而更容易让人摸不着北。创造，才是一件令人开心的事。</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-Leetcode.Database-题解笔记（下）" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2016/12/26/Leetcode.Database-%E9%A2%98%E8%A7%A3%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%8B%EF%BC%89/">Leetcode.Database 题解笔记（下）</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2016-12-26T07:55:44.000Z" itemprop="datePublished">十二月 26, 2016, 3:55 下午</time>

          
            × <span class="article-word-count">1.1k words</span>
            
            × <span class="article-time-to-read">4 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <blockquote>
<p>Leetcode是一个在线编程网站，收录了算法，数据库等各种题目。同样有很多优秀的算法解法，能够有效的提高姿势水平。</p>
</blockquote>
<p>这篇文章承接上一篇，将Leetcode.Database中的后6道题的解法及笔记记录下来。</p>
<h3 id="183-Customers-Who-Never-Order"><a href="#183-Customers-Who-Never-Order" class="headerlink" title="183.Customers Who Never Order"></a>183.<a target="_blank" rel="noopener" href="https://leetcode.com/problems/customers-who-never-order/">Customers Who Never Order</a></h3><p>题目要求为查找出没有订单的客户。<br>解题思路为使用子查询和NOT IN.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Name <span class="keyword">AS</span> Customers </span><br><span class="line"><span class="keyword">FROM</span> Customers c </span><br><span class="line"><span class="keyword">WHERE</span> c.id </span><br><span class="line"><span class="keyword">NOT</span> <span class="keyword">IN</span> </span><br><span class="line">    (<span class="keyword">SELECT</span> CustomerId <span class="keyword">FROM</span> Orders);</span><br></pre></td></tr></table></figure>
<p>这里需要注意的是要在NAME后添加<code>AS Customers</code>.</p>
<h3 id="184-Department-Highest-Salary"><a href="#184-Department-Highest-Salary" class="headerlink" title="184.Department Highest Salary"></a>184.<a target="_blank" rel="noopener" href="https://leetcode.com/problems/department-highest-salary/">Department Highest Salary</a></h3><p>题目要求为联合员工表和部门表并从中查找出收入最高的员工。<br>解题思路为使用正确的子查询和过滤条件，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> d.Name <span class="keyword">AS</span> Department, e.Name <span class="keyword">AS</span> Employee, t.Salary </span><br><span class="line"><span class="keyword">FROM</span> Employee e </span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> </span><br><span class="line">    (<span class="keyword">SELECT</span> DepartmentId, <span class="built_in">MAX</span>(Salary) <span class="keyword">AS</span> Salary </span><br><span class="line">     <span class="keyword">FROM</span> Employee </span><br><span class="line">     <span class="keyword">GROUP</span> <span class="keyword">BY</span> DepartmentId) t</span><br><span class="line"><span class="keyword">USING</span> (DepartmentId, Salary)</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> Department d</span><br><span class="line"><span class="keyword">ON</span> d.id <span class="operator">=</span> t.DepartmentId</span><br></pre></td></tr></table></figure>
<p>这里最容易混淆的是SQL语句的执行顺序，简单做个笔记：<br>SQL语句执行时，每个步骤都会产生一个虚拟表用于下一步骤的输入，虚拟表对外不可用，只会将最终的查询结果返回。如果查询语句中没有某一个子句，则会跳过。<br>顺序结构如下，小括号内为执行次序：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">8</span>) <span class="keyword">SELECT</span> (<span class="number">9</span>)<span class="keyword">DISTINCT</span>  (<span class="number">11</span>)<span class="operator">&lt;</span>Top Num<span class="operator">&gt;</span> <span class="operator">&lt;</span><span class="keyword">select</span> list<span class="operator">&gt;</span></span><br><span class="line">(<span class="number">1</span>) <span class="keyword">FROM</span> [left_table]</span><br><span class="line">(<span class="number">3</span>) <span class="operator">&lt;</span>join_type<span class="operator">&gt;</span> <span class="keyword">JOIN</span> <span class="operator">&lt;</span>right_table<span class="operator">&gt;</span></span><br><span class="line">(<span class="number">2</span>) <span class="keyword">ON</span> <span class="operator">&lt;</span>join_condition<span class="operator">&gt;</span></span><br><span class="line">(<span class="number">4</span>) <span class="keyword">WHERE</span> <span class="operator">&lt;</span>where_condition<span class="operator">&gt;</span></span><br><span class="line">(<span class="number">5</span>) <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="operator">&lt;</span>group_by_list<span class="operator">&gt;</span></span><br><span class="line">(<span class="number">6</span>) <span class="keyword">WITH</span> <span class="operator">&lt;</span><span class="keyword">CUBE</span> <span class="operator">|</span> <span class="keyword">RollUP</span><span class="operator">&gt;</span></span><br><span class="line">(<span class="number">7</span>) <span class="keyword">HAVING</span> <span class="operator">&lt;</span>having_condition<span class="operator">&gt;</span></span><br><span class="line">(<span class="number">10</span>)<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="operator">&lt;</span>order_by_list<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="185-Department-Top-Three-Salaries"><a href="#185-Department-Top-Three-Salaries" class="headerlink" title="185.Department Top Three Salaries"></a>185.<a target="_blank" rel="noopener" href="https://leetcode.com/problems/department-top-three-salaries/">Department Top Three Salaries</a></h3><p>题目要求为查询每个部门前三名收入最高的员工。<br>解题思路，首先复制Employee表e1，原表为e，在同一部门内选一人与其他员工薪水进行比较，将大于此人的人员数量计数。如果数量为0，则此人为薪水最高者；数量为1，则为第二高者；以此类推……将数量小于3（前三名）的员工，再与部门表做INNER JOIN，最终得出结果。<br>查询语句如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> d.Name <span class="keyword">AS</span> Department, e.Name <span class="keyword">AS</span> Employee, e.Salary <span class="keyword">AS</span> Salary  </span><br><span class="line"><span class="keyword">FROM</span> Employee e </span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> Department d </span><br><span class="line"><span class="keyword">ON</span> e.DepartmentId <span class="operator">=</span> d.Id  </span><br><span class="line"><span class="keyword">WHERE</span> <span class="number">3</span> <span class="operator">&gt;</span> </span><br><span class="line">    (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> e1.Salary)  </span><br><span class="line">    <span class="keyword">FROM</span> Employee e1  </span><br><span class="line">    <span class="keyword">WHERE</span> e1.Salary <span class="operator">&gt;</span> e.Salary  </span><br><span class="line">    <span class="keyword">AND</span> e1.DepartmentId <span class="operator">=</span> e.DepartmentId</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<p>这道题查询方式很巧妙，需要注意的是将查询方法实践到语句中，同时注意SQL语句的执行顺序。</p>
<h3 id="186-Delete-Duplicate-Emails"><a href="#186-Delete-Duplicate-Emails" class="headerlink" title="186.Delete Duplicate Emails"></a>186.<a target="_blank" rel="noopener" href="https://leetcode.com/problems/delete-duplicate-emails/">Delete Duplicate Emails</a></h3><p>题目要求为删除重复的Email.<br>解题思路为复制临时表，取两者交集，删除掉Email相同Id不同的行（取大于小于皆可）。<br>查询语句如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> p1 </span><br><span class="line"><span class="keyword">FROM</span> Person p1 </span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> Person p2</span><br><span class="line"><span class="keyword">WHERE</span> p1.Email <span class="operator">=</span> p2.Email <span class="keyword">AND</span> p1.Id <span class="operator">&gt;</span> p2.Id;</span><br></pre></td></tr></table></figure>

<h3 id="197-Rising-Temperature"><a href="#197-Rising-Temperature" class="headerlink" title="197.Rising Temperature"></a>197.<a target="_blank" rel="noopener" href="https://leetcode.com/problems/rising-temperature/">Rising Temperature</a></h3><p>题目要求为查询所有当天温度比前一天高的日期的Id.<br>解题思路，首先用MySQL内置函数TO_DAYS()将日期转为天数，再使用错位比较（同180）找出温度大于前一天的日期，最后取交集。<br>查询语句如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> w1.Id </span><br><span class="line"><span class="keyword">FROM</span> Weather w1 </span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> Weather w2</span><br><span class="line"><span class="keyword">ON</span> TO_DAYS(w1.Date) <span class="operator">=</span> TO_DAYS(w2.Date) <span class="operator">+</span> <span class="number">1</span> </span><br><span class="line"><span class="keyword">AND</span> w1.Temperature <span class="operator">&gt;</span> w2.Temperature;</span><br></pre></td></tr></table></figure>

<h3 id="262-Trips-and-Users"><a href="#262-Trips-and-Users" class="headerlink" title="262.Trips and Users"></a>262.<a target="_blank" rel="noopener" href="https://leetcode.com/problems/trips-and-users/">Trips and Users</a></h3><p>最后一道题，看起来就像压轴题……<br>题目要求为查询出Oct 1,2013至Oct 3,2013之间，非禁止用户的请求撤销率。<br>解题思路为根据要求链接两表，设置好过滤条件，再将结果计算后返回。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    t.Request_at <span class="keyword">AS</span> `<span class="keyword">Day</span>`, </span><br><span class="line">    ROUND(</span><br><span class="line">        <span class="built_in">SUM</span>(</span><br><span class="line">            IF(t.Status <span class="operator">=</span> <span class="string">&#x27;completed&#x27;</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">           ) <span class="operator">/</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>),  <span class="number">2</span>) </span><br><span class="line">        <span class="keyword">AS</span> `Cancellation Rate` </span><br><span class="line"><span class="keyword">FROM</span> Trips t </span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> Users u </span><br><span class="line"><span class="keyword">ON</span> t.Client_Id <span class="operator">=</span> u.Users_Id </span><br><span class="line"><span class="keyword">WHERE</span> t.Request_at </span><br><span class="line"><span class="keyword">BETWEEN</span> <span class="string">&#x27;2013-10-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2013-10-03&#x27;</span> </span><br><span class="line"><span class="keyword">AND</span> u.Banned <span class="operator">=</span> <span class="string">&#x27;No&#x27;</span> <span class="keyword">AND</span> u.Role <span class="operator">=</span> <span class="string">&#x27;client&#x27;</span> </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> t.Request_at </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> t.Request_at;</span><br></pre></td></tr></table></figure>
<p>通过之前的解题，理解这段查询语句的逻辑不难。这里仅把前面没提到过的内置函数做下笔记：</p>
<ul>
<li><code>ROUND()</code>为四舍五入函数，第二个参数为小数位保留的位数；</li>
<li><code>SUM()</code>顾名思义为求和函数；</li>
<li><code>IF()</code>,格式为IF(Condition,A,B)，当Condition为TRUE时，返回A；当Condition为FALSE时，返回B。</li>
</ul>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>至此，Leetcode所有Database题目完成（撒花）。总的来看，这些题目锻炼了使用SQL的基本功，同时提供了思考问题的新思路，这在以后的工作中都很有帮助。同时在每页的Discuss中，查看其它网友的解法，能够进一步提高姿势水平。将这些解题的思路整理成两篇文章，也是一个不小的收获。</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-Leetcode.Database-题解笔记（上）" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2016/12/26/Leetcode.Database-%E9%A2%98%E8%A7%A3%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%8A%EF%BC%89/">Leetcode.Database 题解笔记（上）</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2016-12-26T03:55:30.000Z" itemprop="datePublished">十二月 26, 2016, 11:55 中午</time>

          
            × <span class="article-word-count">878 words</span>
            
            × <span class="article-time-to-read">3 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <blockquote>
<p>Leetcode是一个在线编程网站，收录了算法，数据库等各种题目。同样有很多优秀的算法解法，能够有效的提高姿势水平。</p>
</blockquote>
<p>闲来无事在leetcode上刷了所有的database题目，一共13道题。题目内容不是简单的CRUD，而是可能很“常用”的查询问题。自我感觉，刷题的过程是一种查缺补漏的过程。除了能够学习新知识，还能够找到自己的不足。这里将每道题的解法及思路记录下来，方便以后查阅。<br>由于每道题的题目内容较多，仅写下解法与笔记，链接附在题目中。</p>
<h3 id="175-Combine-Two-Tables"><a href="#175-Combine-Two-Tables" class="headerlink" title="175.Combine Two Tables"></a>175.<a target="_blank" rel="noopener" href="https://leetcode.com/problems/combine-two-tables/">Combine Two Tables</a></h3><p>题目要求为取出Person表中每一个人的FirstName，LastName，City，State信息，无论是否存在地址信息。<br>解题思路很简单，使用LEFT JOIN即可：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Person.FirstName,Person.LastName,Address.City,Address.State</span><br><span class="line"><span class="keyword">FROM</span> Person <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> Address </span><br><span class="line"><span class="keyword">ON</span> Person.PersonId <span class="operator">=</span> Address.PersonId;</span><br></pre></td></tr></table></figure>
<p>这么写可能显得臃肿，可以简化一下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> p.FirstName,p.LastName,a.City,a.State</span><br><span class="line"><span class="keyword">FROM</span> Person p </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> Address a</span><br><span class="line"><span class="keyword">USING</span> (PersonId);</span><br></pre></td></tr></table></figure>
<p>JOIN USING 简化 JOIN ON 的条件是</p>
<ul>
<li>查询必须等连接；</li>
<li>等连接的列必须同名。</li>
</ul>
<h3 id="176-Second-Highest-Salary"><a href="#176-Second-Highest-Salary" class="headerlink" title="176.Second Highest Salary"></a>176.<a target="_blank" rel="noopener" href="https://leetcode.com/problems/second-highest-salary/">Second Highest Salary</a></h3><p>题目很好理解，查询Employee表中第二高的薪水值。<br>解题思路为使用MAX()函数：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">max</span>(Salary)</span><br><span class="line"><span class="keyword">FROM</span> Employee</span><br><span class="line"><span class="keyword">WHERE</span> Salary <span class="operator">&lt;</span> (<span class="keyword">SELECT</span> <span class="built_in">max</span>(Salary) <span class="keyword">FROM</span> Employee);</span><br></pre></td></tr></table></figure>
<p>提交完后，会报错，因为在第一行后面还要加上 <code>as SecondHighestSalary</code>，真是蛋疼的设定啊…</p>
<h3 id="177-Nth-Highest-Salary"><a href="#177-Nth-Highest-Salary" class="headerlink" title="177.Nth Highest Salary"></a>177.<a target="_blank" rel="noopener" href="https://leetcode.com/problems/nth-highest-salary/">Nth Highest Salary</a></h3><p>题目要求为取出表内第N高的薪水值，如果没有则返回null.<br>这里要编写的为自定义函数，方法如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> getNthHighestSalary(N <span class="type">INT</span>) <span class="keyword">RETURNS</span> <span class="type">INT</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> M <span class="type">INT</span>;</span><br><span class="line"><span class="keyword">SET</span> M <span class="operator">=</span> N<span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">RETURN</span> (</span><br><span class="line">      <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> Salary <span class="keyword">FROM</span> Employee <span class="keyword">ORDER</span> <span class="keyword">BY</span> Salary <span class="keyword">DESC</span> LIMIT M, <span class="number">1</span></span><br><span class="line">  );</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>
<p>简单记一下LIMIT的用法吧：</p>
<ul>
<li>LIMIT 5, 1 &#x2F;&#x2F;从第6行取出1个</li>
<li>LIMIT 5, -1 &#x2F;&#x2F;从第6行至last</li>
<li>LIMIT 5 &#x2F;&#x2F; 等价于LIMIT 0, 5 前五行</li>
</ul>
<h3 id="178-Rank-Scores"><a href="#178-Rank-Scores" class="headerlink" title="178.Rank Scores"></a>178.<a target="_blank" rel="noopener" href="https://leetcode.com/problems/rank-scores/">Rank Scores</a></h3><p>题目内容为按次序排名分数，分数相同的次序相同，分数之间的次序不能跳跃。<br>解题思路为新建临时表提取去重后的分数，再使用COUNT计数，再与原表中的分数进行笛卡尔积，最后再设置条件筛选：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> s.Score, <span class="built_in">COUNT</span>(r.Score) <span class="keyword">AS</span> Rank</span><br><span class="line"><span class="keyword">FROM</span> Scores s</span><br><span class="line">     , (</span><br><span class="line">       <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> Score</span><br><span class="line">         <span class="keyword">FROM</span> Scores</span><br><span class="line">       ) r</span><br><span class="line"><span class="keyword">WHERE</span> s.Score <span class="operator">&lt;=</span> r.Score</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> s.Id, s.Score</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> s.Score <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>
<p>其中，GOURP BY为分组计数。</p>
<h3 id="180-Consecutive-Numbers"><a href="#180-Consecutive-Numbers" class="headerlink" title="180.Consecutive Numbers"></a>180.<a target="_blank" rel="noopener" href="https://leetcode.com/problems/consecutive-numbers/">Consecutive Numbers</a></h3><p>题目内容为查询出至少出现3次的数字。<br>解题思路比较巧妙，使用JOIN和新建临时表匹配错位相等的值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> L1.Num <span class="keyword">AS</span> ConsecutiveNums</span><br><span class="line"><span class="keyword">FROM</span> Logs L1</span><br><span class="line"><span class="keyword">JOIN</span> Logs L2 <span class="keyword">ON</span> L1.Id <span class="operator">+</span> <span class="number">1</span> <span class="operator">=</span> L2.Id</span><br><span class="line"><span class="keyword">JOIN</span> Logs L3 <span class="keyword">ON</span> L1.Id <span class="operator">+</span> <span class="number">2</span> <span class="operator">=</span> L3.Id</span><br><span class="line"><span class="keyword">WHERE</span> L1.Num <span class="operator">=</span> L2.Num <span class="keyword">AND</span> L1.Num <span class="operator">=</span> L3.Num</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> L1.Num</span><br></pre></td></tr></table></figure>
<p>这道题考验思路与技巧，没有什么额外的内容。</p>
<h3 id="181-Employees-Earning-More-Than-Their-Managers"><a href="#181-Employees-Earning-More-Than-Their-Managers" class="headerlink" title="181.Employees Earning More Than Their Managers"></a>181.<a target="_blank" rel="noopener" href="https://leetcode.com/problems/employees-earning-more-than-their-managers/">Employees Earning More Than Their Managers</a></h3><p>题目内容为查找出比经理收入高的员工。<br>这道题属于Easy，没啥太大的难点，需要注意的是员工与经理在同一表内，通过Id关联，注意筛选条件即可。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.NAME <span class="keyword">AS</span> Employee </span><br><span class="line"><span class="keyword">FROM</span> Employee a, Employee b </span><br><span class="line"><span class="keyword">WHERE</span> a.ManagerId <span class="operator">=</span> b.Id <span class="keyword">AND</span> a.Salary <span class="operator">&gt;</span> b.Salary;</span><br></pre></td></tr></table></figure>

<h3 id="182-Duplicate-Emails"><a href="#182-Duplicate-Emails" class="headerlink" title="182.Duplicate Emails"></a>182.<a target="_blank" rel="noopener" href="https://leetcode.com/problems/duplicate-emails/">Duplicate Emails</a></h3><p>题目内容为查找表中重复的emails.<br>这道题也很简单，使用GROUP BY和HAVING 即可。它的作用是代替<code>WHERE</code>与合计函数一起使用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT Email FROM Person GROUP BY Email HAVING COUNT(*) &gt; 1;</span><br></pre></td></tr></table></figure>

<p>先把前7道题写到这里，后面6道题包含HARD难度，知识点比较多，单独开一篇吧。</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-SCRAPY-简单入门" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2016/12/19/SCRAPY-%E7%AE%80%E5%8D%95%E5%85%A5%E9%97%A8/">SCRAPY 简单入门</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2016-12-19T10:37:56.000Z" itemprop="datePublished">十二月 19, 2016, 6:37 晚上</time>

          
            × <span class="article-word-count">1.5k words</span>
            
            × <span class="article-time-to-read">6 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <blockquote>
<p>SCRAPY是由Python开发的，为爬取网站数据，提取结构性数据而编写的应用框架。可以应用在包括数据挖掘，信息处理或存储历史数据等一系列的程序中。</p>
</blockquote>
<p>下面通过一个小例子，爬取RS05网站的电影链接，熟悉该框架的基本功能。<br>闲话少叙，下面开始:)</p>
<h3 id="安装SCRAPY"><a href="#安装SCRAPY" class="headerlink" title="安装SCRAPY"></a>安装SCRAPY</h3><p>相信有一半的同学，学习SCRAPY从安装到放弃。<br>我也是折腾了好久，从baidu到google，再到stackoverflow，才完完整整的安装到了电脑上。高兴的我，又在树莓派Raspbian系统上安装了一遍。为了节省大家的时间，这里把Linux和Windows的安装方法都列举出来，方便以后查询。<br>Python版本为2.7</p>
<h4 id="Windows平台："><a href="#Windows平台：" class="headerlink" title="Windows平台："></a>Windows平台：</h4><p>首先到<a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/download/details.aspx?id=44266">这里</a>下载VC For Python27<br>然后按照下列顺序安装前置包</p>
<ul>
<li>zope.interface</li>
<li>pyopenssl</li>
<li>twisted</li>
<li>lxml</li>
<li>scrapy</li>
</ul>
<p>不能使用pip下载的，直接google安装包好了。</p>
<h4 id="Linux平台："><a href="#Linux平台：" class="headerlink" title="Linux平台："></a>Linux平台：</h4><p>准确的说应该是Raspbian平台，因为我用的树莓派是XD。相比win平台就简单多了，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libxml2-dev libxslt1-dev python-dev</span><br><span class="line">apt-get install python-lxml</span><br><span class="line"><span class="keyword">if</span> error:</span><br><span class="line">pip install pyasn1 --upgrade</span><br></pre></td></tr></table></figure>
<p>好的，大功告成！enjoy！</p>
<h3 id="选择网站"><a href="#选择网站" class="headerlink" title="选择网站"></a>选择网站</h3><p>我真是太懒了，懒到不想点开浏览器去找电影下载。为了节省十几秒找电影的时间，花去了几个小时研究爬虫框架自动爬取链接。想想还是挺值的！<br>这里我选择RS05为目标网站，提取每个电影页面的迅雷url并写入文件，然后直接复制到迅雷里就可以下载了，是不是很简单很开心？</p>
<h3 id="新建项目"><a href="#新建项目" class="headerlink" title="新建项目"></a>新建项目</h3><p>好的，终于要开始了。<br>CD到项目文件夹，执行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy startproject Rs05</span><br></pre></td></tr></table></figure>
<p>随后项目文件夹内变生成了一系列文件，其结构如下：</p>
<blockquote>
<p>Rs05&#x2F;<br>　　scrapy.cfg<br>　　Rs05&#x2F;<br>　　　　<code>__init__.py</code><br>　　　　items.py<br>　　　　piplines.py<br>　　　　settings.py<br>　　　　spiders&#x2F;<br>　　　　　　<code>__init__.py</code><br>　　　　　　…</p>
</blockquote>
<p>简单介绍一下各个文件：<br><code>scrapy.cfg</code> 是项目的配置文件；<br><code>__init__.py</code> 这个文件不用管；<br><code>items.py</code> 文件里编写爬取内容的Field；<br><code>piplines.py</code> 文件里编写爬取后过滤内容的规则或者其他操作，如写入文件；<br><code>settings.py</code> 是项目的设置文件；<br><code>spiders</code> 内放置爬虫文件</p>
<h3 id="设置规则"><a href="#设置规则" class="headerlink" title="设置规则"></a>设置规则</h3><p>首先，需要定义items，可以理解为放置爬取内容的地方，与字典类似。<br>编写方法非常简单，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rs05Item</span>(scrapy.Item):</span><br><span class="line">　　<span class="comment">#name = scrapy.Field()</span></span><br><span class="line">　　title = scrapy.Field()</span><br><span class="line">　　url = scrapy.Field()</span><br></pre></td></tr></table></figure>
<p>name根据你的需要随便起名字，数量由爬取种类的多少决定。<br>然后CD到spider文件，新建爬虫文件rs05_spider.py<br>打开文件编写</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> scrapy.contrib.spiders <span class="keyword">import</span> CrawlSpider, Rule</span><br><span class="line"><span class="keyword">from</span> scrapy.contrib.linkextractors <span class="keyword">import</span> LinkExtractor</span><br><span class="line"><span class="keyword">from</span> rs05.items <span class="keyword">import</span> Rs05Item</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rs05Spider</span>(<span class="title class_ inherited__">CrawlSpider</span>):</span><br><span class="line">　　name = <span class="string">&#x27;rs05&#x27;</span></span><br><span class="line">　　start_urls = [<span class="string">&#x27;http://www.rs05.com/&#x27;</span>]</span><br><span class="line">　　rules = (</span><br><span class="line">　　　　Rule(LinkExtractor(allow=(<span class="string">&#x27;[a-z0-9]+\.html&#x27;</span>)),callback=<span class="string">&#x27;parse_item&#x27;</span>),</span><br><span class="line">　　)</span><br><span class="line">　　<span class="keyword">def</span> <span class="title function_">parse_item</span>(<span class="params">self,response</span>):			</span><br><span class="line">　　　　items = []</span><br><span class="line">　　　　item = Rs05Item()</span><br><span class="line">　　　　<span class="keyword">for</span> sel <span class="keyword">in</span> response.xpath(<span class="string">&#x27;/html/body/div[4]/div[1]/div[1]&#x27;</span>):</span><br><span class="line">　　　　　　title = sel.xpath(<span class="string">&#x27;h1/text()&#x27;</span>).extract()</span><br><span class="line">　　　　　　item[<span class="string">&#x27;title&#x27;</span>] = title <span class="comment">#t.encode(&#x27;utf-8&#x27;) for t in title</span></span><br><span class="line">　　　　　　pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;href=&quot;(.*?)&quot;&#x27;</span>,re.S)			</span><br><span class="line">　　　　　　url = re.findall(pattern, sel.extract())			</span><br><span class="line">　　　　　　item[<span class="string">&#x27;url&#x27;</span>] = url</span><br><span class="line">　　　　　　items.append(item)</span><br><span class="line">　　　　<span class="keyword">return</span> items</span><br></pre></td></tr></table></figure>
<p>根据代码可以看出，爬虫使用了scrapy内置的CrawlSpider，用于跟进链接继续爬取。而linkextractors用于设置跟进链接的规则，使用正则匹配。<code>name</code>为爬虫的名称，该名称唯一。<code>start_urls</code>为开始爬取的链接。需要注意的是，当要设置<code>allowed_domains</code>时，<code>start_urls</code>与<code>allowed_domains</code>不能相同，否则会出现错误。<code>parse_item</code>函数用于解析response的内容，并将结果保存到items中。上述代码使用xpath与re提取内容，当然也可以使用其他方法，比如beautifulsoup。无论用什么方法，最终将需要提取的内容放到items中即可。</p>
<h3 id="写入文件"><a href="#写入文件" class="headerlink" title="写入文件"></a>写入文件</h3><p>爬取内容后，如何输出呢？<br>此时打开pipelines.py，输入以下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rs05Pipeline</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">　　<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">　　　　self.file = codecs.<span class="built_in">open</span>(<span class="string">&#x27;rs05.json&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">　　<span class="keyword">def</span> <span class="title function_">process_item</span>(<span class="params">self, item, spider</span>):</span><br><span class="line">　　　　line = json.dumps(OrderedDict(item)) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">　　　　self.file.write(line.decode(<span class="string">&quot;unicode_escape&quot;</span>))</span><br><span class="line">　　　　<span class="keyword">return</span> item</span><br><span class="line">　　<span class="keyword">def</span> <span class="title function_">close_spider</span>(<span class="params">self, spider</span>):</span><br><span class="line">　　　　self.file.close()</span><br></pre></td></tr></table></figure>
<p>其中,<code>__init__()</code>和<code>close_spider()</code>相当于构造、析构函数，写不写都可以。但是process_item是一定要写的。这里用于处理爬取内容，丢弃或者保存。从上面的代码可以看出，爬取内容保存到了rs05.json文件中。<br>还没有完事，打开settings.py找到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">    <span class="string">&#x27;rs06.pipelines.Rs06Pipeline&#x27;</span>: <span class="number">300</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>取消注释，并将名字改为爬虫的名字，后面的数字为优先级，如果你有多个pipelines，可以为它们设定执行顺序。</p>
<h3 id="开始爬取"><a href="#开始爬取" class="headerlink" title="开始爬取"></a>开始爬取</h3><p>好了，一切都设置好之后，CD到项目根目录可以开始爬取了。<br>执行下列命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl Rs05</span><br></pre></td></tr></table></figure>
<p>一大串字母和数字闪过之后，在根目录生成了rs05.json, 打开文件看看是否提取到了想要的内容。我相信多数情况下，都没有一次成功的时候吧……<br>下面介绍两种调试的方法：</p>
<ul>
<li>1.检查spider文件的过滤规则，是否提取到内容。如果使用xpath，可以通过xpath插件，或者chrome shift + i 查看xpath路径；</li>
<li>2.输入命令 <code>scrapy shell &quot;http://xxx&quot;</code> 然后输入 <code>response.selector.xpath(&#39;your rules&#39;)</code>查看内容，验证xpath路径是否正确。</li>
</ul>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>SCRAPY框架适用于中型大型爬虫项目，使我们专注于内容的提取，而不是爬虫的构建。小型项目可以使用urllib,repuests库等等。<br>简单来讲，网络爬虫就是获取网页内容后提取有价值信息的一个技术。我们设置好过滤内容规则后，让电脑自动提取，大大加强了我们提取信息的效率。当然，这一过程中，也会遇到一些困难，如网页改版，封禁IP等等。此时就需要将爬虫升级为机器学习或者分布式爬虫，这里需要更多更深的知识。</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-CodeIgniter-简单入门" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2016/11/26/CodeIgniter-%E7%AE%80%E5%8D%95%E5%85%A5%E9%97%A8/">CodeIgniter 简单入门</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2016-11-26T09:42:56.000Z" itemprop="datePublished">十一月 26, 2016, 5:42 下午</time>

          
            × <span class="article-word-count">1.4k words</span>
            
            × <span class="article-time-to-read">5 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <blockquote>
<p>CodeIgniter 是一套给 PHP 网站开发者使用的应用程序开发框架和工具包。 它的目标是让你能够更快速的开发，它提供了日常任务中所需的大量类库， 以及简单的接口和逻辑结构。通过减少代码量，CodeIgniter 让你更加专注于你的创造性工作。</p>
</blockquote>
<p>本文介绍该框架（简称CI）的基本功能，方便自己查阅和回顾。<br>闲话少叙，下面开始:)</p>
<h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>测试环境建议使用wamp或lamp，下载后安装即可。<br>从CI官网下载压缩包，解压到wamp(lamp)目录下的www文件夹内，<br>在浏览器地址栏输入 <a target="_blank" rel="noopener" href="http://localhost/">http://localhost</a> ，即可看到欢迎界面。</p>
<h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><p>路由配置文件routes.php在框架根目录下application&#x2F;config文件夹内，打开后看到一堆注释和保留语句。注释部分算是一部分教程，方便理解框架内容。<br>保留语句是路由名称数组，左面是匹配规则，右面是对应的控制器类。<br>仅保留这一条规则，其他规则注释掉。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$route</span>[<span class="string">&#x27;default_controller&#x27;</span>] = <span class="string">&#x27;welcome&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>这行代码的含义是，当打开 <a target="_blank" rel="noopener" href="http://localhost/">http://localhost</a> 时，默认使用Welcome控制器。<br>噫，这里怎么只有控制器名没有方法名呢？<br>这时打开application&#x2F;controller下的Welcome.php，会发现里面有一个index()方法，通过上面的注释可以了解到，访问<br><a target="_blank" rel="noopener" href="http://localhost/index.php/welcome">http://localhost/index.php/welcome</a><br>或<br><a target="_blank" rel="noopener" href="http://localhost/index.php/welcome/index">http://localhost/index.php/welcome/index</a><br>都会匹配到index()方法。<br>即当url中没有指明方法名称时，CI会自动寻找当前控制器类下的index()方法执行。</p>
<p>好了，上面都是官方的范例，现在轮到自己动手了。<br>情景设定为，从数据库中获取所有的优惠码显示在页面中。<br>新建路由规则，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$route</span>[<span class="string">&#x27;codes&#x27;</span>] = <span class="string">&#x27;main/get&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>访问 <a target="_blank" rel="noopener" href="http://localhost/index.php/codes">http://localhost/index.php/codes</a> 时，即可使用Main控制类下的get()方法。</p>
<p>路由规则也可以使用正则限定参数，例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$route</span>[<span class="string">&#x27;codes/([a-z]+)/(\d+)&#x27;</span>] = <span class="string">&#x27;main/$1/$2&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>访问 <a target="_blank" rel="noopener" href="http://localhost/index.php/codes/get/1">http://localhost/index.php/codes/get/1</a> 时，会定向到main类下的get()方法，多余的url参数会传入到函数中。</p>
<h3 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h3><p>在目录application&#x2F;controller下，新建文件Main.php。<br>控制器类文件名可根据编程规范命名，这里为了方便仅采用了首字母大写的规则。<br>打开文件，键入代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> <span class="keyword">extends</span> <span class="title">CI_Controller</span> </span>&#123;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>因为要从数据库中获取信息，所以可以把读取模型的代码写入到构造方法中，减少后面的代码量。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;load-&gt;<span class="title function_ invoke__">model</span>(<span class="string">&#x27;coupon_model&#x27;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在get()方法中，直接使用模型类中的方法即可。<br>同时，把将要渲染模板的代码写入方法中，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$data</span>[<span class="string">&#x27;codes&#x27;</span>] = <span class="variable language_">$this</span>-&gt;coupon-&gt;<span class="title function_ invoke__">get_codes</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;load-&gt;<span class="title function_ invoke__">view</span>(<span class="string">&#x27;templates/header&#x27;</span>);</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;load-&gt;<span class="title function_ invoke__">view</span>(<span class="string">&#x27;pages/content&#x27;</span>, <span class="variable">$data</span>);</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;load-&gt;<span class="title function_ invoke__">view</span>(<span class="string">&#x27;templates/footer&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的view()方法会在<b>模板</b>章节介绍。</p>
<h3 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h3><p>数据库配置文件在目录application&#x2F;config下，<br>打开database.php可以看相关配置参数，根据实际情况填写即可。<br>配置完成后，在目录application&#x2F;models下，新建模型类文件Coupon_model.php,<br>打开文件输入以下代码即可完成配置，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Coupon_model</span> <span class="keyword">extends</span> <span class="title">CI_Model</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">         <span class="variable language_">$this</span>-&gt;load-&gt;<span class="title function_ invoke__">database</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_codes</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">         <span class="variable">$query</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">         <span class="keyword">return</span> <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">result_array</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回数据格式为数组。<br>这里用到的数据库信息与THINKPHP快速入门中一致。<br>这样，框架的模型配置已经完成了。</p>
<h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><p>这里介绍第三节提到的渲染模板。根据代码可以看出view()方法接收了两个参数，其中一个是模板文件的路径，另一个则是传入的变量。<br>模板文件在目录application&#x2F;views下，其中有官方模板可以借用。<br>新建两个文件夹pages和templates，与代码相对应。<br>顾名思义，templates是模板，可以将html通用代码分为header.html和footer.html两个文件，如<code>&lt;body&gt;</code>标签以上的部分写到header内，<code>&lt;/body&gt;</code>以下的部分写到footer内。引用时不需要写后缀名。<br>在pages文件夹内创建content.html，输入代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;h2&gt;这里是优惠码:&lt;/h2&gt;</span><br><span class="line">&lt;ul&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$date_item</span>):<span class="meta">?&gt;</span></span><br><span class="line">    &lt;li&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="variable">$date_item</span>[<span class="string">&#x27;id&#x27;</span>].<span class="string">&quot;:&quot;</span>.<span class="variable">$date_item</span>[<span class="string">&#x27;code&#x27;</span>]; <span class="meta">?&gt;</span>&lt;/li&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endforeach</span>; <span class="meta">?&gt;</span></span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure>
<p>这样的代码很是让人头疼。CI提供了模板解析类，使用更优美的模板语言渲染模板。当然这部分内容不在本文的范围内，具体内容可以参考官方文档。<br>当模板渲染时，会按照view()的顺序依次渲染。</p>
<p>现在，在浏览器地址栏输入  <a target="_blank" rel="noopener" href="http://localhost/index.php/codes">http://localhost/index.php/codes</a> ，会看到从数据库中获取的优惠码信息。</p>
<p>0:SUFFLzS<br>1:hZxakCl<br>2:xD2gz0N<br>3:6WwLt7U<br>4:xLSxY1n<br>5:bn422Ka<br>6:55BaQ0C<br>7:Ui1Jc8P</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>　　CodeIgniter的开发遵循了MVC的设计模式，这种将逻辑层与表现层分离的软件方法，让开发人员更专注于自己所属的工作，同时代码的维护也方便了很多。<br>　　个人非常喜欢CI框架，不仅是其简单自由高效的特性，更因为其语法风格。开发时配置明确，思路清晰，总之写起来很爽。</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-Threejs读取STL文件" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2016/11/26/Threejs%E8%AF%BB%E5%8F%96STL%E6%96%87%E4%BB%B6/">Threejs读取STL文件</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2016-11-26T09:42:46.000Z" itemprop="datePublished">十一月 26, 2016, 5:42 下午</time>

          
            × <span class="article-word-count">1.2k words</span>
            
            × <span class="article-time-to-read">4 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <blockquote>
<p>Threejs是使用JavaScript编写的，运行在浏览器中的3D引擎。</p>
</blockquote>
<p>　　当初想在我的小项目中添加三维模型展示的功能，于是找到了这个js编写的第三方库。它可以方便的读取图形文件加载到浏览器中，并且提供各式小工具完成交互功能。<br>　　我在工作中使用的三维软件是Solidworks，可以方便的导出STL格式的文件，这也是通常在3D打印中使用的格式。百度上搜到的threejs教程比较丰富，然而偏偏没有读取STL文件的方法。官方文档中提供了各种Loaders用于加载各种格式的图形文件，然而偏偏也没有读取STL文件的方法……<br>　　最终神奇的在官方提供的代码包中(<a target="_blank" rel="noopener" href="https://github.com/mrdoob/three.js" title="github">github</a>),找到了示例代码。分析代码，结合官方文档生肉，功夫不负有心人，总算是把生肉炒成了熟肉。<br>　　Talk is cheap,show me the code.</p>
<h3 id="添加画布"><a href="#添加画布" class="headerlink" title="添加画布"></a>添加画布</h3><p>其实就是在<code>&lt;body&gt;</code>标签内添加一个<code>&lt;div&gt;</code>,如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;output&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这个区域就是即将插入三维模型的地方，添加id属性方便获取。</p>
<h3 id="Threejs"><a href="#Threejs" class="headerlink" title="Threejs"></a>Threejs</h3><p>本代码中的功能需要引入官方包中的three.min.js, STLLoader.js和OrbitControls.js.</p>
<h4 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h4><p>初始化场景类</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> scene = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Scene</span>();</span><br></pre></td></tr></table></figure>
<p>为了便于观察，在场景中放置一个三坐标</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> axes = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">AxisHelper</span>(<span class="number">20</span>);</span><br><span class="line">scene.<span class="title function_">add</span>(axes);</span><br></pre></td></tr></table></figure>
<p>需要在场景添加其他物件时，使用scene.add()即可，就是这么简单~</p>
<h4 id="照相机"><a href="#照相机" class="headerlink" title="照相机"></a>照相机</h4><p>这里的照相机可不是生活中的指示代词，而是图形学中一种抽象概念。它定义了三维空间到二维屏幕的投影方式，照相机又分为正交投影照相机和透视投影照相机。本代码中使用的是透视投影照相机，至于为什么使用这个方式，有兴趣的同学可以wiki两种照相机的区别。<br>初始化照相机</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> camera = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">PerspectiveCamera</span>(<span class="number">45</span>, <span class="variable language_">window</span>.<span class="property">innerWidth</span> / <span class="variable language_">window</span>.<span class="property">innerHeight</span>, <span class="number">0.1</span>, <span class="number">1000</span>);</span><br><span class="line">camera.<span class="property">position</span>.<span class="property">x</span> = <span class="number">150</span>;</span><br><span class="line">camera.<span class="property">position</span>.<span class="property">y</span> = <span class="number">50</span>;</span><br><span class="line">camera.<span class="property">position</span>.<span class="property">z</span> = <span class="number">150</span>;</span><br><span class="line">camera.<span class="title function_">lookAt</span>(scene.<span class="property">position</span>);</span><br></pre></td></tr></table></figure>

<p>第一部分，PerspectiveCamera()接收四个参数：</p>
<ul>
<li>45，为照相机竖直方向张角（角度制）；</li>
<li>window.innerWidth &#x2F; window.innerHeight,照相机水平与竖直方向长度的比值，取三维模型渲染区域的横纵比例；</li>
<li>0.1, 1000，最近点和最远点。</li>
</ul>
<p>这些参数决定模型投影的形状与大小，一般情况下默认即可。</p>
<p>第二部分，设定照相机的位置，这些数值可根据模型大小进行调整。<br>第三部分，使照相机指向原点。</p>
<h4 id="读取与渲染"><a href="#读取与渲染" class="headerlink" title="读取与渲染"></a>读取与渲染</h4><p>初始化类</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> webGLRenderer = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">WebGLRenderer</span>();</span><br></pre></td></tr></table></figure>
<p>设定背景颜色与范围，并将渲染结果插入到页面中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">webGLRenderer.<span class="title function_">setClearColor</span>(<span class="number">0xEEEEEE</span>);</span><br><span class="line">webGLRenderer.<span class="title function_">setSize</span>(<span class="variable language_">window</span>.<span class="property">innerWidth</span>, <span class="variable language_">window</span>.<span class="property">innerHeight</span>);</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;output&quot;</span>).<span class="title function_">appendChild</span>(webGLRenderer.<span class="property">domElement</span>);</span><br></pre></td></tr></table></figure>
<p>初始化类，并读取模型文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> loader = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">STLLoader</span>();</span><br><span class="line">loader.<span class="title function_">load</span>(<span class="string">&quot;sample.stl&quot;</span>, <span class="keyword">function</span> (<span class="params">geometry</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> mat = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">MeshNormalMaterial</span>();</span><br><span class="line">    mesh = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Mesh</span>(geometry, mat);</span><br><span class="line">    mesh.<span class="property">scale</span>.<span class="title function_">set</span>(<span class="number">0.3</span>, <span class="number">0.3</span>, <span class="number">0.3</span>);</span><br><span class="line">    scene.<span class="title function_">add</span>(mesh);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>在匿名函数中，使用了内置的MeshNormalMaterial()材质，颜色分明便于观察。设定材质参数，添加到场景中。</p>
<h4 id="交互"><a href="#交互" class="headerlink" title="交互"></a>交互</h4><p>既然是浏览三维模型，所以模型必须能够随心所欲的从各个角度观看。<br>所以浏览器中的模型必须能够使用鼠标转动。官方包中提供了这一功能。<br>首先，初始化类</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">controls = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">OrbitControls</span>( camera, webGLRenderer.<span class="property">domElement</span> );</span><br><span class="line">controls.<span class="property">enableDamping</span> = <span class="literal">true</span>;</span><br><span class="line">controls.<span class="property">dampingFactor</span> = <span class="number">0.25</span>;</span><br><span class="line">controls.<span class="property">enableZoom</span> = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>其实每转动一次，浏览器都在重新绘制模型，所以参数中引入了照相机与渲染类。<br>下面几个语句是使能拖动和缩放，默认即可。</p>
<p><b>这里是重点！</b><br>以上代码都完成后，我发现模型在浏览器中并不能动！<br>为什么不动呢？这曾经是困扰了我很长时间的问题。<br>经过各种的google和stackoverflow后，我才找到了解决方法！<br>那就是requestAnimationFrame ()，通过递归调用更新画面，使画面动起来。<br>直接上代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">render</span>();</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="title function_">requestAnimationFrame</span>(render);</span><br><span class="line">            controls.<span class="title function_">update</span>();</span><br><span class="line">            webGLRenderer.<span class="title function_">render</span>(scene, camera);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>代码完成，全部代码以及预览效果可以到我的Repositories中查看。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>　　通过以上配置就可以将STL图形插入到网页中去了，并且可以使用鼠标拖动和缩放。<br>代码中的<code>&lt;div id=&quot;output&quot;&gt;</code>可以任意大小，任意位置。STL文件在网上能够搜到各种各样的模型，替换代码中的文件名即可。<br>　　如果想自己制作STL文件，推荐软件SketchUp.<br>　　在使用chrome浏览器时，会提示跨域错误，不能加载模型。此时右击浏览器图标-&gt;属性，在属性目标后（引号外）添加 –allow-file-access-from-files.<br>　　FireFox无此问题。</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-THINKPHP-简单入门" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2016/11/25/THINKPHP-%E7%AE%80%E5%8D%95%E5%85%A5%E9%97%A8/">THINKPHP 简单入门</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2016-11-25T09:45:47.000Z" itemprop="datePublished">十一月 25, 2016, 5:45 下午</time>

          
            × <span class="article-word-count">1.4k words</span>
            
            × <span class="article-time-to-read">6 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <blockquote>
<p>THINKPHP是一个快速简单的轻量级国产PHP开发框架。</p>
</blockquote>
<p>本文介绍了其基础的功能，方便自己查阅和回顾。<br>闲话少叙，下面开始:)</p>
<h3 id="一、环境"><a href="#一、环境" class="headerlink" title="一、环境"></a>一、环境</h3><p>建议使用wamp、lamp搭建测试环境，下载安装即可。<br>从官网下载THINKPHP 3.2版本的压缩包，解压后放到wamp(lamp)下的www文件夹内。<br>在浏览器地址栏输入<a target="_blank" rel="noopener" href="http://localhost/">http://localhost</a>, 即可看到欢迎界面。</p>
<h3 id="二、路由"><a href="#二、路由" class="headerlink" title="二、路由"></a>二、路由</h3><p>THINKPHP采用模块化设计，每个模块文件下都有相应的配置文件。<br>本文只配置一个模块Home，为了后面方便，仅需在Application&#x2F;Common&#x2F;Conf&#x2F;config.php<br>配置即可。即此后提到的配置文件语句，均写到此文件内。<br>打开config.php, 保留语句为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">array</span>();</span><br></pre></td></tr></table></figure>
<p>在括号内写入，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;URL_ROUTER_ON&#x27;</span> =&gt; <span class="literal">true</span>,              <span class="comment">//开启路由</span></span><br><span class="line"><span class="string">&#x27;URL_ROUTE_RULES&#x27;</span> =&gt; <span class="keyword">array</span>(           <span class="comment">//CURD操作</span></span><br><span class="line">    <span class="string">&#x27;create&#x27;</span> =&gt; <span class="string">&#x27;Home/Index/cre&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;update&#x27;</span> =&gt; <span class="string">&#x27;Home/Index/upd&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;retrieve&#x27;</span> =&gt; <span class="string">&#x27;Home/Index/ret&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;delete&#x27;</span> =&gt; <span class="string">&#x27;Home/Index/del&#x27;</span>,</span><br><span class="line">    ),                               </span><br></pre></td></tr></table></figure>
<p>此处路由规则的含义是，当在浏览器地址栏输入<br><a target="_blank" rel="noopener" href="http://localhost/index.php/create">http://localhost/index.php/create</a><br>时，相当于访问<br><a target="_blank" rel="noopener" href="http://localhost/index.php/Home/Index/cre">http://localhost/index.php/Home/Index/cre</a>,<br>即Home模块下Index控制类下的cre方法，以此类推。<br>当路由中包含参数时，在参数前添加’:’，匹配时$_GET[]会获取相应的参数，例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;create/:id\d/:code\d&#x27; =&gt; &#x27;Home/Index/cre&#x27;,</span><br></pre></td></tr></table></figure>
<p>\d为使用正则限制路由参数。</p>
<h3 id="三、控制器"><a href="#三、控制器" class="headerlink" title="三、控制器"></a>三、控制器</h3><p>控制器类文件命名的规则是首字母大写，驼峰命名法，并以.class.php结尾。<br>在路径Application&#x2F;Home&#x2F;Controller&#x2F;下，新建文件重命名为IndexController.class.php<br>打开文件添加代码，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">ret</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$Test</span> = <span class="title function_ invoke__">D</span>(<span class="string">&#x27;test&#x27;</span>);               <span class="comment">//使用内置D方法初始化模型类Test</span></span><br><span class="line">        <span class="variable">$temp</span> = <span class="variable">$Test</span>-&gt;<span class="title function_ invoke__">get_coupon</span>();     <span class="comment">//使用模型类中的get_coupon()方法</span></span><br><span class="line">        <span class="variable language_">$this</span> -&gt; <span class="title function_ invoke__">assign</span>(<span class="string">&#x27;temp&#x27;</span>,<span class="variable">$temp</span>);   <span class="comment">//模板赋值</span></span><br><span class="line">        <span class="variable language_">$this</span> -&gt; <span class="title function_ invoke__">display</span>(<span class="string">&#x27;main&#x27;</span>);        <span class="comment">//模板渲染</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upd</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$data</span>[<span class="string">&#x27;id&#x27;</span>] = <span class="number">99</span>;</span><br><span class="line">        <span class="variable">$data</span>[<span class="string">&#x27;code&#x27;</span>] = <span class="number">123456789</span>;</span><br><span class="line">        <span class="variable">$Test</span> = <span class="title function_ invoke__">M</span>(<span class="string">&#x27;test&#x27;</span>);              <span class="comment">//内置M方法</span></span><br><span class="line">        <span class="variable">$Test</span> -&gt; <span class="title function_ invoke__">add</span>(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">cre</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>] = <span class="variable">$data</span>[<span class="string">&#x27;id&#x27;</span>];      <span class="comment">//获取url中的参数</span></span><br><span class="line">        <span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>] = <span class="variable">$data</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line">        <span class="variable">$Test</span> = <span class="title function_ invoke__">M</span>(<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">        <span class="variable">$Test</span> -&gt; <span class="title function_ invoke__">where</span>(<span class="string">&#x27;id=2&#x27;</span>) -&gt; <span class="title function_ invoke__">save</span>(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">del</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$data</span>[<span class="string">&#x27;id&#x27;</span>] = <span class="number">99</span>;</span><br><span class="line">        <span class="variable">$data</span>[<span class="string">&#x27;code&#x27;</span>] = <span class="number">123456789</span>;</span><br><span class="line">        <span class="variable">$Test</span> = <span class="title function_ invoke__">M</span>(<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">        <span class="variable">$Test</span> -&gt; <span class="title function_ invoke__">where</span>(<span class="string">&#x27;id=1&#x27;</span>) -&gt; <span class="title function_ invoke__">delete</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码的方法对应着CURD操作，当路由匹配到方法时，对数据表进行相应的操作。</p>
<p>当不使用$_GET，而是直接将url内的参数传入到控制器内的方法时，<br>首先，在配置文件中添加</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;URL_PARAMS_BIND&#x27;</span>       =&gt;  <span class="literal">true</span>,</span><br></pre></td></tr></table></figure>
<p>开启参数绑定。<br>以上述cre()函数为例,</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">cre</span>(<span class="params"><span class="variable">$id</span>,<span class="variable">$code</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$data</span>[<span class="string">&#x27;id&#x27;</span>] = <span class="variable">$id</span>;</span><br><span class="line">        <span class="variable">$data</span>[<span class="string">&#x27;code&#x27;</span>] = <span class="variable">$code</span>;</span><br><span class="line">        <span class="variable">$Test</span> = <span class="title function_ invoke__">M</span>(<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">        <span class="variable">$Test</span> -&gt; <span class="title function_ invoke__">where</span>(<span class="string">&#x27;id=2&#x27;</span>) -&gt; <span class="title function_ invoke__">save</span>(<span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>访问 <a target="_blank" rel="noopener" href="http://localhost/index.php/Home/Index/ret/id/01/code/12345">http://localhost/index.php/Home/Index/ret/id/01/code/12345</a> 时，即可传入相应的参数。<br>当然，路由规则也需要加入相应的关键字。</p>
<p>这里简单说一下内置D方法和M方法的区别。</p>
<ul>
<li>当使用THINKPHP模型中的自动验证、关联模型等复杂业务逻辑功能时，使用D方法。</li>
<li>当仅使用CURD操作时，使用M方法。</li>
</ul>
<h3 id="四、模型"><a href="#四、模型" class="headerlink" title="四、模型"></a>四、模型</h3><p>模型类文件创建在Application&#x2F;Home&#x2F;Model&#x2F;下，同样采用首字母大写，驼峰规则，以<br>.class.php结尾命名。注意文件名要与控制器类的名称一致。<br>打开文件添加代码，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestModel</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_coupon</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$arr</span> = <span class="variable language_">$this</span> -&gt; <span class="title function_ invoke__">select</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$arr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为在控制器类中使用了get_coupon()方法，所以这里要把它加进去。如果有其他对模型操作的方法都可以写进来，当然写在控制器类也可以，但是为了代码功能明晰，建议分开写。</p>
<p>数据库连接参数写入配置文件，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;DB_TYPE&#x27;</span>  =&gt; <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;DB_USER&#x27;</span>  =&gt; <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;DB_PWD&#x27;</span>   =&gt; <span class="string">&#x27;1234&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;DB_HOST&#x27;</span>  =&gt; <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;DB_PORT&#x27;</span>  =&gt; <span class="string">&#x27;3306&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;DB_NAME&#x27;</span>  =&gt; <span class="string">&#x27;coupon&#x27;</span>,  <span class="comment">//这是测试用的数据表</span></span><br></pre></td></tr></table></figure>
<p>开发文档中提到了可以将配置信息生成为数组，但是不在模型类调用这一数组时，不要将配置信息组合为数组。</p>
<p>测试表coupon内容如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>code</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>SUFFLzS</td>
</tr>
<tr>
<td>1</td>
<td>hZxakCl</td>
</tr>
<tr>
<td>2</td>
<td>xD2gz0N</td>
</tr>
<tr>
<td>3</td>
<td>6WwLt7U</td>
</tr>
<tr>
<td>4</td>
<td>xLSxY1n</td>
</tr>
<tr>
<td>5</td>
<td>bn422Ka</td>
</tr>
<tr>
<td>6</td>
<td>55BaQ0C</td>
</tr>
<tr>
<td>7</td>
<td>Ui1Jc8P</td>
</tr>
</tbody></table>
<h3 id="五、模板"><a href="#五、模板" class="headerlink" title="五、模板"></a>五、模板</h3><p>模型类文件创建在Application&#x2F;Home&#x2F;View&#x2F;Index&#x2F;下,与控制器类内代码相对应，新建main.html文件，添加以下代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>测试主页<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">foreach</span> <span class="attr">name</span>=<span class="string">&#x27;temp&#x27;</span> <span class="attr">item</span>=<span class="string">&#x27;coupon&#x27;</span>&gt;</span></span><br><span class="line">&#123;$coupon.id&#125;:&#123;$coupon.code&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;foreach&gt;</code>是内置的标签，可以将数据循环输出。其中temp是控制器类内的数组名称，coupon为自定义名称，id和code为数组内的键名。</p>
<p>在浏览器地址栏访问 <a target="_blank" rel="noopener" href="http://localhost/index.php/Home/Index/cre">http://localhost/index.php/Home/Index/cre</a> 时，<br>页面显示为</p>
<p>0:SUFFLzS<br>1:hZxakCl<br>2:xD2gz0N<br>3:6WwLt7U<br>4:xLSxY1n<br>5:bn422Ka<br>6:55BaQ0C<br>7:Ui1Jc8P</p>
<h3 id="六、总结与吐槽"><a href="#六、总结与吐槽" class="headerlink" title="六、总结与吐槽"></a>六、总结与吐槽</h3><p>以下是总结：<br>　　至此，THINKEPHP 3.2的快速入门教程已经完成。本文对路由规则分配，控制器操作模型、渲染模板进行了简单的介绍。如果想深入了解框架的其他知识，还请移步官方文档。至于MySQL的相关知识，还是另开一篇文章好了。</p>
<p>以下是吐槽：<br>　　“什么AUIMD方法真的是反人类啊，不能顾名思义的方法都不是好方法！”，一位绞尽脑汁想不到新变量名称的程序员说道。</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-hello-world" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2016/11/24/hello-world/">Hello World</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2016-11-24T15:15:30.000Z" itemprop="datePublished">十一月 24, 2016, 11:15 晚上</time>

          
            × <span class="article-word-count">2 words</span>
            
            × <span class="article-time-to-read">1 minute</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>Hello,world!<br>:)</p>

      
    </div>
    
    
    
  </div>
</article>



  


  <nav id="page-nav" class="page-nav">
    
    <a class="extend prev" rel="prev" href="/">« Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>



    </div>
  </div>
  




<div id="settings-container">
  <div id="dark-mode">dark</div>
  <div id="sans-font">sans</div>
</div>
<script type="text/javascript">
let d=document,r=d.documentElement.style,f=r.setProperty.bind(r),l=localStorage,s=l.getItem('s')||(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches),n=l.getItem('n'),m=d.getElementById("dark-mode"),b=()=>{f('--bg-color','#fafafa');f('--code-bg-color','#f4f4f4');f('--text-color','#212121');f('--secondary-color','#808080');f('--tertiary-color','#b0b0b0');f('--link-color','#b5c8cf');f('--link-hover-color','#618794');f('--link-bg-color','#dae4e7');f('--selection-color','#dae4e7');m.innerHTML="dark"},c=()=>{f('--bg-color','#212121');f('--code-bg-color','#292929');f('--text-color','#fff');f('--secondary-color','#c0c0c0');f('--tertiary-color','#6e6e6e');f('--link-color','#4d6b75');f('--link-hover-color','#96b1bb');f('--link-bg-color','#5d828e');f('--selection-color','#acc1c9');m.innerHTML="light"},o=d.getElementById("sans-font"),e=()=>{f('--body-stack','"Lora", "Georgia", "Times New Roman", serif');o.innerHTML="sans"},g=()=>{f('--body-stack','"Lato", "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", "Verdana", sans-serif');o.innerHTML="serif"};m.onclick=()=>{if(s==2){s=1;l.setItem('s',s);c()}else{s=2;l.setItem('s',s);b()}};o.onclick=()=>{if(n==2){n=1;l.setItem('n',n);g()}else{n=2;l.setItem('n',n);e()}};if(!s){s=2;l.setItem('s',2)};if(s==1){c()};if(!n){n=2;l.setItem('n',2)};if(n==1){g()};
</script>




</body>
</html>
