<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>catinsides.github.io</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/css/highlight.css">

  
  <meta property="og:type" content="website">
<meta property="og:title" content="catinsides.github.io">
<meta property="og:url" content="https://catinsides.github.io/index.html">
<meta property="og:site_name" content="catinsides.github.io">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="catinsides">
<meta name="twitter:card" content="summary"><meta name="generator" content="Hexo 7.1.1"></head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1 id="title">
    <a href="/">catinsides.github.io</a>
  </h1>
  <nav>
    
    
      
      <a class="nav-link" href="/">Home</a>
    
      
        <span class="nav-spacer">×</span>
      
      <a class="nav-link" href="/archives">Archives</a>
    
      
        <span class="nav-spacer">×</span>
      
      <a class="nav-link" target="_blank" rel="noopener" href="https://github.com/Catinsides">Github</a>
    
    
  </nav>
</header>

    <div id="content">
      
  
    <article id="post-Hello-Again" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2024/03/28/Hello-Again/">Hello Again</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2024-03-28T02:39:28.000Z" itemprop="datePublished">三月 28, 2024, 10:39 上午</time>

          
            × <span class="article-word-count">49 words</span>
            
            × <span class="article-time-to-read">1 minute</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>时隔多年，终于把废弃的博客救回来了。  </p>
<p>找了个简洁的博客主题，不搞花里胡哨。  </p>
<p>争取以后有时间多更新些新的内容上来。  </p>
<p>:)</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-关于拓展NodeMediaServer以支持JT1078" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2019/07/17/%E5%85%B3%E4%BA%8E%E6%8B%93%E5%B1%95NodeMediaServer%E4%BB%A5%E6%94%AF%E6%8C%81JT1078/">关于拓展NodeMediaServer以支持JT1078</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2019-07-16T17:23:50.000Z" itemprop="datePublished">七月 17, 2019, 1:23 凌晨</time>

          
            × <span class="article-word-count">1.3k words</span>
            
            × <span class="article-time-to-read">4 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <h3 id="Jul-13-2019"><a href="#Jul-13-2019" class="headerlink" title="Jul. 13, 2019"></a>Jul. 13, 2019</h3><p>可能与最近几月坚持跑步有关，头脑突然灵活了很多。</p>
<p>前几日闲来无事摸鱼时，突然就翻回到了NodeMediaServer（NMS）的代码。从服务启动，到视频的解析推流，大致三到四个文件，脉络清晰。NMS的文件结构给了我很大的启发。我突然就想到，完全可以按照NMS的结构，把JT1078的解析也整合进去。</p>
<p>想到去年年底，第一次接触JT1078，视频拉流推流这些概念的时候，完全是一脸懵比。当时准备在NMS上改造，也是在视频推流之后，在NMS解析视频包的位置进行后续处理。甚至研究了一段时间的RTMP握手，由于设备推流不是RTMP协议，在代码里还要判断，如果是设备推流过来的，要跳过RTMP握手阶段，再推流出去。现在回想起来，甚是痛苦。好在现在知道了如何使用FFmpeg作为推流工具，使得这一功能实现。</p>
<p>今日，我仿照NMS的结构，和前几篇文章提到的FFmpeg命令，主要以FFmpeg推流实现的JT1078解析代码推到了仓库里。明显这不是最优的方案。其中一个很大的问题就是一个通道就要启动三个子进程（视频，音频和合并音视频），一般每台设备会有六个通道，观看一个设备的视频直播时就要启动大量的FFmpeg，相当耗费资源。而且这些子进程管理起来比较麻烦，有可能随时某一个在收不到数据时的进程关闭，就会出现 <strong>EPIPE</strong> 错误。而我理想中的最佳方案并不是这样的。最初，我尝试将设备推流过来的视频和音频数据，分别使用NMS原代码中的RTMP封包函数处理，送到播放者的socket中去，但是并没有成功。尝试几轮，服务端没有报错，看起来成功了，但是播放端并没有数据。未找到原因在哪，就暂时转换思路，使用FFmpeg来实现了。</p>
<p>后来又想到，直接使用NMS的封包函数是不行的。视频数据倒是不需要额外处理，音频数据是G7xx格式的，RTMP并不支持，所以需要转码。看来代码层面的封包和解码还需要研究一段时间。</p>
<p>唉！现在是不能够用代码直接封装音视频包，只得使用FFmpeg命令。我要是懂得音视频解封装，还能吃这个亏？</p>
<h3 id="Jul-16-2019"><a href="#Jul-16-2019" class="headerlink" title="Jul. 16, 2019"></a>Jul. 16, 2019</h3><p>今日，研究了一下FFmpeg的命令，想到可以使用两条输入流（视频和音频）转化成一条输出流（RTMP）的方式实现转码和推流。这样就能够不创造出上一方案中多出来的视频和音频子进程了。在将设备的视频和音频流数据，分别存储下来后，使用FFmpeg命令推流</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i test.264 -i test.mp3 -map 0:v -map 1:a -c:v copy -c:a copy -f flv rtmp://xxxx:1935/live/stream_xxxx</span><br></pre></td></tr></table></figure>

<p>命令执行成功，证明了这种方案可能行。于是，我将代码改造为，先将数据缓存，然后使用FFmpeg推流。谁知，实际情况是，缓存数据太小，FFmpeg进程启动后，瞬间就完成了推流，然后关闭了进程。造成的现象就是程序完全没有在（持续）推流。如果FFmpeg随时都要启动的话，有可能会遇到，总将文件从头开始推流的问题。遂暂时搁置了这种方案。</p>
<p>根据上一方案存在的问题，又想到了启动子进程后，可以使用写入 <strong>stdin</strong> 的方式，将数据写入FFmpeg的进程中。但是并没有找到NodeJs写入两条输入流到一个子进程中去的方法。就算是将视频流利用管道符串接到音频流的转码进程中，还是需要有两条输入流。看来这种方案暂时也不行了。</p>
<p>无意中翻到了 <strong>fluent-ffmpeg</strong> 这个库，好像有支持两条输入流的接口，待有时间再测试。</p>
<h3 id="Dec-31-2019"><a href="#Dec-31-2019" class="headerlink" title="Dec. 31, 2019"></a>Dec. 31, 2019</h3><p>万万没想到，在2020以前我能将上面的问题解决。 <del>先忘记fluent-ffmpeg这件事吧</del><br>注: <strong>以下内容适用于Linux系统</strong><br>解决方案仍然是，将视频和音频分流后存储为文件，不同的是文件类别为pipe文件，即命名管道文件(Named Pipe).它遵循先进先出原则(FIFO)，可以像普通文件一样管理。<br>可以使用以下命令创建管道文件:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkfifo /tmp/one.pipe</span><br><span class="line">$ mkfifo /tmp/two.pipe</span><br></pre></td></tr></table></figure>

<p>然后将程序分离出的视频数据和音频数据像写文件一样写入即可，ffmpeg的进程则从这两个文件中读取数据，再转换成rtmp推流发送出去。<br>ffmpeg命令如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ffmpeg -loglevel panic -probesize 32 -re -r 16 -f h264 -i /tmp/one.pipe -f mp3 -i /tmp/two.pipe -map 0:v -map 1:a -c:v copy -c:a aac -strict -2 -preset ultrafast -tune zerolatency -f flv rtmp://xxxx:1935/live/stream_xxxx</span><br></pre></td></tr></table></figure>

<p>读入的文件需要指定格式，如h264和mp3(在上一步中将g726转为了mp3).<br>具体代码实现见我此次提交 <a target="_blank" rel="noopener" href="https://github.com/Catinsides/Node-Media-Server/commit/17be2385e0bc00e4514c504035155d3703299947?diff=split">commit</a></p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-JT1078协议开发之双向对讲后记" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2019/03/29/JT1078%E5%8D%8F%E8%AE%AE%E5%BC%80%E5%8F%91%E4%B9%8B%E5%8F%8C%E5%90%91%E5%AF%B9%E8%AE%B2%E5%90%8E%E8%AE%B0/">JT1078协议开发之双向对讲后记</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2019-03-28T16:00:00.000Z" itemprop="datePublished">三月 29, 2019, 12:00 凌晨</time>

          
            × <span class="article-word-count">1.9k words</span>
            
            × <span class="article-time-to-read">8 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>上一篇大致介绍了一下实时视频的开发流程，这一篇所要介绍的双向对讲算是上一篇内容的小进阶。由 JT&#x2F;T 1078协议（以下简称1078）中介绍可知，双向对讲的数据传输方式也是在 <strong>5.5.3</strong> 表19中定义的。下达双向对讲指令通过改变修改 <strong>0x9101</strong> 消息ID中的参数来实现，本篇不再赘述。功能实现思路与上一篇相同，使用 <strong>nodejs</strong> 和 <strong>FFmpeg</strong> 实现。测试系统环境为 <strong>Linux</strong> .</p>
<h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>见上一篇</p>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>实时视频流程大致如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">participant 网页</span><br><span class="line">participant 服务器</span><br><span class="line">participant 设备</span><br><span class="line"></span><br><span class="line">网页 -&gt;&gt; 设备: 下达双向对讲指令</span><br><span class="line">设备 -&gt;&gt; 服务器: 推送音频数据</span><br><span class="line">服务器 -&gt;&gt; 网页: 转换音频格式推流至网页，并通知开启网页麦克风</span><br><span class="line">网页 -&gt;&gt; 服务器: 采集音频数据并推送</span><br><span class="line">服务器 -&gt;&gt; 设备: 将网页端音频转码，发送至设备</span><br></pre></td></tr></table></figure>

<h3 id="网页采集音频"><a href="#网页采集音频" class="headerlink" title="网页采集音频"></a>网页采集音频</h3><p>浏览器利用麦克风采集麦克风的方法，网上的代码有很多，方法也是如出一辙。<br>下面直接贴出代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> leftchannel = [];</span><br><span class="line"><span class="keyword">var</span> rightchannel = [];</span><br><span class="line"><span class="keyword">var</span> recorder = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> recording = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">var</span> recordingLength = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> volume = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> audioInput = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> sampleRate = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> audioContext = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> context = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> outputElement = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;output&#x27;</span>);    <span class="comment">// 用于提示当前录音状态</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!navigator.<span class="property">getUserMedia</span>)</span><br><span class="line">    navigator.<span class="property">getUserMedia</span> = navigator.<span class="property">getUserMedia</span> || navigator.<span class="property">webkitGetUserMedia</span> ||</span><br><span class="line">        navigator.<span class="property">mozGetUserMedia</span> || navigator.<span class="property">msGetUserMedia</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (navigator.<span class="property">getUserMedia</span>) &#123;</span><br><span class="line">    navigator.<span class="title function_">getUserMedia</span>(&#123; <span class="attr">audio</span>: <span class="literal">true</span> &#125;, success, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&#x27;Error capturing audio.&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">alert</span>(<span class="string">&#x27;getUserMedia not supported in this browser.&#x27;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">interleave</span>(<span class="params">leftChannel, rightChannel</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> length = leftChannel.<span class="property">length</span> + rightChannel.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">new</span> <span class="title class_">Float32Array</span>(length);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> inputIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> index = <span class="number">0</span>; index &lt; length;) &#123;</span><br><span class="line">        result[index++] = leftChannel[inputIndex];</span><br><span class="line">        result[index++] = rightChannel[inputIndex];</span><br><span class="line">        inputIndex++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mergeBuffers</span>(<span class="params">channelBuffer, recordingLength</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">new</span> <span class="title class_">Float32Array</span>(recordingLength);</span><br><span class="line">    <span class="keyword">var</span> offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> lng = channelBuffer.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; lng; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> buffer = channelBuffer[i];</span><br><span class="line">        result.<span class="title function_">set</span>(buffer, offset);</span><br><span class="line">        offset += buffer.<span class="property">length</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">writeUTFBytes</span>(<span class="params">view, offset, string</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> lng = string.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; lng; i++) &#123;</span><br><span class="line">        view.<span class="title function_">setUint8</span>(offset + i, string.<span class="title function_">charCodeAt</span>(i));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">success</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Record Init Succcess!&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    audioContext = <span class="variable language_">window</span>.<span class="property">AudioContext</span> || <span class="variable language_">window</span>.<span class="property">webkitAudioContext</span>;</span><br><span class="line">    context = <span class="keyword">new</span> <span class="title function_">audioContext</span>();</span><br><span class="line">    sampleRate = context.<span class="property">sampleRate</span>;    <span class="comment">// 44100</span></span><br><span class="line">    volume = context.<span class="title function_">createGain</span>();</span><br><span class="line">    audioInput = context.<span class="title function_">createMediaStreamSource</span>(e);</span><br><span class="line"></span><br><span class="line">    audioInput.<span class="title function_">connect</span>(volume);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> bufferSize = <span class="number">2048</span>;</span><br><span class="line">    recorder = context.<span class="title function_">createScriptProcessor</span>(bufferSize, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    recorder.<span class="property">onaudioprocess</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!recording) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">var</span> left = e.<span class="property">inputBuffer</span>.<span class="title function_">getChannelData</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">var</span> right = e.<span class="property">inputBuffer</span>.<span class="title function_">getChannelData</span>(<span class="number">1</span>);</span><br><span class="line">        leftchannel.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">Float32Array</span>(left));</span><br><span class="line">        rightchannel.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">Float32Array</span>(right));</span><br><span class="line">        recordingLength += bufferSize;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;recording...&#x27;</span>);</span><br><span class="line">        <span class="title function_">combineAudio</span>([<span class="keyword">new</span> <span class="title class_">Float32Array</span>(left)], [<span class="keyword">new</span> <span class="title class_">Float32Array</span>(right)], bufferSize, sampleRate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    volume.<span class="title function_">connect</span>(recorder);</span><br><span class="line">    recorder.<span class="title function_">connect</span>(context.<span class="property">destination</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">combineAudio</span>(<span class="params">leftc, rightc, bfSize, sampleRate</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> leftBuffer = <span class="title function_">mergeBuffers</span>(leftc, bfSize);</span><br><span class="line">    <span class="keyword">var</span> rightBuffer = <span class="title function_">mergeBuffers</span>(rightc, bfSize);</span><br><span class="line">    <span class="keyword">var</span> interleaved = <span class="title function_">interleave</span>(leftBuffer, rightBuffer);</span><br><span class="line">    <span class="keyword">var</span> dataLen = interleaved.<span class="property">length</span> * <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">var</span> buffer, view, index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(dataLen);    </span><br><span class="line">    view = <span class="keyword">new</span> <span class="title class_">DataView</span>(buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> lng = interleaved.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">var</span> volume = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; lng; i++) &#123;</span><br><span class="line">        view.<span class="title function_">setInt16</span>(index, interleaved[i] * (<span class="number">0x7FFF</span> * volume), <span class="literal">true</span>);</span><br><span class="line">        index += <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([view], &#123; <span class="attr">type</span>: <span class="string">&#x27;audio/wave&#x27;</span> &#125;);    <span class="comment">// 最终音频数据</span></span><br><span class="line">    <span class="comment">// 将blob写入 websocket, 略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码主要思路为通过改变全局变量 <strong>recording</strong> 控制录音，这个可以使用 <strong>button</strong> 元素实现。开启录音后，浏览器采集左右声道的音频数据，将数据存入Buffer后，合并两通道数据然后通过 <strong>DataView</strong> 和 <strong>Blob</strong> 包装后的数据发送至服务器。为了保证实时性，我这里使用的是 <strong>websocket</strong> 发送至后台。上述代码得到的音频数据为 <strong>PCMS16LE</strong> 原始数据，默认采样率为44.1k，所以体积比较巨大。可以通过减少声道数量和降低采样率，或者直接在浏览器端重新编码来减少体积。</p>
<h3 id="音频转码"><a href="#音频转码" class="headerlink" title="音频转码"></a>音频转码</h3><p>音频转码涉及两个部分，一是将网页端采集的音频数据转换成设备支持的格式发送给设备；二是将设备端发送的音频数据转成网页端支持的格式进行播放。<br>设备支持什么格式呢？由于设备的不同，可能初始默认的音频格式都不尽相同。最方便的肯定是直接操作设备进行查看了。还可以在下达双向对讲指令后，解析RTP包参照1078 <strong>表12</strong> 进行查看。我手里这台设备的音频格式是 <strong>G726LE</strong>.<br>首先进行网页端播放设备音频流的实现。有了上一篇文章的经验，音视频服务器和网页端播放器都是准备好的，一下子省去了很多的工作，只需要将设备音频数据转码发送给音视频服务器即可。然后，网页端从音视频服务器提供的地址拉流就能进行播放了。看起来很简单有木有，突然有点小兴奋。<br>接下来的思路与视频处理相似，使用子进程开启 <strong>FFmpeg</strong> 进行转码并推流。由于推流要使用 <strong>flv</strong> 格式的 <strong>RTMP</strong> 流，而 <strong>flv</strong> 支持的音频格式是有限的（<a target="_blank" rel="noopener" href="https://trac.ffmpeg.org/wiki/SupportedMediaTypesInFormats">点击查看</a>），光是进行音频转码就占用了一个FFmpeg子进程，所以还需要另一个进程将转码后的数据推流出去。听起来很麻烦，但FFmpeg支持数据流处理，所以实现起来非常简单，只需要将两个子进程的STDIN, STDOUT pipe 起来就行了，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; spawn &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FFMPEG</span> = <span class="string">&#x27;/usr/bin/ffmpeg&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cmds1 = [</span><br><span class="line">    <span class="string">&#x27;-loglevel&#x27;</span>, <span class="string">&#x27;panic&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-probesize&#x27;</span>, <span class="string">&#x27;32&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;g726le&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-code_size&#x27;</span>, <span class="string">&#x27;5&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-ar&#x27;</span>, <span class="string">&#x27;8000&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-ac&#x27;</span>, <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-i&#x27;</span>, <span class="string">&#x27;-&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-ar&#x27;</span>, <span class="string">&#x27;44100&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-acodec&#x27;</span>, <span class="string">&#x27;libmp3lame&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;mp3&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;pipe:1&#x27;</span></span><br><span class="line">];</span><br><span class="line"><span class="keyword">var</span> cmds2 = [</span><br><span class="line">    <span class="string">&#x27;-i&#x27;</span>, <span class="string">&#x27;-&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-vn&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;copy&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;flv&#x27;</span>,</span><br><span class="line">    rtmpUrl</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> child1 = <span class="title function_">spawn</span>(<span class="variable constant_">FFMPEG</span>, cmds1);</span><br><span class="line"><span class="keyword">var</span> child2 = <span class="title function_">spawn</span>(<span class="variable constant_">FFMPEG</span>, cmds2);</span><br><span class="line"></span><br><span class="line">child1.<span class="property">stdin</span>.<span class="title function_">write</span>(data);</span><br><span class="line">child1.<span class="property">stdout</span>.<span class="title function_">pipe</span>(child2.<span class="property">stdin</span>);</span><br></pre></td></tr></table></figure>

<p>这样，网页端播放器就能使用 <strong>RTMP</strong> 链接播放设备的音频数据了。<br>回来处理网页端到设备端的部分，思路也清晰了起来，只需将音频数据写到设备就行了。已经知道了设备支持的编码格式是 <strong>G726LE</strong>，所以首先需要将音频转码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; spawn &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FFMPEG</span> = <span class="string">&#x27;/usr/bin/ffmpeg&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cmds = [</span><br><span class="line">    <span class="string">&#x27;-loglevel&#x27;</span>, <span class="string">&#x27;panic&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;s16le&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-ar&#x27;</span>, <span class="string">&#x27;44.1k&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-ac&#x27;</span>, <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-i&#x27;</span>, <span class="string">&#x27;-&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-acodec&#x27;</span>, <span class="string">&#x27;g726le&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-code_size&#x27;</span>, <span class="string">&#x27;5&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-ar&#x27;</span>, <span class="string">&#x27;8k&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-ac&#x27;</span>, <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;g726le&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;pipe:1&#x27;</span></span><br><span class="line">];</span><br><span class="line"><span class="keyword">var</span> _process = <span class="title function_">spawn</span>(<span class="variable constant_">FFMPEG</span>, cmds);</span><br></pre></td></tr></table></figure>

<p>开启子进程后，将网页端数据写入进程STDIN，再将STDOUT数据写入设备连至服务器的TCP连接即可。因为流程中，是先下达指令，设备连接上来后，再进行网页端数据写入，设备的连接是很容易获取到的。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>实时视频和双向对讲的实现思路大体上是一致，区别在FFmpeg的参数不同，多开启了几个进程而已。不由得感叹FFmpeg的强大。前后两篇文章中，涉及到业务的代码都是一笔带过，而主要列举了FFmpeg的命令。不要小看这简单的几行命令，对于从没接触过FFmpeg和音视频知识几乎为零的我来说，花费了大量的时间来搜索和尝试。相比之下，业务上码代码花费的时间更少。业务代码中也有很多值得注意的点，如设备连接和断开时，FFmpeg进程的管理；FFmpeg进程写入时，EPIPE的处理（管理各个子进程的事件回调）；双向对讲状态的共享（Redis实现）等等。经过这一项目的一番折腾，也算是了解一些音视频方面的知识，也对这方面有了一番兴趣。打算借着没有减退的热度开个音视频相关的小项目，希望自己不要弃坑。</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-JT1078协议开发之实时视频后记" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2019/03/16/JT1078%E5%8D%8F%E8%AE%AE%E5%BC%80%E5%8F%91%E4%B9%8B%E5%AE%9E%E6%97%B6%E8%A7%86%E9%A2%91%E5%90%8E%E8%AE%B0/">JT1078协议开发之实时视频后记</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2019-03-15T16:00:00.000Z" itemprop="datePublished">三月 16, 2019, 12:00 凌晨</time>

          
            × <span class="article-word-count">2.6k words</span>
            
            × <span class="article-time-to-read">9 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>前几个月一直在进行JT&#x2F;T 1078协议（以下简称1078）相关项目的开发，其中涉及各种音视频协议和网络协议，还有音视频服务器和处理软件的知识。从一开始处于知识盲区的我，一路摸爬滚打，google和阅读书籍，挖坑填坑，总算是把项目需要的功能给研究出来了。当然，1078本身描述的功能很多，全部实现需要大量的人力和时间，一篇文章也不可能讲完。所以，打算用两篇文章主要记录一下实时视频和双向对讲的实现方法。这一篇为实时视频，双向对讲放在下一篇。功能皆使用 <strong>nodejs</strong> 和 <strong>FFmpeg</strong> 实现，系统环境为 <strong>Linux</strong> .</p>
<h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>项目需求简单地说就是，有一台支持1078协议的设备，接收特定指令后，通过协议内容将音视频数据发送至服务器（以下简称推流），服务器再将音视频数据转发出去，使得客户端或者网页播放器能够收看到设备发送的数据（以下简称拉流），以达到实时视频的效果。后面功能的实现皆为网页端操作。</p>
<p>所以至少要准备：</p>
<ul>
<li>1078协议文档</li>
<li>1078协议设备</li>
<li>音视频服务器</li>
<li>播放器</li>
</ul>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>实时视频流程大致如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">participant 网页</span><br><span class="line">participant 服务器</span><br><span class="line">participant 设备</span><br><span class="line"></span><br><span class="line">网页 -&gt;&gt; 设备: 下达推送视频指令</span><br><span class="line">设备 -&gt;&gt; 服务器: 推送视频数据</span><br><span class="line">服务器 -&gt;&gt; 网页: 转换为网页支持的格式</span><br></pre></td></tr></table></figure>

<h3 id="音视频服务器与解析"><a href="#音视频服务器与解析" class="headerlink" title="音视频服务器与解析"></a>音视频服务器与解析</h3><p>下达推送指令部分可按照协议要求的格式轻松搞定，主要问题在于如何将设备的音视频数据推流至服务器。服务器再转换为网页端能够拉流播放的格式。说到视频直播，推流拉流，首先想到的是RTMP。在搜索引擎中搜一搜，支持RTMP的音视频服务器，无论是开源还是闭源，都有很多。首先找到一个部署方便的，放在服务器上待命。<br>部署完成之后，可以使用FFmpeg推送本地文件至服务器测试好不好用。</p>
<p>FFmpeg命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -re -i localFile.mp4 -c copy -f flv rtmp://server:1935/live/streamName</span><br></pre></td></tr></table></figure>

<p>RTMP链接后部分可能根据服务器有所不同。端口一般为1935.<br>播放RTMP链接，可以使用FFmpeg内置的ffplay，或者其他在线播放网站即可。</p>
<p>由1078文档内容可知，设备的音视频传输方式，定义在 <strong>5.5.3</strong> 部分。</p>
<blockquote>
<p>实时音视频流数据的传输参考RTP协议，使用UDP或TCP承载。</p>
</blockquote>
<p>可知，设备推流并不是RTMP协议，而是魔改的RTP协议，具体内容在表19中。这和服务器接收的数据协议不同，所以需要将设备推流转换为服务器能够接收的协议格式。<br>第一次搞这种东西，只看文档一头雾水，没别的办法，搭建一个TCP服务，让设备把数据发过来，验证数据格式是否与文档中描述的一致。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">&#x27;net&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">HOST</span> = <span class="string">&#x27;xx&#x27;</span>, <span class="variable constant_">PORT</span> = <span class="string">&#x27;xx&#x27;</span>;    <span class="comment">// 在下发指令中指定</span></span><br><span class="line"><span class="keyword">const</span> server = net.<span class="title function_">createServer</span>(<span class="function"><span class="params">socket</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;TCP Server Created!&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;TCP Server Error ==&#x27;</span>, err);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function"><span class="params">_</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;TCP Server Closed.&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    socket.<span class="title function_">setKeepAlive</span>(<span class="literal">true</span>, <span class="number">2000</span>);</span><br><span class="line">    socket.<span class="built_in">setTimeout</span>(<span class="number">10000</span>, <span class="function"><span class="params">_</span> =&gt;</span> &#123;</span><br><span class="line">        socket.<span class="title function_">end</span>(<span class="string">&#x27;TCP Socket Broken.&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">server.<span class="title function_">listen</span>(<span class="variable constant_">PORT</span>, <span class="variable constant_">HOST</span>, <span class="function"><span class="params">_</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Server Start Successfully, Listen on <span class="subst">$&#123;PORT&#125;</span>.`</span>);</span><br><span class="line">&#125;);</span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>, <span class="function"><span class="params">socket</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> &#123; remoteAddress &#125; = socket, &#123; address, port &#125; = socket.<span class="title function_">address</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Address is &#x27;</span>, address, <span class="string">&#x27;. Port is&#x27;</span>, port, <span class="string">&#x27;. remoteAddress is &#x27;</span>, remoteAddress);</span><br><span class="line"></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// console.log(&#x27;TCP ON DATA&#x27;);</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function"><span class="params">_</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Bye&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>设备推流后会触发socket的on data 事件，由于data是Buffer，所以需要把data转换成 <strong>16进制</strong> 的数据才能对照文档分析。转换完成后，可以大致看到一些规律，与文档中描述的一致。一个data变量可能包含多个以 <strong>0x30 0x31 0x63 0x64</strong> 开头的数据，对应文档中的帧头标识。有没有可能在负载数据中也出现帧头呢，那就再往后取一个字节，降低概率。可以观察到第4至第5字节，都是 <strong>0x81</strong> .具体含义可以看 <strong>RFC 3550</strong>.每个RTP包除了前30字节（也有可能少于30）的数据描述外，就是媒体数据payload了。<br>接下来要做的是，从TCP数据中分离出每个RTP包。TCP是基于流式传输的（我真的很讨厌“粘包”这个词），每个data不一定以帧头开始，或者结束，而且中间可能包含多个RTP包。但是已经知道了帧头一定是 <strong>0x30 0x31 0x63 0x64 0x81</strong> , 所以可以用帧头来切分TCP数据。再将切分出来的RTP包传入到下一个函数中单独处理。这部分处理很简单，不再贴代码，需要注意的地方就是如何将两个TCP data中的RTP包数据组合再传入函数。<br>先假定现在是最理想的情况，即不需要考虑RTP包乱序，视频帧乱序的情况，以这种前提将payload存储下来看看能否正常播放。当然，上面的再取一个 <strong>0x81</strong> 也是在这种前提下考虑的。<br>接下来就是要分析RTP包的数据了。完全对照文档中的表19按字节读取即可。网络传输使用的是 <strong>大端模式</strong> ，nodejs中使用的函数主要为以下几个：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">buf.<span class="title function_">slice</span>([start[, end]])</span><br><span class="line">buf.<span class="title function_">readInt8</span>(offset)</span><br><span class="line">buf.<span class="title function_">readInt16BE</span>(offset)</span><br><span class="line">buf.<span class="title function_">readInt32BE</span>(offset)</span><br></pre></td></tr></table></figure>

<p>解析完成后，可以看到当前RTP包所承载的数据信息。如包序号，SIM卡号，通道号，数据类型，分包标记等。原子包不做处理，分包需要将后续的包组合成一个数据。从第5字节中的数据可知，当前包负载中的媒体类型，解析后对应表12查得可知，音频格式为 <strong>G.726</strong>，视频格式为 <strong>H.264</strong>.不同设备的格式可能有所不同。将音频包和视频包分别存储为音频和视频文件，再使用软件播放验证前面解析程序的正确性。全部正确的话，这些文件都是可以正常播放的。<br>接下来就需要想办法如何把这些数据推流到音视频服务器了。服务器接收的格式为RTMP流，需要把从RTP分离出的媒体数据转化为RTMP流推到服务器。由于本人还不能直接用nodejs撸出一个转码和推流服务的程序出来，接下来的工作便交给了 <strong>FFmpeg</strong> 处理。<br>先来看一下如何处理视频数据，用FFmpeg将本地文件推送至RTMP服务器，查官方文档可知，得到下面的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -loglevel panic \</span><br><span class="line">    -probesize 32 \</span><br><span class="line">    -re \</span><br><span class="line">    -r 16 \</span><br><span class="line">    -i localfile.h264 \</span><br><span class="line">    -c:v libx264 \</span><br><span class="line">    -preset ultrafast \</span><br><span class="line">    -tune zerolatency \</span><br><span class="line">    -profile:v baseline \</span><br><span class="line">    -f flv <span class="string">&quot;rtmp://xxx&quot;</span></span><br></pre></td></tr></table></figure>

<p>上面这条语句不止能推送文件，还是最终的优化版。<br>解释一下部分选项：</p>
<ul>
<li>-loglevel panic 用于屏蔽ffmpeg的输出内容</li>
<li>-probesize 32 用于降低ffmpeg转换延迟</li>
<li>-r 16 设置帧率，需要与设备端一致，否则会出现播放速度太快的问题</li>
<li>-f flv “” 输出rtmp链接，这里需要使用SIM卡号和通道号组合成特定链接</li>
</ul>
<p>有了这条命令，就该想办法如何把RTP中的payload输入到ffmpeg了。<br>ffmpeg支持从STDIN输入的数据，所以只需要将ffmpeg执行命令放入nodejs的child process子进程中，然后把payload数据写入该子进程的STDIN即可，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; spawn &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FFMPEG</span> = <span class="string">&#x27;/usr/bin/ffmpeg&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cmds = [</span><br><span class="line">    <span class="string">&#x27;-loglevel&#x27;</span>, <span class="string">&#x27;panic&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-probesize&#x27;</span>, <span class="string">&#x27;32&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-re&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-r&#x27;</span>, <span class="string">&#x27;16&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-i&#x27;</span>, <span class="string">&#x27;-&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-c:v&#x27;</span>, <span class="string">&#x27;libx264&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-preset&#x27;</span>, <span class="string">&#x27;ultrafast&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-tune&#x27;</span>, <span class="string">&#x27;zerolatency&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-profile:v&#x27;</span>, <span class="string">&#x27;baseline&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;flv&#x27;</span>,</span><br><span class="line">    rtmpUrl</span><br><span class="line">];</span><br><span class="line"><span class="keyword">var</span> child = <span class="title function_">spawn</span>(<span class="variable constant_">FFMPEG</span>, cmds);</span><br><span class="line">child.<span class="property">stdin</span>.<span class="title function_">write</span>(data);</span><br></pre></td></tr></table></figure>

<p>区别在于，将本地文件的名称换成了 - .ffmpeg会在子进程中将payload数据转化成rtmp推流到服务器。完成这一部分的代码之后，可以先尝试着将数据推流到音视频服务器，然后找一个能在线看rtmp的网站进行测试。程序无误的情况下，可以看到直播数据。在单台设备全通道的情况下，可以做到延迟 <strong>2-3s</strong> .说明上面的“大胆”假设是正确的，一下子感觉轻松了不少:)</p>
<p>再接下来需要进一步完善程序，如：</p>
<ul>
<li>设备收到停止视频推送指令后，需要关闭ffmpeg的子进程</li>
<li>多设备，多通道情况下的ffmpeg子进程管理</li>
</ul>
<p>这就与1078协议开发无关了，考验写程序功底的时候到了，本文不再赘述。</p>
<p>音频部分涉及到转码，留在与下一篇双向对讲功能一起说。</p>
<h3 id="网页端"><a href="#网页端" class="headerlink" title="网页端"></a>网页端</h3><p>网页端无论是Flash还是H5的视频播放器有很多，翻翻文档API就可以查到如何播放指定链接的视频。如果音视频服务器不仅能提供rtmp流，还能提供flv流，网页播放的实现可以更加灵活。</p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>1078协议实时视频的开发，说难不难，说简单不简单。它难就难在网上的资料居然如此之少，完全需要靠自己摸索验证。而且在开发验证的过程中，很容易走弯路。开发完成后，回头再看，发现只是需要按文档读取数据而已，并没有涉及音视频领域更深一层的知识。<br>本文并没有完全使用nodejs进行转码和推送的实现，而是使用了ffmpeg作为子进程进行推流。恕本人学识有限，音视频知识的学习任重而道远，暂时只能以这样的“笨”方法实现功能需求。新的学习计划已提上日程，希望在以后的日子里能够进一步改进。</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-2018都做了些什么" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2018/12/31/2018%E9%83%BD%E5%81%9A%E4%BA%86%E4%BA%9B%E4%BB%80%E4%B9%88/">2018都做了些什么</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2018-12-31T15:59:59.000Z" itemprop="datePublished">十二月 31, 2018, 11:59 晚上</time>

          
            × <span class="article-word-count">740 words</span>
            
            × <span class="article-time-to-read">2 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <blockquote>
<p>不要高估一天能做到的事，也不要低估一年能做到的事。</p>
</blockquote>
<p>我这个人是拒绝鸡汤的。偶然在V2里看到这句话，思考了一下，也确实有一些道理。回想到去年此时的自己，怎么也想不到会学习了这么多的新技能。每天学习一点点，日积月累，真的很重要。</p>
<p>回想这一年：</p>
<ul>
<li>印象最深的一本书，是<a target="_blank" rel="noopener" href="https://book.douban.com/subject/27081224/">《学会提问》</a>。书本身很小巧，几个小时就能读完，但是收获的内容可以说是受益终生。作者从提问的意义，到提问分类，再到优质提问的方法，阐述了学会做优质的提问是多么的重要。问题也可分为抛给对方还是抛给自己的。抛给对方的问题，能够带来有益的思考，还能解决自己的迷惑。而抛给自己的优质提问是有力的内驱力。</li>
<li>印象最深的影视剧，是<a target="_blank" rel="noopener" href="https://movie.douban.com/subject/26602304/">《重版出来！》</a>。有一点浮夸风的职场剧，毕竟是漫改。看罢，真是感觉热血到不行。也了解到了，一部漫画作品从创作到连载的艰辛。如果能够依靠自己的爱好赚钱，真是既痛苦又快乐的事情。以至于，看完剧的我买了几本《超级漫画素描技法》，然而并没有怎么看，放到书架上吃灰中（摊手）。</li>
</ul>
<p>回到上班摸鱼，除了几个从部署到完成业务的与深度学习相关的功能，还是在前端页面和后端增删改查之中打转。深度学习并没有深度学习，前后端相比以前熟悉了很多，四舍五入也算是进步了吧。在业余时间，学习了下docker的使用，这绝对是这一年最大的收获了。在部署服务和测试功能上，都有很大的帮助，绝对是早学早受益。</p>
<p>夏季之前，也尝试了下Unity3D.利用了半个月左右的下班后时间，制作出了极其简陋的第三人称射击游戏。游戏拥有基本的界面和操作，敌人不能动，但是能够随机地点重生。说的好像有点roguelike呢。深刻体会到了游戏制作的艰辛，由衷地钦佩能够包揽美术、音乐和策划的独立制作人。</p>
<p>这一年一直坚持下来的就是日语的学习了，受影视音乐文化的影响，也保持着高涨的热情。虽然进步缓慢，但督促自己能够坚持下去。年底接手了与音视频相关的项目，接触不少新知识，C&#x2F;C++的学习也提上了日程(虽然被《C++ Primer Plus》的厚度吓到劝退)。希望在新的一年里，珍惜时间，努力学习，想要放弃的时候，想想为什么要开始。</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-给console.log一点颜色看看" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2017/07/03/%E7%BB%99console.log%E4%B8%80%E7%82%B9%E9%A2%9C%E8%89%B2%E7%9C%8B%E7%9C%8B/">给console.log一点颜色看看</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2017-07-03T15:44:15.000Z" itemprop="datePublished">七月 3, 2017, 11:44 晚上</time>

          
            × <span class="article-word-count">302 words</span>
            
            × <span class="article-time-to-read">1 minute</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>开发中少不了使用console.log进行调试，那么如何使打印出的内容具有颜色呢？</p>
<p>首先要说明的是，这里指的打印是在命令行中进行输出的，而不是在chrome控制台中。</p>
<p>答案是，把console.log()第一个参数设置为ANSI转义码即可, 第二个参数为需要打印的内容。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 像这样</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\x1b[31m&quot;</span>, <span class="string">&quot;I&#x27;m green.&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当然，聪明而又懒惰的我们不会一个一个去敲这些字符，真是光看看就觉得麻烦啊，So...</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">FgRed</span> = <span class="string">&quot;\x1b[31m&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">FgRed</span>, <span class="string">&quot;I&#x27;m red.&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 真是雕虫小技啊:P</span></span><br><span class="line"><span class="comment">// 这里还有有更多的颜色</span></span><br><span class="line"><span class="title class_">Reset</span> = <span class="string">&quot;\x1b[0m&quot;</span>,</span><br><span class="line"><span class="title class_">Bright</span> = <span class="string">&quot;\x1b[1m&quot;</span>,</span><br><span class="line"><span class="title class_">Dim</span> = <span class="string">&quot;\x1b[2m&quot;</span>,</span><br><span class="line"><span class="title class_">Underscore</span> = <span class="string">&quot;\x1b[4m&quot;</span>,</span><br><span class="line"><span class="title class_">Blink</span> = <span class="string">&quot;\x1b[5m&quot;</span>,</span><br><span class="line"><span class="title class_">Reverse</span> = <span class="string">&quot;\x1b[7m&quot;</span>,</span><br><span class="line"><span class="title class_">Hidden</span> = <span class="string">&quot;\x1b[8m&quot;</span>,</span><br><span class="line"><span class="title class_">FgBlack</span> = <span class="string">&quot;\x1b[30m&quot;</span>,</span><br><span class="line"><span class="title class_">FgRed</span> = <span class="string">&quot;\x1b[31m&quot;</span>,</span><br><span class="line"><span class="title class_">FgGreen</span> = <span class="string">&quot;\x1b[32m&quot;</span>,</span><br><span class="line"><span class="title class_">FgYellow</span> = <span class="string">&quot;\x1b[33m&quot;</span>,</span><br><span class="line"><span class="title class_">FgBlue</span> = <span class="string">&quot;\x1b[34m&quot;</span>,</span><br><span class="line"><span class="title class_">FgMagenta</span> = <span class="string">&quot;\x1b[35m&quot;</span>,</span><br><span class="line"><span class="title class_">FgCyan</span> = <span class="string">&quot;\x1b[36m&quot;</span>,</span><br><span class="line"><span class="title class_">FgWhite</span> = <span class="string">&quot;\x1b[37m&quot;</span>,</span><br><span class="line"><span class="title class_">BgBlack</span> = <span class="string">&quot;\x1b[40m&quot;</span>,</span><br><span class="line"><span class="title class_">BgRed</span> = <span class="string">&quot;\x1b[41m&quot;</span>,</span><br><span class="line"><span class="title class_">BgGreen</span> = <span class="string">&quot;\x1b[42m&quot;</span>,</span><br><span class="line"><span class="title class_">BgYellow</span> = <span class="string">&quot;\x1b[43m&quot;</span>,</span><br><span class="line"><span class="title class_">BgBlue</span> = <span class="string">&quot;\x1b[44m&quot;</span>,</span><br><span class="line"><span class="title class_">BgMagenta</span> = <span class="string">&quot;\x1b[45m&quot;</span>,</span><br><span class="line"><span class="title class_">BgCyan</span> = <span class="string">&quot;\x1b[46m&quot;</span>,</span><br><span class="line"><span class="title class_">BgWhite</span> = <span class="string">&quot;\x1b[47m&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>拓展阅读:<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/ANSI_escape_code">ANSI escape code</a></p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-JS野生程序员进修指南" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2017/05/15/JS%E9%87%8E%E7%94%9F%E7%A8%8B%E5%BA%8F%E5%91%98%E8%BF%9B%E4%BF%AE%E6%8C%87%E5%8D%97/">JS野生程序员进修指南</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2017-05-15T13:08:00.000Z" itemprop="datePublished">五月 15, 2017, 9:08 晚上</time>

          
            × <span class="article-word-count">855 words</span>
            
            × <span class="article-time-to-read">3 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <h3 id="基本"><a href="#基本" class="headerlink" title="基本"></a>基本</h3><p><code>缩进</code><br>4个空格，而不是一个制表符</p>
<p><code>结尾</code><br>分号结尾</p>
<p><code>行长度</code><br>80个字符</p>
<p><code>换行</code><br>符号结尾，第二行追加2单位(8字符)缩进</p>
<p><code>空行</code></p>
<ul>
<li>方法之间</li>
<li>方法中局部变量和第一条语句之间</li>
<li>注释之前</li>
<li>逻辑片段之间</li>
</ul>
<p><code>命名</code></p>
<ul>
<li>Camel Case</li>
<li>变量前缀为名词</li>
<li>函数前缀为动词</li>
<li>表数量 count, length, size</li>
<li>循环体 i, j, k</li>
<li>常量使用大写字母，下划线分隔单词</li>
<li>构造函数使用Pascal Case</li>
</ul>
<p><code>函数名参考</code></p>
<table>
<thead>
<tr>
<th>动词</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>can</td>
<td>返回布尔值</td>
</tr>
<tr>
<td>has</td>
<td>返回布尔值</td>
</tr>
<tr>
<td>is</td>
<td>返回布尔值</td>
</tr>
<tr>
<td>get</td>
<td>返回非布尔值</td>
</tr>
<tr>
<td>set</td>
<td>保存一个值</td>
</tr>
</tbody></table>
<p><code>直接量</code></p>
<ul>
<li>字符串 单引号、双引号皆可</li>
<li>数字，不使用八进制；不以小数点结尾</li>
</ul>
<p><code>null</code></p>
<ul>
<li>对象占位符</li>
<li>不要 检测是否传入某个参数</li>
<li>不要 检测一个未初始化的变量</li>
</ul>
<p><code>undefined</code><br>未被初始化的变量初始值</p>
<p><code>对象直接量</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不好的写法</span></span><br><span class="line"><span class="keyword">var</span> book = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">book.<span class="property">title</span> = <span class="string">&quot;JavaScript&quot;</span>;</span><br><span class="line">book.<span class="property">author</span> = <span class="string">&quot;Mike&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//好的写法</span></span><br><span class="line"><span class="keyword">var</span> book = &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;JavaScript&quot;</span>,</span><br><span class="line">    <span class="attr">author</span>: <span class="string">&quot;Mike&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>数组直接量</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不好的写法</span></span><br><span class="line"><span class="keyword">var</span> colors = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="string">&quot;red&quot;</span>, <span class="string">&quot;blue&quot;</span>, <span class="string">&quot;green&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> numbers = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//好的写法</span></span><br><span class="line"><span class="keyword">var</span> colors = [<span class="string">&quot;red&quot;</span>, <span class="string">&quot;blue&quot;</span>, <span class="string">&quot;green&quot;</span>];</span><br><span class="line"><span class="keyword">var</span> numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br></pre></td></tr></table></figure>

<h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><p><code>单行注释</code><br>&#x2F;&#x2F;something</p>
<ul>
<li>独占一行，解释下一行，注释前留一空行，缩进与下一行保持一致</li>
<li>尾部注释与代码保持一单位缩进，不应超过最大长度限制</li>
</ul>
<p><code>多行注释</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 第一行注释</span></span><br><span class="line"><span class="comment"> * 第二行注释</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p><code>注释时机</code></p>
<ul>
<li>难于理解的代码</li>
<li>可能被理解错误的代码</li>
<li>浏览器兼容性</li>
</ul>
<p><code>文档注释</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">这是一个文档注释</span></span><br><span class="line"><span class="comment">**/</span></span><br></pre></td></tr></table></figure>

<h3 id="语句和表达式"><a href="#语句和表达式" class="headerlink" title="语句和表达式"></a>语句和表达式</h3><p><code>基本</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//好的写法</span></span><br><span class="line"><span class="keyword">if</span> (condition) &#123;</span><br><span class="line">    <span class="title function_">doSomething</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//不好的写法</span></span><br><span class="line"><span class="keyword">if</span> (condition)</span><br><span class="line">    <span class="title function_">doSomething</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (condition) <span class="title function_">doSomething</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (condition) &#123; <span class="title function_">doSomething</span>(); &#125;</span><br></pre></td></tr></table></figure>
<p>缩进应对齐<br>所有块语句都应使用花括号</p>
<ul>
<li>if</li>
<li>for</li>
<li>while</li>
<li>do…while…</li>
<li>try…catch…finally</li>
</ul>
<p><code>花括号对齐方式</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//好的写法</span></span><br><span class="line"><span class="keyword">if</span> (condition) &#123;</span><br><span class="line">    <span class="title function_">doSomething</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">doSomethingElse</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//不好的写法</span></span><br><span class="line"><span class="keyword">if</span> (condition)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_">doSomething</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_">doSomethingElse</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>块语句间隔</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//好的写法</span></span><br><span class="line"><span class="keyword">if</span> (condition) &#123;</span><br><span class="line">    <span class="title function_">doSomething</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//不好的写法</span></span><br><span class="line"><span class="keyword">if</span>(condition)&#123;</span><br><span class="line">    <span class="title function_">doSomething</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( condition ) &#123;</span><br><span class="line">    <span class="title function_">doSomething</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>switch</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>(condition) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;first&quot;</span>:</span><br><span class="line">         <span class="comment">//代码</span></span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;second&quot;</span>:</span><br><span class="line">         <span class="comment">//代码</span></span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;third&quot;</span>:</span><br><span class="line">         <span class="comment">//代码</span></span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">         <span class="comment">//代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>with</code><br>禁用</p>
<p><code>for</code><br>避免使用continue</p>
<p><code>for-in</code><br>不应遍历数组</p>
<h3 id="变量、函数和运算符"><a href="#变量、函数和运算符" class="headerlink" title="变量、函数和运算符"></a>变量、函数和运算符</h3><p><code>变量声明</code></p>
<ul>
<li>注意提升机制</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//好的写法</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">doSomethingWithItems</span>(<span class="params">items</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> value = <span class="number">10</span>,</span><br><span class="line">        result = value + <span class="number">10</span>,</span><br><span class="line">        i,</span><br><span class="line">        len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>, len=items.<span class="property">length</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="title function_">doSomething</span>(items[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>函数声明</code></p>
<ul>
<li>先定义后使用</li>
<li>不应在块语句内定义</li>
<li>函数名与左括号间无空格</li>
</ul>
<p><code>立即调用函数</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//好的写法</span></span><br><span class="line"><span class="keyword">var</span> value = (<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">//函数体</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;Done&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;());</span><br></pre></td></tr></table></figure>

<p><code>严格模式</code></p>
<ul>
<li>应在函数体内使用，而非全局</li>
</ul>
<p><code>相等</code></p>
<ul>
<li>应使用 ‘&#x3D;&#x3D;&#x3D;’, ‘!&#x3D;&#x3D;’, 而不是 ‘&#x3D;&#x3D;’, ‘!&#x3D;’</li>
</ul>
<p><code>eval()</code></p>
<ul>
<li>避免使用 eval(), Function<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不好的写法</span></span><br><span class="line"><span class="keyword">var</span> myfunc = <span class="keyword">new</span> <span class="title class_">Function</span>(<span class="string">&quot;alert(&#x27;Hi!&#x27;)&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="string">&quot;document.body.style.background=&#x27;red&#x27;&quot;</span>, <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="string">&quot;document.title = &#x27;It is now&#x27;&quot;</span> + (<span class="keyword">new</span> <span class="title class_">Date</span>()), <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//而应使用匿名函数代替</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">style</span>.<span class="property">background</span>=<span class="string">&#x27;red&#x27;</span>;</span><br><span class="line">&#125;, <span class="number">50</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<p><code>原始包装类型</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不好的写法</span></span><br><span class="line"><span class="keyword">var</span> name = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;Mike&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> author = <span class="keyword">new</span> <span class="title class_">Boolean</span>(ture);</span><br><span class="line"><span class="keyword">var</span> count = <span class="keyword">new</span> <span class="title class_">Number</span>(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-码农札记" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2017/05/15/%E7%A0%81%E5%86%9C%E6%9C%AD%E8%AE%B0/">码农札记</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2017-05-15T13:00:00.000Z" itemprop="datePublished">五月 15, 2017, 9:00 晚上</time>

          
            × <span class="article-word-count">1.4k words</span>
            
            × <span class="article-time-to-read">6 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <h3 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h3><h4 id="日常操作"><a href="#日常操作" class="headerlink" title="日常操作"></a>日常操作</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取远端代码</span></span><br><span class="line">git fetch upstream xxxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将远端代码合并到本地</span></span><br><span class="line">git merge upstream/xxxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取并合并代码</span></span><br><span class="line">git pull</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看不同(工作区与暂存区)</span></span><br><span class="line">git diff</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看工作区修改的文件</span></span><br><span class="line">git status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 放弃工作区的修改</span></span><br><span class="line">git checkout</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将修改的文件提交到暂存区</span></span><br><span class="line">git add</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交更改</span></span><br><span class="line">git commit -m <span class="string">&quot;# 注释&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交到远端</span></span><br><span class="line">git push origin xxxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看提交日志</span></span><br><span class="line">git <span class="built_in">log</span> (--pretty=oneline)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 版本回退</span></span><br><span class="line">git reset --hard HEAD^   <span class="comment"># 上一个版本</span></span><br><span class="line">git reset --hard HEAD^^  <span class="comment"># 上上一个版本</span></span><br><span class="line">git reset --hard HEAD~20 <span class="comment"># 上20个版本</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 回到未来</span></span><br><span class="line">git reflog</span><br><span class="line">git reset</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除文件</span></span><br><span class="line">git <span class="built_in">rm</span></span><br><span class="line">git commit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并一个commit</span></span><br><span class="line">git cherry-pick [commitId]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改上一次commit注释</span></span><br><span class="line">git commit --amend -m <span class="string">&#x27;# 新的注释&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示将要删除的文件</span></span><br><span class="line">git clean -n</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除没有track的文件，不包含.gitignore</span></span><br><span class="line">git clean -f</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除指定路径下没有track的文件</span></span><br><span class="line">git clean -f &lt;path&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除当前目录下没有track的文件和文件夹</span></span><br><span class="line">git clean -fd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暂存更改</span></span><br><span class="line">git stash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 弹出暂存</span></span><br><span class="line">git stash pop</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 远程仓库</span></span><br><span class="line"><span class="comment"># 创建SSH KEY</span></span><br><span class="line"><span class="comment"># 用户目录 .ssh/</span></span><br><span class="line"><span class="comment"># id_rsa 私钥</span></span><br><span class="line"><span class="comment"># id_rsa.pub 公钥</span></span><br><span class="line">ssh-keygen -t rsa -C <span class="string">&quot;my@email.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在Github上 Add SSH Key, 粘贴公钥内容</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 克隆远端代码</span></span><br><span class="line">git <span class="built_in">clone</span> some_url</span><br></pre></td></tr></table></figure>

<h4 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建并切换到分支</span></span><br><span class="line">git checkout -b dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 等同于</span></span><br><span class="line">git branch dev</span><br><span class="line">git checkout dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看分支</span></span><br><span class="line">git branch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并分支</span></span><br><span class="line">git merge</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除分支</span></span><br><span class="line">git branch -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看分支合并图</span></span><br><span class="line">git <span class="built_in">log</span> --graph</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分支策略</span></span><br><span class="line">git merge --no-ff -m <span class="string">&quot;注释&quot;</span> dev</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Bug分支</span></span><br><span class="line"><span class="comment"># 暂存修改</span></span><br><span class="line">git stash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回到master，并创建新分支，修复后提交</span></span><br><span class="line">git checkout master</span><br><span class="line">git checkout -b issue-101</span><br><span class="line">git commit -m <span class="string">&quot;fix-issue-101&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并bug分支并删除</span></span><br><span class="line">git checkout master</span><br><span class="line">git merge --no-ff -m <span class="string">&quot;m-merge-issue-101&quot;</span> issue-101</span><br><span class="line">git branch -d issue-101</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将修复bug后的master合并到dev</span></span><br><span class="line">git checkout dev</span><br><span class="line">git merge --no-ff -m <span class="string">&quot;dev-merge-m&quot;</span> master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 弹出暂存的修改</span></span><br><span class="line">git stash pop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修复冲突</span></span><br><span class="line">git commit -m <span class="string">&quot;fixconflict &amp; append something&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 完成后提交</span></span><br><span class="line">git checkout master</span><br><span class="line">git merge --no-ff -m <span class="string">&quot;m-merge-dev&quot;</span> dev</span><br><span class="line">git branch -d dev</span><br></pre></td></tr></table></figure>
<h4 id="标签管理"><a href="#标签管理" class="headerlink" title="标签管理"></a>标签管理</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建标签，默认HEAD，也可指定commit id</span></span><br><span class="line">git tag &lt;name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定标签信息</span></span><br><span class="line">git tag -a &lt;tagname&gt; -m <span class="string">&quot;message&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PGP签名标签</span></span><br><span class="line">git tag -s &lt;tagname&gt; -m <span class="string">&quot;message&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有标签</span></span><br><span class="line">git tag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送本地标签</span></span><br><span class="line">git push origin &lt;tagname&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送全部本地未推送的标签</span></span><br><span class="line">git push origin --tags</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除一个本地标签</span></span><br><span class="line">git tag -d &lt;tagname&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除一个远程标签</span></span><br><span class="line">git push origin :refs/tags/&lt;tagname&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><h4 id="文件命令"><a href="#文件命令" class="headerlink" title="文件命令"></a>文件命令</h4><table>
<thead>
<tr>
<th>命令</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>ls</td>
<td>列出目录</td>
</tr>
<tr>
<td>ls -al</td>
<td>使用格式化列出隐藏文件</td>
</tr>
<tr>
<td>cd dir</td>
<td>更改目录到dir</td>
</tr>
<tr>
<td>cd</td>
<td>更改到home目录</td>
</tr>
<tr>
<td>pwd</td>
<td>显示当前目录</td>
</tr>
<tr>
<td>mkdir dir</td>
<td>创建目录dir</td>
</tr>
<tr>
<td>rm file</td>
<td>删除file</td>
</tr>
<tr>
<td>rm -r dir</td>
<td>删除目录dir</td>
</tr>
<tr>
<td>rm -f file</td>
<td>强制删除file</td>
</tr>
<tr>
<td>rm -rf dir</td>
<td>强制删除目录dir</td>
</tr>
<tr>
<td>cp file1 file2</td>
<td>将file1复制到file2</td>
</tr>
<tr>
<td>cp -r dir1 dir2</td>
<td>将file1复制到dir2，如果dir2不存在则创建它</td>
</tr>
<tr>
<td>mv file1 file2</td>
<td>将file1重命名或移动到file2，若file2存在则移动</td>
</tr>
<tr>
<td>ln -s file link</td>
<td>创建file的符号连接link</td>
</tr>
<tr>
<td>touch file</td>
<td>创建file</td>
</tr>
<tr>
<td>cat &gt; file</td>
<td>将标准输入添加到file</td>
</tr>
<tr>
<td>more file</td>
<td>查看file的内容</td>
</tr>
<tr>
<td>head file</td>
<td>查看file的前10行</td>
</tr>
<tr>
<td>tail file</td>
<td>查看file的后10行</td>
</tr>
<tr>
<td>tail -f file</td>
<td>从后10行开始查看file的内容</td>
</tr>
</tbody></table>
<h4 id="进程管理"><a href="#进程管理" class="headerlink" title="进程管理"></a>进程管理</h4><table>
<thead>
<tr>
<th>命令</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>ps</td>
<td>显示当前的活动进程</td>
</tr>
<tr>
<td>top</td>
<td>显示所有正在运行的进程</td>
</tr>
<tr>
<td>kill pid</td>
<td>杀掉进程id pid</td>
</tr>
<tr>
<td>killall proc</td>
<td>杀掉所有名为proc的进程</td>
</tr>
<tr>
<td>bg</td>
<td>列出已停止或后台的作业</td>
</tr>
<tr>
<td>fg</td>
<td>将最近的作业带到前台</td>
</tr>
<tr>
<td>fg n</td>
<td>将作业n带到前台</td>
</tr>
</tbody></table>
<h4 id="文件权限"><a href="#文件权限" class="headerlink" title="文件权限"></a>文件权限</h4><table>
<thead>
<tr>
<th>命令</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>chmod octal file</td>
<td>更改file的权限</td>
</tr>
</tbody></table>
<ul>
<li>4 读（r）</li>
<li>2 写（w）</li>
<li>1 执行（x）</li>
</ul>
<h4 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h4><table>
<thead>
<tr>
<th>命令</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>ssh user@host</td>
<td>以user用户连接到host</td>
</tr>
<tr>
<td>ssh -p port user@host</td>
<td>在端口port以user用户身份连接到host</td>
</tr>
<tr>
<td>ssh-copy-id user@host</td>
<td>将密钥添加到host以实现无密码登录</td>
</tr>
</tbody></table>
<h4 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h4><table>
<thead>
<tr>
<th>命令</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>grep pattern files</td>
<td>搜索files中匹配pattern的内容</td>
</tr>
<tr>
<td>grep -r pattern dir</td>
<td>递归搜索dir中匹配pattern的内容</td>
</tr>
<tr>
<td>command l grep pattern</td>
<td>搜索command输出中匹配pattern的内容</td>
</tr>
</tbody></table>
<h4 id="系统信息"><a href="#系统信息" class="headerlink" title="系统信息"></a>系统信息</h4><table>
<thead>
<tr>
<th>命令</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>date</td>
<td>显示当前日期和时间</td>
</tr>
<tr>
<td>cal</td>
<td>显示当月的日历</td>
</tr>
<tr>
<td>uptime</td>
<td>显示系统从开机到现在所运行的时间</td>
</tr>
<tr>
<td>w</td>
<td>显示登录的用户</td>
</tr>
<tr>
<td>whoami</td>
<td>查看你的当前用户名</td>
</tr>
<tr>
<td>finger user</td>
<td>显示user的相关信息</td>
</tr>
<tr>
<td>uname -a</td>
<td>显示内核信息</td>
</tr>
<tr>
<td>cat &#x2F;proc&#x2F;cpuinfo</td>
<td>查看cpu的信息</td>
</tr>
<tr>
<td>cat &#x2F;proc&#x2F;meminfo</td>
<td>查看内存信息</td>
</tr>
<tr>
<td>man command</td>
<td>显示command的说明手册</td>
</tr>
<tr>
<td>df</td>
<td>显示磁盘占用情况</td>
</tr>
<tr>
<td>du</td>
<td>显示目录空间占用情况</td>
</tr>
<tr>
<td>free</td>
<td>显示内存及交换区占用情况</td>
</tr>
</tbody></table>
<h4 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h4><table>
<thead>
<tr>
<th>命令</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>tar cf file.tar files</td>
<td>创建包含files的tar文件file.tar</td>
</tr>
<tr>
<td>tar xf file.tar</td>
<td>从file.tar提取文件</td>
</tr>
<tr>
<td>tar czf file.tar.gz files</td>
<td>使用Gzip压缩创建tar文件</td>
</tr>
<tr>
<td>tar xzf file.tar.gz</td>
<td>使用Gzip提取tar文件</td>
</tr>
<tr>
<td>tar cjf file.tar.bz2</td>
<td>使用Bzip2压缩创建tar文件</td>
</tr>
<tr>
<td>tar xjf file.tar.bz2</td>
<td>使用Bzip2提取tar文件</td>
</tr>
<tr>
<td>gzip file</td>
<td>压缩file并重命名为file.gz</td>
</tr>
<tr>
<td>gzip -d file.gz</td>
<td>将file.gz解压缩为file</td>
</tr>
</tbody></table>
<h4 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h4><table>
<thead>
<tr>
<th>命令</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>ping host</td>
<td>ping host并输出结果</td>
</tr>
<tr>
<td>whois domain</td>
<td>获取domain的whois信息</td>
</tr>
<tr>
<td>dig domain</td>
<td>获取domain的DNS信息</td>
</tr>
<tr>
<td>dig -x host</td>
<td>逆向查询host</td>
</tr>
<tr>
<td>wget file</td>
<td>下载file</td>
</tr>
<tr>
<td>wget -c file</td>
<td>断点续传</td>
</tr>
</tbody></table>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>从源代码安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line">dpkg -i pkg.deb</span><br><span class="line">rpm -Uvh pkg.rpm</span><br></pre></td></tr></table></figure>

<h4 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h4><table>
<thead>
<tr>
<th>命令</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>Ctrl + C</td>
<td>停止当前命令</td>
</tr>
<tr>
<td>Ctrl + Z</td>
<td>停止当前命令，并使用fg恢复</td>
</tr>
<tr>
<td>Ctrl + D</td>
<td>注销当前会话，与exit相似</td>
</tr>
<tr>
<td>Ctrl + W</td>
<td>删除当前行中的字</td>
</tr>
<tr>
<td>Ctrl + U</td>
<td>删除整行</td>
</tr>
<tr>
<td>!!</td>
<td>重复上次的命令</td>
</tr>
<tr>
<td>exit</td>
<td>注销当前会话</td>
</tr>
</tbody></table>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-Composer搭建MVC框架" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2017/03/30/Composer%E6%90%AD%E5%BB%BAMVC%E6%A1%86%E6%9E%B6/">Composer搭建MVC框架</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2017-03-30T03:11:28.000Z" itemprop="datePublished">三月 30, 2017, 11:11 上午</time>

          
            × <span class="article-word-count">1.7k words</span>
            
            × <span class="article-time-to-read">7 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <blockquote>
<p>Composer是一个依赖管理工具，利用PSR标准和PHP命名空间的特性，构造出繁荣的PHP生态系统。</p>
</blockquote>
<h3 id="Composer是什么？"><a href="#Composer是什么？" class="headerlink" title="Composer是什么？"></a>Composer是什么？</h3><p><strong>先从别处摘抄一段简介，感受一下Composer的功能。</strong><br>Composer不是一个包管理器。它涉及”pachages”和”libraries”，但它在每个项目的基础上进行管理，在你项目的某个目录中（例如vendor）进行安装。默认情况下它不会在全局安装任何东西。因此，这仅仅是一个依赖管理。</p>
<p>这种想法并不新鲜，Composer受到了node’s npm和ruby’s bundler的强烈启发。而当时PHP下并没有类似的工具。</p>
<p>Composer将这样为你解决问题：</p>
<p>1.你有一个项目依赖于若干个库。<br>2.其中一些库依赖于其他库。<br>3.你声明你所依赖的东西。<br>4.Composer会找出哪个版本的包需要安装，并安装它们（将他们下载到你的项目中）。</p>
<p>好了，了解功能之后，lets coding！</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><h4 id="Composer安装"><a href="#Composer安装" class="headerlink" title="Composer安装"></a>Composer安装</h4><p><a target="_blank" rel="noopener" href="http://docs.phpcomposer.com/00-intro.html#Installation-Windows">百度一下</a></p>
<h4 id="建立项目"><a href="#建立项目" class="headerlink" title="建立项目"></a>建立项目</h4><p>在一个目录下建立文件夹，名字就叫smvc(simple mvc)吧。<br>在文件夹下新建文件composer.json:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;require&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line"></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>在此目录下，开启命令行运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer update</span><br></pre></td></tr></table></figure>
<p>几秒钟后会生成以下文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">|--vendor/</span><br><span class="line">|	|--scrapy.cfg</span><br><span class="line">|	|	|--autoload_classmap.php</span><br><span class="line">|	|	|--autoload_namespaces.php</span><br><span class="line">|	|	|--autoload_psr4.php</span><br><span class="line">|	|	|--autoload_real.php</span><br><span class="line">|	|	|--autoload_static.php</span><br><span class="line">|	|	|--ClassLoader.php</span><br><span class="line">|	|	|--installed.json</span><br><span class="line">|	|	|--LICENSE</span><br><span class="line">|	|--autoload.php</span><br><span class="line">|--composer.json</span><br></pre></td></tr></table></figure>
<p>OK,准备工作完成，可以开工了。</p>
<h3 id="MVC搭建"><a href="#MVC搭建" class="headerlink" title="MVC搭建"></a>MVC搭建</h3><p>在上一篇文章中<a href="https://catinsides.github.io/catinsides.github.io/2017/01/26/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E8%87%AA%E5%B7%B1%E7%9A%84MVC%E6%A1%86%E6%9E%B6/">如何编写自己的MVC框架</a>已经简单介绍了MVC框架的结构和运作流程。所以不多废话，直接按照MVC的思路逐步搭建出一个小型的MVC框架。</p>
<h4 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h4><p>既然用了Composer，就不需要像之前一样自己手动撸代码了，而是直接到全球最大同性交友平台Github搜索关键字router，<a target="_blank" rel="noopener" href="https://github.com/search?l=PHP&q=router&type=Repositories&utf8=%E2%9C%93">搜一下</a><br>选择一个契(xi)合(huan)项目的包，使用composer进行下载。这里我选择的是klein&#x2F;klein.php(a fast&amp;flexible router)。没有什么特殊的理由，只是因为出现在了首页，并且stars数量最多而已。<br>然后打开composer.json，添加安装信息（一般情况下会列在开发者文档中）:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;require&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;klein/klein&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dev-master&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>然后再命令行中运行<code>composer update</code>,等待安装下载完成，速度视网络情况而定。<br>安装完成后，会在<code>vender</code>文件夹生成相关目录。<br>在根目录下建立入口文件<code>index.php</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//自动加载</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;./vendor/autoload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//载入路由文件</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;./core/routes.php&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>然后新建文件夹core，在里面新建routes.php，使用刚才下载的路由包:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$klein</span> = <span class="keyword">new</span> <span class="title class_">\Klein\Klein</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$klein</span>-&gt;<span class="title function_ invoke__">respond</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/hello&#x27;</span>, function () &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&quot;hello world!&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable">$klein</span>-&gt;<span class="title function_ invoke__">dispatch</span>();</span><br></pre></td></tr></table></figure>
<p>打开wamp在本地测试一下能否成功运行。点击Localhost后自动打开浏览器，在地址栏地址后输入<code>/hello</code>会出现hello world！字样，OK运行成功。其实每个包的作者都会在项目中写出详细的开发文档，只要按照给定的API设定好路由即可。在这里以能够实现数据库常用的增删改查为目标构建出这个小型框架。</p>
<p>根据逻辑重构路由文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$klein</span> = <span class="keyword">new</span> <span class="title class_">\Klein\Klein</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//设定默认主页，各项请求在这里完成</span></span><br><span class="line"><span class="variable">$klein</span>-&gt;<span class="title function_ invoke__">respond</span>(function () &#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="string">&#x27;./tpl/index.php&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//将路由指向控制器文件</span></span><br><span class="line"><span class="variable">$klein</span>-&gt;<span class="title function_ invoke__">respond</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/create&#x27;</span>, function () &#123;</span><br><span class="line">   <span class="title class_">Controller</span>::<span class="title function_ invoke__">create</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable">$klein</span>-&gt;<span class="title function_ invoke__">respond</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/update&#x27;</span>, function () &#123;</span><br><span class="line">   <span class="title class_">Controller</span>::<span class="title function_ invoke__">update</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable">$klein</span>-&gt;<span class="title function_ invoke__">respond</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/retrieve&#x27;</span>, function () &#123;</span><br><span class="line">   <span class="title class_">Controller</span>::<span class="title function_ invoke__">retrieve</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable">$klein</span>-&gt;<span class="title function_ invoke__">respond</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/delete&#x27;</span>, function () &#123;</span><br><span class="line">   <span class="title class_">Controller</span>::<span class="title function_ invoke__">delete</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable">$klein</span>-&gt;<span class="title function_ invoke__">dispatch</span>();</span><br></pre></td></tr></table></figure>

<h4 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h4><p>在根目录创建文件夹config，新建config.php文件写入数据库配置信息：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;DB_HOST&quot;</span>, <span class="string">&quot;localhost&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;DB_USER&quot;</span>, <span class="string">&quot;root&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;DB_PASSWORD&quot;</span>, <span class="string">&quot;1234&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;DB_NAME&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>在core文件夹创建基本的模型类Model.php,在里面使用PDO编写基本的数据库操作。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">//引入数据库配置文件</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;./config/config.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> <span class="variable">$_dbHandle</span>;</span><br><span class="line">	<span class="keyword">protected</span> <span class="variable">$_table</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$table</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span> -&gt;<span class="title function_ invoke__">connect</span>(DB_HOST, DB_USER, DB_PASSWORD, DB_NAME);</span><br><span class="line">		<span class="variable language_">$this</span> -&gt;_table = <span class="variable">$table</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"><span class="variable">$host</span>, <span class="variable">$user</span>, <span class="variable">$pass</span>, <span class="variable">$dbname</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable">$dsn</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;mysql:host=%s;dbname=%s;charset=utf8&quot;</span>, <span class="variable">$host</span>, <span class="variable">$dbname</span>);</span><br><span class="line">            <span class="variable">$option</span> = <span class="keyword">array</span>(PDO::<span class="variable constant_">ATTR_DEFAULT_FETCH_MODE</span> =&gt; PDO::<span class="variable constant_">FETCH_ASSOC</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;_dbHandle = <span class="keyword">new</span> <span class="title function_ invoke__">PDO</span>(<span class="variable">$dsn</span>, <span class="variable">$user</span>, <span class="variable">$pass</span>, <span class="variable">$option</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PDOException <span class="variable">$e</span>) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">&#x27;Wrong: &#x27;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$sql</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;SELECT * FROM %s&quot;</span>, <span class="variable">$this</span>-&gt;_table);</span><br><span class="line">        <span class="variable">$sth</span> = <span class="variable language_">$this</span>-&gt;_dbHandle-&gt;<span class="title function_ invoke__">prepare</span>(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="variable">$sth</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$sth</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params"><span class="variable">$id</span>, <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$sql</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;INSERT INTO %s(id, name) VALUES (%d, &#x27;%s&#x27;)&quot;</span>, <span class="variable">$this</span>-&gt;_table, <span class="variable">$id</span>, <span class="variable">$data</span>);</span><br><span class="line">        <span class="variable language_">$this</span> -&gt;_dbHandle-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span>(<span class="params"><span class="variable">$id</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    	<span class="variable">$sql</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;DELETE FROM %s WHERE `id` = %d&quot;</span>, <span class="variable">$this</span>-&gt;_table, <span class="variable">$id</span>);</span><br><span class="line">        <span class="variable">$sth</span> = <span class="variable language_">$this</span>-&gt;_dbHandle-&gt;<span class="title function_ invoke__">prepare</span>(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="variable">$sth</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"><span class="variable">$id</span>, <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    	<span class="variable">$sql</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;UPDATE %s SET name = &#x27;%s&#x27; WHERE `id` = %d&quot;</span>, <span class="variable">$this</span>-&gt;_table, <span class="variable">$data</span>, <span class="variable">$id</span>);</span><br><span class="line">        <span class="variable language_">$this</span> -&gt;_dbHandle-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据库文件编写完成。</p>
<h4 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h4><p>在core文件夹新建控制器类Controller.php,在其内部使用Model.php与数据库进行连接:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Controller</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable">$model</span> = <span class="keyword">new</span> <span class="title class_">Model</span>(<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">		<span class="variable">$model</span> -&gt;<span class="title function_ invoke__">add</span>(<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Mike&#x27;</span>);</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;插入成功！&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable">$model</span> = <span class="keyword">new</span> <span class="title class_">Model</span>(<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">		<span class="variable">$model</span> -&gt;<span class="title function_ invoke__">update</span>(<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;John&#x27;</span>);</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;更新成功！&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">retrieve</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable">$model</span> = <span class="keyword">new</span> <span class="title class_">Model</span>(<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">		<span class="variable">$results</span> = <span class="variable">$model</span> -&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line">		<span class="title function_ invoke__">extract</span>(<span class="variable">$results</span>);</span><br><span class="line">		<span class="keyword">require</span> <span class="string">&quot;./tpl/index.php&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable">$model</span> = <span class="keyword">new</span> <span class="title class_">Model</span>(<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">		<span class="variable">$model</span> -&gt;<span class="title function_ invoke__">delete</span>(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;删除成功！&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `test`(</span><br><span class="line">	`id` <span class="type">int</span>(<span class="number">1</span>),</span><br><span class="line">	`name` <span class="type">varchar</span>(<span class="number">5</span>)</span><br><span class="line">)ENGINE<span class="operator">=</span>Innodb <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="自动加载"><a href="#自动加载" class="headerlink" title="自动加载"></a>自动加载</h4><p>类文件编写完成后，如果在首页测试会出现找不到相关类的错误。因为还没有在composer.json中设置为自动加载，所以在文件中添加字段，最终代码为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;require&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;klein/klein&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dev-master&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;autoload&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;classmap&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">			<span class="string">&quot;core&quot;</span></span><br><span class="line">		<span class="punctuation">]</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这个MVC框架的视图层没有特别复杂的实现，而是直接采用了加载文件，输出变量的方式。<br>至此，这个框架的基本要求已经全部实现了。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>在本文中，简单利用了composer的下载和自动加载类的功能，实现了MVC框架。虽然这个框架瘦骨嶙峋到几乎只有骨骼……代码还有非常大的优化和拓展空间。而这些就可以用composer强大的依赖管理来实现。比如项目中需要一个验证码的功能，只需要下载并注册到composer.json中，然后正确引入即可使用。Composer这些功能特性极大方便了PHP开发者的快速开发。</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-SCRAPY爬取智联招聘信息" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2017/02/07/SCRAPY%E7%88%AC%E5%8F%96%E6%99%BA%E8%81%94%E6%8B%9B%E8%81%98%E4%BF%A1%E6%81%AF/">SCRAPY爬取智联招聘信息</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2017-02-07T05:41:00.000Z" itemprop="datePublished">二月 7, 2017, 1:41 下午</time>

          
            × <span class="article-word-count">2k words</span>
            
            × <span class="article-time-to-read">8 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>网上找工作这件事，首先要登录主站搜索职位名称，然后在一大串列表里逐个查看职位需求，查看完毕关闭页面，再打开新页面，想一想都觉得是费心费力的一件事。俗话说：“磨刀不误砍柴工”，再加上自己懒癌发作，心想着一定要一劳永逸的解决这件事。正好SCRAPY框架能派上用场，大致整理了一下思路开始撸代码。</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>根据文章开头部分的话，可以整理出<code>网上找工作</code>这一系列动作的流程</p>
<ol>
<li>打开主站搜索<code>职位</code>，并选择<code>地点</code></li>
<li>网站返回一系列<code>&lt;li&gt;&lt;a&gt;职位名称&lt;/a&gt;&lt;/li&gt;</code></li>
<li>点击<code>&lt;a&gt;</code>进入详情页，里面包含着职位和公司的详细信息</li>
<li>查看完毕后关闭，换下一个<code>&lt;a&gt;</code></li>
</ol>
<p>好了，流程整理好了，怎么实现呢？<br>显然第一步打开网站获取网页信息可以使用<code>urllib</code>或者<code>requests</code>模块，第二步提取<code>URL</code>信息交给<code>re</code>和<code>BeautifulSoup</code>处理，第三步使用<code>SCRAPY</code>处理第二步获取的<code>URL</code>到逐个页面提取职位详细信息，使用<code>SCRAPY</code>内置的<code>xpath</code>即可。<br>思路整理完毕，let’s coding!</p>
<h3 id="获取URL"><a href="#获取URL" class="headerlink" title="获取URL"></a>获取URL</h3><p>秉着模块化的精神，我把提取URL这一部分单独写一个文件，然后在<code>SCRAPY</code>调用。这样不仅方便调试，还能减少<code>SCRAPY</code>内爬虫文件代码的冗杂程度。<br>首先，引入必要的模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>为了在其他模组内调用，创建一个<code>Geturls</code>类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Geturls</span>():</span><br></pre></td></tr></table></figure>
<p>其他方法都在这里完成。<br>定义打开网页的方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">open</span>(<span class="params">self, url</span>):</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		request = urllib2.Request(url)</span><br><span class="line">		response = urllib2.urlopen(request)</span><br><span class="line">		content = response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> content</span><br><span class="line">	<span class="keyword">except</span> urllib2.URLError, e:</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">hasattr</span>(e,<span class="string">&quot;code&quot;</span>):</span><br><span class="line">			<span class="built_in">print</span> e.code</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">hasattr</span>(e,<span class="string">&quot;reason&quot;</span>):</span><br><span class="line">			<span class="built_in">print</span> e.reason</span><br></pre></td></tr></table></figure>
<p>打开网页成功后将返回网页内所有的内容，然后提取关键信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">distill</span>(<span class="params">self, content</span>):</span><br><span class="line">		soup = BeautifulSoup(content, <span class="string">&#x27;html.parser&#x27;</span>).find_all(href=re.<span class="built_in">compile</span>(<span class="string">&quot;http://jobs.zhaopin.com/&quot;</span>))</span><br><span class="line">		urls_temp = soup[:<span class="number">60</span>]</span><br><span class="line">		urls = []</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> url <span class="keyword">in</span> urls_temp:</span><br><span class="line">			pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;href=&quot;(.*?)&quot;&#x27;</span>, re.S)</span><br><span class="line">			url_temp = re.findall(pattern, <span class="built_in">str</span>(url))</span><br><span class="line">			urls.append(url_temp)</span><br><span class="line">		<span class="keyword">return</span> urls</span><br></pre></td></tr></table></figure>
<p>原本想把方法名设置为<code>extract</code>，但是<code>SCRAPY</code>内有相同的方法名，只好换成<code>distill</code>(蒸馏)，我觉得反而更加形象XD.<br>智联网页上的东西很多，而我只需要职位的链接，所以使用正则把链接提出来即可。这些链接的规律就是开头皆为<code>http://jobs.zhaopin.com/</code>,后面附带一系列数字。查看网页源代码后，发现还是蛮有规律的，在第一链接之前没有其他的广告链接，而且每页的职位信息顺序排列只有60个，在这之后又会有11个广告链接，如下图</p>
<p><img src="http://okzvvfkr0.bkt.clouddn.com/zhilian_urls.jpg"></p>
<p>所以只需要提取出前60个即可。</p>
<h3 id="获取信息"><a href="#获取信息" class="headerlink" title="获取信息"></a>获取信息</h3><h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><p>接下来的工作是，在上一步获得了所有的url之后，传到<code>SCRAPY</code>逐个打开页面获取职位信息。在目标目录内打开命令行执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy startproject recruit</span><br></pre></td></tr></table></figure>
<p>好吧，这个项目名字不是很高大上，起码能够望文生义吧……<br>命令执行后，会自动生成下列文件夹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">|--recruit/</span><br><span class="line">|	|--scrapy.cfg</span><br><span class="line">|	|--recruit/</span><br><span class="line">|		|--`__init__.py`</span><br><span class="line">|		|--items.py</span><br><span class="line">|		|--piplines.py</span><br><span class="line">|		|--settings.py</span><br><span class="line">|		|--spiders/</span><br><span class="line">|		|--`__init__.py`</span><br></pre></td></tr></table></figure>
<p>将上一步完成的代码保存为<code>geturls.py</code>放到<code>recruit</code>(与items.py等文件同级)目录下。</p>
<h4 id="定义items"><a href="#定义items" class="headerlink" title="定义items"></a>定义items</h4><p>先打开网页的职位信息页面看看需要提取哪些信息吧</p>
<p><img src="http://okzvvfkr0.bkt.clouddn.com/description.jpg"></p>
<p>除了这些信息外，下面还有职位描述和地址信息等，把这些信息定义为items，即为放置这些信息的容器。<br>打开<code>items.py</code>敲入以下代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RecruitItem</span>(scrapy.Item):</span><br><span class="line">    position = scrapy.Field()</span><br><span class="line">    company = scrapy.Field()</span><br><span class="line">    salary = scrapy.Field()</span><br><span class="line">    location = scrapy.Field()</span><br><span class="line">    date = scrapy.Field()</span><br><span class="line">    nature = scrapy.Field()</span><br><span class="line">    experience = scrapy.Field()</span><br><span class="line">    education = scrapy.Field()</span><br><span class="line">    number = scrapy.Field()</span><br><span class="line">    category = scrapy.Field()</span><br><span class="line">    description = scrapy.Field()</span><br><span class="line">    address = scrapy.Field()</span><br></pre></td></tr></table></figure>
<p>保存后退出。</p>
<h4 id="定义spider"><a href="#定义spider" class="headerlink" title="定义spider"></a>定义spider</h4><p>在<code>spiders</code>文件夹内新建文件<code>recruit_spider.py</code>,这是爬虫的核心文件。<br>首先引入需要的模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> recruit.items <span class="keyword">import</span> RecruitItem</span><br><span class="line"><span class="keyword">from</span> recruit.geturls <span class="keyword">import</span> Geturls</span><br><span class="line"><span class="keyword">from</span> scrapy.http <span class="keyword">import</span> Request</span><br></pre></td></tr></table></figure>
<p>这里要引入前面编写的<code>Geturls类</code>和定义的<code>items</code>.<br>新建类，继承框架的爬虫基类，并注明唯一的爬虫名称</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RecruitSpider</span>(scrapy.Spider):</span><br><span class="line">	name = <span class="string">&#x27;recruit&#x27;</span></span><br></pre></td></tr></table></figure>
<p>其余的方法在这个类中编写。第一个方法是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">start_requests</span>(<span class="params">self</span>):</span><br><span class="line">	base_url = <span class="string">&quot;http://sou.zhaopin.com/jobs/searchresult.ashx?jl=%E5%A4%A7%E8%BF%9E&amp;kw=php&amp;sm=0&amp;p=1&quot;</span></span><br><span class="line">	geturls = Geturls()</span><br><span class="line">	content = geturls.<span class="built_in">open</span>(base_url)</span><br><span class="line">	suburls = geturls.distill(content)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> url <span class="keyword">in</span> suburls:</span><br><span class="line">		url_str = <span class="built_in">str</span>(url)</span><br><span class="line">		url_temp = url_str.strip(<span class="string">&quot;&#x27;[]&#x27;&quot;</span>)</span><br><span class="line">		<span class="keyword">yield</span> Request(url_temp, self.parse)</span><br></pre></td></tr></table></figure>
<p>这是<code>scrapy</code>内置的方法名称，依据名称可知是开启<code>requests</code>执行的函数，这里用到了第一步编写的提取url类，直接使用。需要注意的是传过来的url可能包含多余字符，使用<code>strip()</code>去除。<code>base_url</code>是在智联主页搜索后跳转的链接，可以发现这个链接也是有规律可循的，规律是这样的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jl=地点，kw=职位名称，sm=页面状态码(默认=<span class="number">0</span>，可以无视)，p=页码;</span><br></pre></td></tr></table></figure>
<p>可以根据这个规律，自行创建。地点职位页码，根据自身情况修改即可，或者将页码代入循环自动生成一系列地址逐个爬取，这里就不再拓展了……<br>然后将<code>url</code>传给scrapy内置方法<code>Request()</code>，并且使用<code>parse</code>方法作为回调函数进行筛选。</p>
<h4 id="爬取信息"><a href="#爬取信息" class="headerlink" title="爬取信息"></a>爬取信息</h4><p>爬取信息更加简单了，根据<code>xpath</code>获取信息位置取得文本，再剔除多余的空格和字符再保存到<code>items</code>内即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">self, response</span>):</span><br><span class="line">		items = RecruitItem()</span><br><span class="line"></span><br><span class="line">		items[<span class="string">&#x27;position&#x27;</span>] = <span class="string">&quot;&quot;</span>.join(response.xpath(<span class="string">&#x27;/html/body/div[5]/div[1]/div[1]/h1/text()&#x27;</span>).extract()).strip()</span><br><span class="line">		items[<span class="string">&#x27;company&#x27;</span>] = <span class="string">&quot;&quot;</span>.join(response.xpath(<span class="string">&#x27;/html/body/div[5]/div[1]/div[1]/h2/a/text()&#x27;</span>).extract()).strip()</span><br><span class="line">		items[<span class="string">&#x27;salary&#x27;</span>] = <span class="string">&quot;&quot;</span>.join(response.xpath(<span class="string">&#x27;/html/body/div[6]/div[1]/ul/li[1]/strong/text()&#x27;</span>).extract()).strip()</span><br><span class="line">		items[<span class="string">&#x27;location&#x27;</span>] = <span class="string">&quot;&quot;</span>.join(response.xpath(<span class="string">&#x27;/html/body/div[6]/div[1]/ul/li[2]/strong/a/text()&#x27;</span>).extract()).strip()</span><br><span class="line">		items[<span class="string">&#x27;date&#x27;</span>] = <span class="string">&quot;&quot;</span>.join(response.xpath(<span class="string">&#x27;//*[@id=&quot;span4freshdate&quot;]/text()&#x27;</span>).extract()).strip()</span><br><span class="line">		items[<span class="string">&#x27;nature&#x27;</span>] = <span class="string">&quot;&quot;</span>.join(response.xpath(<span class="string">&#x27;/html/body/div[6]/div[1]/ul/li[4]/strong/text()&#x27;</span>).extract()).strip()</span><br><span class="line">		items[<span class="string">&#x27;experience&#x27;</span>] = <span class="string">&quot;&quot;</span>.join(response.xpath(<span class="string">&#x27;/html/body/div[6]/div[1]/ul/li[5]/strong/text()&#x27;</span>).extract()).strip()</span><br><span class="line">		items[<span class="string">&#x27;education&#x27;</span>] = <span class="string">&quot;&quot;</span>.join(response.xpath(<span class="string">&#x27;/html/body/div[6]/div[1]/ul/li[6]/strong/text()&#x27;</span>).extract()).strip()</span><br><span class="line">		items[<span class="string">&#x27;number&#x27;</span>] = <span class="string">&quot;&quot;</span>.join(response.xpath(<span class="string">&#x27;/html/body/div[6]/div[1]/ul/li[7]/strong/text()&#x27;</span>).extract()).strip()</span><br><span class="line">		items[<span class="string">&#x27;category&#x27;</span>] = <span class="string">&quot;&quot;</span>.join(response.xpath(<span class="string">&#x27;/html/body/div[6]/div[1]/ul/li[8]/strong/a/text()&#x27;</span>).extract()).strip()</span><br><span class="line">		items[<span class="string">&#x27;description&#x27;</span>] = <span class="string">&quot;&quot;</span>.join(response.xpath(<span class="string">&#x27;/html/body/div[6]/div[1]/div[1]/div/div[1]/p[1]/text()&#x27;</span>).extract()).strip()</span><br><span class="line">		items[<span class="string">&#x27;address&#x27;</span>] = <span class="string">&quot;&quot;</span>.join(response.xpath(<span class="string">&#x27;/html/body/div[6]/div[1]/div[1]/div/div[1]/h2/text()&#x27;</span>).extract()).strip()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> items</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="定义pipelines"><a href="#定义pipelines" class="headerlink" title="定义pipelines"></a>定义pipelines</h4><p><code>pipelines</code>模块是将<code>items</code>内的信息做过滤，持久化或其他工作的。<br>这里的代码跟之前<code>SCRAPY简单入门</code>中几乎一样，就不再赘述了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> json  </span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RecruitPipeline</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">		self.file = codecs.<span class="built_in">open</span>(<span class="string">&#x27;recruit.json&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">process_item</span>(<span class="params">self, item, spider</span>):</span><br><span class="line">		line = json.dumps(OrderedDict(item))</span><br><span class="line">		self.file.write(line.decode(<span class="string">&quot;unicode_escape&quot;</span>))</span><br><span class="line">		self.file.write(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">close_spider</span>(<span class="params">self, spider</span>):</span><br><span class="line">		self.file.close()</span><br></pre></td></tr></table></figure>
<p>将<code>items</code>内的信息写入json文件<br>不要忘记在<code>setting.py</code>文件中，取消以下几行的注释,并修改成自己项目的名字。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">   <span class="string">&#x27;recruit.pipelines.RecruitPipeline&#x27;</span>: <span class="number">300</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OK，所有准备工作完成！打开命令行键入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl recruit</span><br></pre></td></tr></table></figure>
<p>见证奇迹的发生吧～</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这个小项目整体来说并不难，应该说麻烦多一些。其实数据导出之后，才做好了一个开头工作，本打算将这些数据做成一个可视化的图表，这样才能更直观的感受到信息的价值。数据处理稍微查了一下也是个大坑，更何况这种中文信息处理，想想就有点头疼。话不多说，继续学习，待将数据处理完成后写一篇新的文章。</p>

      
    </div>
    
    
    
  </div>
</article>



  


  <nav id="page-nav" class="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next »</a>
  </nav>



    </div>
  </div>
  




<div id="settings-container">
  <div id="dark-mode">dark</div>
  <div id="sans-font">sans</div>
</div>
<script type="text/javascript">
let d=document,r=d.documentElement.style,f=r.setProperty.bind(r),l=localStorage,s=l.getItem('s')||(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches),n=l.getItem('n'),m=d.getElementById("dark-mode"),b=()=>{f('--bg-color','#fafafa');f('--code-bg-color','#f4f4f4');f('--text-color','#212121');f('--secondary-color','#808080');f('--tertiary-color','#b0b0b0');f('--link-color','#b5c8cf');f('--link-hover-color','#618794');f('--link-bg-color','#dae4e7');f('--selection-color','#dae4e7');m.innerHTML="dark"},c=()=>{f('--bg-color','#212121');f('--code-bg-color','#292929');f('--text-color','#fff');f('--secondary-color','#c0c0c0');f('--tertiary-color','#6e6e6e');f('--link-color','#4d6b75');f('--link-hover-color','#96b1bb');f('--link-bg-color','#5d828e');f('--selection-color','#acc1c9');m.innerHTML="light"},o=d.getElementById("sans-font"),e=()=>{f('--body-stack','"Lora", "Georgia", "Times New Roman", serif');o.innerHTML="sans"},g=()=>{f('--body-stack','"Lato", "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", "Verdana", sans-serif');o.innerHTML="serif"};m.onclick=()=>{if(s==2){s=1;l.setItem('s',s);c()}else{s=2;l.setItem('s',s);b()}};o.onclick=()=>{if(n==2){n=1;l.setItem('n',n);g()}else{n=2;l.setItem('n',n);e()}};if(!s){s=2;l.setItem('s',2)};if(s==1){c()};if(!n){n=2;l.setItem('n',2)};if(n==1){g()};
</script>




</body>
</html>
