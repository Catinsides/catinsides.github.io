<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>catinsides.github.io</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/css/highlight.css">

  
  <meta property="og:type" content="website">
<meta property="og:title" content="catinsides.github.io">
<meta property="og:url" content="https://catinsides.github.io/index.html">
<meta property="og:site_name" content="catinsides.github.io">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="catinsides">
<meta name="twitter:card" content="summary"><meta name="generator" content="Hexo 7.1.1"></head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1 id="title">
    <a href="/">catinsides.github.io</a>
  </h1>
  <nav>
    
    
      
      <a class="nav-link" href="/">Home</a>
    
      
        <span class="nav-spacer">×</span>
      
      <a class="nav-link" href="/archives">Archives</a>
    
      
        <span class="nav-spacer">×</span>
      
      <a class="nav-link" target="_blank" rel="noopener" href="https://github.com/Catinsides">Github</a>
    
    
  </nav>
</header>

    <div id="content">
      
  
    <article id="post-记一次浏览器插件开发经历" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2024/08/07/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%B5%8F%E8%A7%88%E5%99%A8%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E7%BB%8F%E5%8E%86/">记一次浏览器插件开发经历</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2024-08-07T09:00:00.000Z" itemprop="datePublished">八月 7, 2024, 5:00 下午</time>

          
            × <span class="article-word-count">1.6k words</span>
            
            × <span class="article-time-to-read">5 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>最近做了一个浏览器插件的项目，私以为还是比较有意思的，在此记录一下经历。  </p>
<p>这个浏览器插件的主要功能是，提供一个拨号盘界面，可以进行呼入、呼出的功能。再额外添加一些围绕着呼叫的辅助功能，比如：联络记录，通讯录，弹屏等等。  </p>
<h2 id="WXT-介绍"><a href="#WXT-介绍" class="headerlink" title="WXT 介绍"></a>WXT 介绍</h2><p>为了提高开发效率，我直接查找了可以用的插件开发框架，经过一番搜索最终选择了 <a target="_blank" rel="noopener" href="https://wxt.dev/">WXT</a>。</p>
<p>它可以使用流行的前端框架进行开发，它是建立在 <code>Nuxt</code>之上的，而我对 <code>Vue</code> 还算比较熟悉，也就选择了 <code>Vue</code> 这条技术路线一路到底。  </p>
<p>即使现在看来，整个开发过程的体验还是很轻松加愉快的。不足之处是，说明文档不是很全，有很多待补充内容，如果找不到想要的内容，只能到 issues 中寻找。  </p>
<p>打开 <code>WXT</code> 的官方网站，找到 <code>Get Stared</code>，初始化项目,  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm dlx wxt@latest init &lt;project-name&gt;</span><br></pre></td></tr></table></figure>

<p>命令执行完成之后，会生成一些模板代码，具体有什么用可以到官网查看 <a target="_blank" rel="noopener" href="https://wxt.dev/guide/directory-structure">Link</a> 。  </p>
<p><code>WXT</code> 遵循的是 <code>约定优于配置</code>，每个目录内的文件在最终编译时会转换为对应的文件。  </p>
<p>例如：<code>components</code> 内的文件会转换为组件，<code>background</code> 内的文件会转为 <code>ServiceWorker</code>，<code>*.content.ts</code> 会转为 <code>content scripts</code>。</p>
<p>如果熟悉 <code>Nuxt</code> 的话，<code>composables</code>, <code>hooks</code>, <code>utils</code> 内的文件可以自动导入。像是在使用全局的函数，用起来很方便。</p>
<h2 id="插件内的概念"><a href="#插件内的概念" class="headerlink" title="插件内的概念"></a>插件内的概念</h2><p>在开始动手之前，需要先了解一下浏览器插件的概念，有助于开发。</p>
<h3 id="popup"><a href="#popup" class="headerlink" title="popup"></a>popup</h3><p><code>popup</code> 是用户点击插件图标时，弹出的窗口。这个窗口有大小限制，为 800x600。  </p>
<p>这个窗口内的内容，可以理解为就是html。框架内编写的vue组件是在这里渲染的。对应 <code>WXT</code> 的 <code>entrypoints</code> 目录中的 vue 文件。 </p>
<p>每次打开 <code>popup</code> 时，vue代码都会重新加载。如果想实现一些状态共享的功能，在 <code>popup</code> 关闭时，状态都会清空，所以需要存到 <code>storage</code> （后面讲）中在打开时再次读取。</p>
<h3 id="background-scripts"><a href="#background-scripts" class="headerlink" title="background scripts"></a>background scripts</h3><p><code>background scripts</code> 是在浏览器后台运行的脚本。在 manifest v3 中，backgound scripts 就是 service worker.  </p>
<p>对应 <code>WXT</code> 的 <code>entrypoints/background</code> 目录中的文件。</p>
<p>background scripts 不受跨域影响，可以监听来自 <code>popup</code> 和 <code>content scripts</code> 的消息。</p>
<h3 id="content-scripts"><a href="#content-scripts" class="headerlink" title="content scripts"></a>content scripts</h3><p><code>content scripts</code> 是在浏览器页面中运行的脚本。在页面加载后会注入到页面中。可以操作 DOM 元素。</p>
<h3 id="storage"><a href="#storage" class="headerlink" title="storage"></a>storage</h3><p><code>storage</code> 用来存储数据。类似 <code>localStorage</code>，使用时必须加上前缀，<code>local:</code>、<code>session:</code>、<code>sync:</code> 和 <code>managed:</code>。  </p>
<p>与 <code>localStorage</code> 不同，<code>storage</code> 可以监听值的变化，也可以存储对象值。  </p>
<p><code>storage</code> 的数据可以在 <code>popup</code>，<code>background scripts</code> 和 <code>content scripts</code> 之间共享。  </p>
<p>我把它当作 <code>Redis</code> 来用，暂时没发现姿势有什么不对劲。</p>
<h3 id="message"><a href="#message" class="headerlink" title="message"></a>message</h3><p><code>message</code> 用来在 <code>popup</code>，<code>background scripts</code> 和 <code>content scripts</code> 之间传递消息。  </p>
<p>主要用法为</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接受消息</span></span><br><span class="line">browser.<span class="property">runtime</span>.<span class="property">onMessage</span>.<span class="title function_">addListener</span>(<span class="function">(<span class="params">message, sender, sendResponse</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">    <span class="title function_">sendResponse</span>();</span><br><span class="line">    <span class="comment">// 如果发送端需要回复 要返回return true 表明是一个异步消息</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 发送消息</span></span><br><span class="line">browser.<span class="property">runtime</span>.<span class="title function_">sendMessage</span>(&#123;<span class="attr">message</span>: <span class="string">&#x27;hello&#x27;</span>&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="插件功能介绍"><a href="#插件功能介绍" class="headerlink" title="插件功能介绍"></a>插件功能介绍</h2><p>插件通话功能是由 <code>jssip</code> 实现的。页面上实现了登录注册，指定好后端地址，就可以使用通话功能了。  </p>
<p>插件的页面组件使用了 <code>vant</code>.</p>
<h3 id="拨号盘和话务功能"><a href="#拨号盘和话务功能" class="headerlink" title="拨号盘和话务功能"></a>拨号盘和话务功能</h3><p>这部分我使用 vue 画了一个拨号盘的界面用于用户交互。话务功能 <code>jssip</code> 中有现成的函数，可以拨号，挂断，静音等，直接调用相关函数就可以了。  </p>
<p>拨号盘界面需要注意的是，要根据不同的话机状态，显示不同的样式。  </p>
<p>因为 <code>jssip</code> 要获取用户媒体和创建 Audio 用于播放铃声，这部分代码只能放到 <code>content scripts</code> 脚本中。  </p>
<p>个人暂时觉得还是不太完善，在网上查资料可以有 <code>offscreen.html</code> 和 <code>background.html</code> 的其他方法，暂未成功。  </p>
<p><code>popup</code> 中的状态，在用户关闭后就会丢失，而且这个窗口很容易被关闭。每次打开时都需要从 <code>content scripts</code> 中同步状态，这也就用到了 <code>storage</code> 和 <code>message</code>。  </p>
<p>来电通知使用了 <code>notifications</code>，如下代码。这一部分倒是没遇到什么问题，<code>jssip</code> 收到来电后，使用 <code>message</code> 发到 <code>background scripts</code> 就可以了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">browser.<span class="property">notifications</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">iconUrl</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>为了加强插件状态的直观性，在通话和来电时改变图标，可以使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">browser.<span class="property">action</span>.<span class="title function_">setIcon</span>(&#123;&#125;);</span><br></pre></td></tr></table></figure>

<p>除了 <code>jssip</code> 的 <code>websocket</code> 外，插件还需要一个新的 <code>websocket</code> 获取后台系统的消息，以实现弹屏功能。这一部分也放到了 <code>content scripts</code> 脚本中，暂时没遇到什么坑，轻松加愉快。</p>
<h3 id="通讯录"><a href="#通讯录" class="headerlink" title="通讯录"></a>通讯录</h3><p>通讯录可以直接使用 <code>vant</code> 内的组件和 <code>storage</code> 来实现。  </p>
<p>在使用 <code>storage</code> 存储的时候需要注意，数据是插件内全部可见的。也就是即使我这个插件需要不同的用户先登录后再使用，如果用户A保存了通讯录，用户B登录后也能访问到。  </p>
<p>所以在保存这些数据时，需要给数据打上标记，让用户只能访问自己建立的数据。</p>
<h3 id="弹屏功能"><a href="#弹屏功能" class="headerlink" title="弹屏功能"></a>弹屏功能</h3><p>弹屏功能是收到来电后，可以打开指定的网页内容。网页可以由用户自行填写，支持内容替换。这样在和其他CRM系统集成的时候，可以方便的调用第三方系统内的功能。  </p>
<p>这一部分也比较简单，使用 <code>message</code> 然后在 <code>background scripts</code> 脚本中处理。  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chrome.<span class="property">tabs</span>.<span class="title function_">create</span>(&#123; url &#125;);</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line">chrome.<span class="property">tabs</span>.<span class="title function_">update</span>(&#123; url &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="国际化"><a href="#国际化" class="headerlink" title="国际化"></a>国际化</h3><p>这一部分使用了 <a target="_blank" rel="noopener" href="https://vue-i18n.intlify.dev/">vueI18n</a>  </p>
<p>可以参照 <code>WXT</code> 的<a target="_blank" rel="noopener" href="https://github.com/wxt-dev/wxt-examples/tree/main/examples/vue-i18n">示例</a>  </p>
<p>没有遇到什么坑点，唯一要注意的是，在 <code>background scripts</code> 中，要这么用  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i18n.<span class="property">global</span>.<span class="title function_">t</span>(<span class="string">&#x27;&#x27;</span>, &#123;&#125;, &#123; <span class="attr">locale</span>: <span class="string">&#x27;en&#x27;</span> &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="界面截图"><a href="#界面截图" class="headerlink" title="界面截图"></a>界面截图</h2><p float="left">
  <img alt="screenshot-1" src="https://github.com/Catinsides/catinsides.github.io/blob/source/assets/dialpad-screenshots-1.png?raw=true" width="210">
  <img alt="screenshot-1" src="https://github.com/Catinsides/catinsides.github.io/blob/source/assets/dialpad-screenshots-2.png?raw=true" width="210">
  <img alt="screenshot-1" src="https://github.com/Catinsides/catinsides.github.io/blob/source/assets/dialpad-screenshots-3.png?raw=true" width="210">
</p>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>经过这个项目，我熟悉了浏览器插件的开发流程和概念。  </p>
<p>幸好用了框架，没有让代码乱成一锅粥。  </p>
<p><code>vue</code> 生态中的资源也能很好的利用上。我想如果后续迭代的话，也很方便快捷。</p>
<p>——————<br>本文为<a target="_blank" rel="noopener" href="https://github.com/Catinsides">个人原创</a>，转载请署名且注明出处。  </p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-记一次录音转写项目经历中的技术点" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2024/04/01/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%BD%95%E9%9F%B3%E8%BD%AC%E5%86%99%E9%A1%B9%E7%9B%AE%E7%BB%8F%E5%8E%86%E4%B8%AD%E7%9A%84%E6%8A%80%E6%9C%AF%E7%82%B9/">记一次录音转写项目经历中的技术点</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2024-04-01T09:43:02.000Z" itemprop="datePublished">四月 1, 2024, 5:43 下午</time>

          
            × <span class="article-word-count">1.4k words</span>
            
            × <span class="article-time-to-read">6 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>最近做了一个录音转写的项目，其中有一些自认为有意思的技术点，在此记录一下。</p>
<h2 id="实时通话中的录音推流"><a href="#实时通话中的录音推流" class="headerlink" title="实时通话中的录音推流"></a>实时通话中的录音推流</h2><p>此次项目中的部分场景是，坐席与客户通话时，要将通话的内容在网页端进行展示。如果是通话完成后，将对话内容展示出来，可以直接参照 Azure 的官方教程中的示例，<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/ai-services/speech-service/get-started-speech-to-text?tabs=macos,terminal&pivots=programming-language-javascript">链接</a>。教程中，默认的方法就是将整个文件推送上去，无脑CV即可。  </p>
<p>通话完成进行录音识别，语音转文字，可能会遇到的难点有：  </p>
<h3 id="录音文件与转写服务不在同一个服务器"><a href="#录音文件与转写服务不在同一个服务器" class="headerlink" title="录音文件与转写服务不在同一个服务器"></a>录音文件与转写服务不在同一个服务器</h3><p>此时，需要在自身的服务端实现一个录音下载的 stream 接口。转写服务的客户端，调用这个接口之后，可以选择将文件暂存到本地，或者直接将下载流转到 azure 的转写客户端。关键代码如下：</p>
<p>服务端接口：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取录音文件</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getRecord</span> = (<span class="params">req, res</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; recordId &#125; = req.<span class="property">query</span>;</span><br><span class="line">  <span class="keyword">const</span> recordPath = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;record&#x27;</span>, <span class="string">`<span class="subst">$&#123;recordId&#125;</span>.wav`</span>);</span><br><span class="line"></span><br><span class="line">  res.<span class="title function_">writeHead</span>(<span class="number">200</span>, &#123;</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;audio/wav&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Content-Length&#x27;</span>: fs.<span class="title function_">statSync</span>(recordPath).<span class="property">size</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  fs.<span class="title function_">createReadStream</span>(recordPath).<span class="title function_">pipe</span>(res);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>转写服务客户端，同时要考虑到链接会被重定向，主要使用以下两个函数：  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sendGetRequest</span>(<span class="params">url, redirectTimes = <span class="number">0</span></span>) &#123;</span><br><span class="line">    redirectTimes += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (redirectTimes &gt; <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`HTTP request Redirects exceeded, <span class="subst">$&#123;redirectTimes&#125;</span>`</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> req = http.<span class="title function_">get</span>(url, &#123; <span class="attr">timeout</span>: <span class="number">3000</span> &#125;, <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (res.<span class="property">statusCode</span> === <span class="number">302</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> redirectUrl = res.<span class="property">headers</span>.<span class="property">location</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Received 302 Found, redirecting to:&#x27;</span>, redirectUrl);</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_">resolve</span>(<span class="title function_">sendGetRequest</span>(redirectUrl));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res.<span class="property">statusCode</span> === <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="title function_">resolve</span>(res);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`HTTP request failed with status code <span class="subst">$&#123;res.statusCode&#125;</span>`</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        req.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">reject</span>(err);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getRemoteFile</span>(<span class="params">file</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> url = <span class="keyword">new</span> <span class="title function_">URL</span>(<span class="string">`/some-api`</span>, host);</span><br><span class="line">    <span class="keyword">let</span> filePath = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;暂存路径&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> writeStream = fs.<span class="title function_">createWriteStream</span>(filePath);</span><br><span class="line">    <span class="keyword">let</span> stream = <span class="keyword">await</span> <span class="title function_">sendGetRequest</span>(url.<span class="title function_">toString</span>());</span><br><span class="line"></span><br><span class="line">    stream.<span class="title function_">pipe</span>(writeStream);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        writeStream.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">reject</span>(err);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        writeStream.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">resolve</span>(filePath);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按照此<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/ai-services/speech-service/how-to-recognize-speech?pivots=programming-language-javascript#recognize-speech-from-an-in-memory-stream">链接</a>中的方法，封装出一个接收文件输入流的转写函数 <code>readStreamPush</code>，将上面的文件流送入即可。  </p>
<h3 id="录音文件增量读取"><a href="#录音文件增量读取" class="headerlink" title="录音文件增量读取"></a>录音文件增量读取</h3><p>因为是实时转写的，所以需要不断的读取在改变大小的文件。在node中，可以很方便的实现这一点。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> watcher = fs.<span class="title function_">watch</span>(file, <span class="function">(<span class="params">eventType, filename</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (eventType === <span class="string">&#x27;change&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">readIncrementalData</span>(file, <span class="function">(<span class="params">err, buffer, done</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, err);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (buffer) &#123;</span><br><span class="line">                <span class="title function_">readStreamPush</span>(buffer);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (err || done) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;end&#x27;</span>);</span><br><span class="line"></span><br><span class="line">                watcher.<span class="title function_">close</span>();</span><br><span class="line">                pushStream.<span class="title function_">close</span>();</span><br><span class="line">                <span class="title function_">readStreamPush</span>();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (timeout) &#123;</span><br><span class="line">                    <span class="built_in">clearTimeout</span>(timeout);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (timeout) &#123;</span><br><span class="line">                <span class="built_in">clearTimeout</span>(timeout);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            timeout = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                watcher.<span class="title function_">close</span>();</span><br><span class="line">                pushStream.<span class="title function_">close</span>();</span><br><span class="line">                <span class="title function_">readStreamPush</span>();</span><br><span class="line">            &#125;, <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> lastPosition = <span class="number">0</span>; <span class="comment">// 记录上次读取的位置</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">readIncrementalData</span>(<span class="params">filePath, callback</span>) &#123;</span><br><span class="line">    fs.<span class="title function_">open</span>(filePath, <span class="string">&#x27;r&#x27;</span>, <span class="function">(<span class="params">err, fd</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">callback</span>(err);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定位到上次读取的位置</span></span><br><span class="line">        fs.<span class="title function_">fstat</span>(fd, <span class="function">(<span class="params">err, stats</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_">callback</span>(err);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> currentPosition = stats.<span class="property">size</span>;</span><br><span class="line">            <span class="keyword">const</span> bufferLength = currentPosition - lastPosition;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (bufferLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> buffer = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(bufferLength);</span><br><span class="line">                fs.<span class="title function_">read</span>(fd, buffer, <span class="number">0</span>, bufferLength, lastPosition, <span class="function">(<span class="params">err, bytesRead, buffer</span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="title function_">callback</span>(err);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 处理读取到的内容</span></span><br><span class="line">                    <span class="title function_">callback</span>(<span class="literal">null</span>, buffer);</span><br><span class="line"></span><br><span class="line">                    lastPosition = currentPosition; <span class="comment">// 更新上次读取的位置</span></span><br><span class="line"></span><br><span class="line">                    fs.<span class="title function_">close</span>(fd);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">callback</span>(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">                fs.<span class="title function_">close</span>(fd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里加了一个定时，如果一分钟后文件大小不再改变，则视为文件读取完毕。</p>
<h3 id="格式转换"><a href="#格式转换" class="headerlink" title="格式转换"></a>格式转换</h3><p>此时还会遇到的问题是，转写结果不准确，转写结果偏移量也不准确。经排查，推送的录音文件格式与 azure 要求的不符。  </p>
<p>要求是 <code>WAV audio files, including 16-bit, mono PCM, 8 kHz, and 16 kHz</code>.  </p>
<p>那就还需要将上面的文件流进行格式转换，再送去推流。</p>
<p>关键代码如下:  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ffmpeg = <span class="built_in">require</span>(<span class="string">&#x27;fluent-ffmpeg&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Readable</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createConversionStream</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> readStream = <span class="keyword">new</span> <span class="title class_">Readable</span>();</span><br><span class="line">    readStream.<span class="property">_read</span> = <span class="function">() =&gt;</span> &#123; &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> command = <span class="title function_">ffmpeg</span>()</span><br><span class="line">        .<span class="title function_">input</span>(readStream)</span><br><span class="line">        .<span class="title function_">audioFrequency</span>(<span class="number">16000</span>)</span><br><span class="line">        .<span class="title function_">audioChannels</span>(<span class="number">1</span>)</span><br><span class="line">        .<span class="title function_">audioCodec</span>(<span class="string">&#x27;pcm_s16le&#x27;</span>)</span><br><span class="line">        .<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">callback</span>(err);</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">callback</span>(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">format</span>(<span class="string">&#x27;wav&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    command</span><br><span class="line">        .<span class="title function_">pipe</span>()</span><br><span class="line">        .<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">callback</span>(<span class="literal">null</span>, data);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">buffer</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (buffer) &#123;</span><br><span class="line">            readStream.<span class="title function_">push</span>(buffer);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (command &amp;&amp; <span class="keyword">typeof</span> command.<span class="property">kill</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">                command.<span class="title function_">kill</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    createConversionStream,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码可视作返回输出流，直接送入封装的转写服务即可。</p>
<h2 id="转写结果展示"><a href="#转写结果展示" class="headerlink" title="转写结果展示"></a>转写结果展示</h2><p>在页面展示时，实现了一个类似于微信对话框的样式，可以直接用于展示转写结果，一左一右，坐席与客户。因为项目中有知识库，如果对话中涉及到了知识库设置的关键词，需要将关键词高亮显示，同时点击时要弹出知识库的内容。此处参考了类似于B站评论区的关键词的高亮样式。词语变色，右上角加了放大镜。  </p>
<p>将转写结果存入 elasticsearch 中，可以很方便的实现这一点。  </p>
<p>首先在前端实现一个自定义标签<code>&lt;search-keywords&gt;</code>，完成样式和点击的功能。  </p>
<p>在实时转写的查询中，加入知识库的关键字作为匹配条件，使用 elasticsearch 的 match_phrase 查询。给匹配到的关键词加上标签，返回到前端时就能渲染了。  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">query.<span class="property">body</span>.<span class="property">highlight</span> = &#123;</span><br><span class="line">    <span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">        [highlightField]: &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;unified&quot;</span>,</span><br><span class="line">            <span class="string">&quot;number_of_fragments&quot;</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;pre_tags&quot;</span>: [<span class="string">&quot;&lt;search-keywords&gt;&quot;</span>],</span><br><span class="line">    <span class="string">&quot;post_tags&quot;</span>: [<span class="string">&quot;&lt;/search-keywords&gt;&quot;</span>],</span><br><span class="line">    <span class="string">&quot;require_field_match&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;encoder&quot;</span>: <span class="string">&quot;html&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>本文为<a target="_blank" rel="noopener" href="https://github.com/Catinsides">个人原创</a>，转载请署名且注明出处。</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-Hello-Again" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2024/03/28/Hello-Again/">Hello Again</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2024-03-28T02:39:28.000Z" itemprop="datePublished">三月 28, 2024, 10:39 上午</time>

          
            × <span class="article-word-count">49 words</span>
            
            × <span class="article-time-to-read">1 minute</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>时隔多年，终于把废弃的博客救回来了。  </p>
<p>找了个简洁的博客主题，不搞花里胡哨。  </p>
<p>争取以后有时间多更新些新的内容上来。  </p>
<p>:)</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-关于拓展NodeMediaServer以支持JT1078" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2019/07/17/%E5%85%B3%E4%BA%8E%E6%8B%93%E5%B1%95NodeMediaServer%E4%BB%A5%E6%94%AF%E6%8C%81JT1078/">关于拓展NodeMediaServer以支持JT1078</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2019-07-16T17:23:50.000Z" itemprop="datePublished">七月 17, 2019, 1:23 凌晨</time>

          
            × <span class="article-word-count">1.3k words</span>
            
            × <span class="article-time-to-read">4 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <h3 id="Jul-13-2019"><a href="#Jul-13-2019" class="headerlink" title="Jul. 13, 2019"></a>Jul. 13, 2019</h3><p>可能与最近几月坚持跑步有关，头脑突然灵活了很多。</p>
<p>前几日闲来无事摸鱼时，突然就翻回到了NodeMediaServer（NMS）的代码。从服务启动，到视频的解析推流，大致三到四个文件，脉络清晰。NMS的文件结构给了我很大的启发。我突然就想到，完全可以按照NMS的结构，把JT1078的解析也整合进去。</p>
<p>想到去年年底，第一次接触JT1078，视频拉流推流这些概念的时候，完全是一脸懵比。当时准备在NMS上改造，也是在视频推流之后，在NMS解析视频包的位置进行后续处理。甚至研究了一段时间的RTMP握手，由于设备推流不是RTMP协议，在代码里还要判断，如果是设备推流过来的，要跳过RTMP握手阶段，再推流出去。现在回想起来，甚是痛苦。好在现在知道了如何使用FFmpeg作为推流工具，使得这一功能实现。</p>
<p>今日，我仿照NMS的结构，和前几篇文章提到的FFmpeg命令，主要以FFmpeg推流实现的JT1078解析代码推到了仓库里。明显这不是最优的方案。其中一个很大的问题就是一个通道就要启动三个子进程（视频，音频和合并音视频），一般每台设备会有六个通道，观看一个设备的视频直播时就要启动大量的FFmpeg，相当耗费资源。而且这些子进程管理起来比较麻烦，有可能随时某一个在收不到数据时的进程关闭，就会出现 <strong>EPIPE</strong> 错误。而我理想中的最佳方案并不是这样的。最初，我尝试将设备推流过来的视频和音频数据，分别使用NMS原代码中的RTMP封包函数处理，送到播放者的socket中去，但是并没有成功。尝试几轮，服务端没有报错，看起来成功了，但是播放端并没有数据。未找到原因在哪，就暂时转换思路，使用FFmpeg来实现了。</p>
<p>后来又想到，直接使用NMS的封包函数是不行的。视频数据倒是不需要额外处理，音频数据是G7xx格式的，RTMP并不支持，所以需要转码。看来代码层面的封包和解码还需要研究一段时间。</p>
<p>唉！现在是不能够用代码直接封装音视频包，只得使用FFmpeg命令。我要是懂得音视频解封装，还能吃这个亏？</p>
<h3 id="Jul-16-2019"><a href="#Jul-16-2019" class="headerlink" title="Jul. 16, 2019"></a>Jul. 16, 2019</h3><p>今日，研究了一下FFmpeg的命令，想到可以使用两条输入流（视频和音频）转化成一条输出流（RTMP）的方式实现转码和推流。这样就能够不创造出上一方案中多出来的视频和音频子进程了。在将设备的视频和音频流数据，分别存储下来后，使用FFmpeg命令推流</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i test.264 -i test.mp3 -map 0:v -map 1:a -c:v copy -c:a copy -f flv rtmp://xxxx:1935/live/stream_xxxx</span><br></pre></td></tr></table></figure>

<p>命令执行成功，证明了这种方案可能行。于是，我将代码改造为，先将数据缓存，然后使用FFmpeg推流。谁知，实际情况是，缓存数据太小，FFmpeg进程启动后，瞬间就完成了推流，然后关闭了进程。造成的现象就是程序完全没有在（持续）推流。如果FFmpeg随时都要启动的话，有可能会遇到，总将文件从头开始推流的问题。遂暂时搁置了这种方案。</p>
<p>根据上一方案存在的问题，又想到了启动子进程后，可以使用写入 <strong>stdin</strong> 的方式，将数据写入FFmpeg的进程中。但是并没有找到NodeJs写入两条输入流到一个子进程中去的方法。就算是将视频流利用管道符串接到音频流的转码进程中，还是需要有两条输入流。看来这种方案暂时也不行了。</p>
<p>无意中翻到了 <strong>fluent-ffmpeg</strong> 这个库，好像有支持两条输入流的接口，待有时间再测试。</p>
<h3 id="Dec-31-2019"><a href="#Dec-31-2019" class="headerlink" title="Dec. 31, 2019"></a>Dec. 31, 2019</h3><p>万万没想到，在2020以前我能将上面的问题解决。 <del>先忘记fluent-ffmpeg这件事吧</del><br>注: <strong>以下内容适用于Linux系统</strong><br>解决方案仍然是，将视频和音频分流后存储为文件，不同的是文件类别为pipe文件，即命名管道文件(Named Pipe).它遵循先进先出原则(FIFO)，可以像普通文件一样管理。<br>可以使用以下命令创建管道文件:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkfifo /tmp/one.pipe</span><br><span class="line">$ mkfifo /tmp/two.pipe</span><br></pre></td></tr></table></figure>

<p>然后将程序分离出的视频数据和音频数据像写文件一样写入即可，ffmpeg的进程则从这两个文件中读取数据，再转换成rtmp推流发送出去。<br>ffmpeg命令如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ffmpeg -loglevel panic -probesize 32 -re -r 16 -f h264 -i /tmp/one.pipe -f mp3 -i /tmp/two.pipe -map 0:v -map 1:a -c:v copy -c:a aac -strict -2 -preset ultrafast -tune zerolatency -f flv rtmp://xxxx:1935/live/stream_xxxx</span><br></pre></td></tr></table></figure>

<p>读入的文件需要指定格式，如h264和mp3(在上一步中将g726转为了mp3).<br>具体代码实现见我此次提交 <a target="_blank" rel="noopener" href="https://github.com/Catinsides/Node-Media-Server/commit/17be2385e0bc00e4514c504035155d3703299947?diff=split">commit</a></p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-JT1078协议开发之双向对讲后记" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2019/03/29/JT1078%E5%8D%8F%E8%AE%AE%E5%BC%80%E5%8F%91%E4%B9%8B%E5%8F%8C%E5%90%91%E5%AF%B9%E8%AE%B2%E5%90%8E%E8%AE%B0/">JT1078协议开发之双向对讲后记</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2019-03-28T16:00:00.000Z" itemprop="datePublished">三月 29, 2019, 12:00 凌晨</time>

          
            × <span class="article-word-count">1.9k words</span>
            
            × <span class="article-time-to-read">8 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>上一篇大致介绍了一下实时视频的开发流程，这一篇所要介绍的双向对讲算是上一篇内容的小进阶。由 JT&#x2F;T 1078协议（以下简称1078）中介绍可知，双向对讲的数据传输方式也是在 <strong>5.5.3</strong> 表19中定义的。下达双向对讲指令通过改变修改 <strong>0x9101</strong> 消息ID中的参数来实现，本篇不再赘述。功能实现思路与上一篇相同，使用 <strong>nodejs</strong> 和 <strong>FFmpeg</strong> 实现。测试系统环境为 <strong>Linux</strong> .</p>
<h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>见上一篇</p>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>实时视频流程大致如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">participant 网页</span><br><span class="line">participant 服务器</span><br><span class="line">participant 设备</span><br><span class="line"></span><br><span class="line">网页 -&gt;&gt; 设备: 下达双向对讲指令</span><br><span class="line">设备 -&gt;&gt; 服务器: 推送音频数据</span><br><span class="line">服务器 -&gt;&gt; 网页: 转换音频格式推流至网页，并通知开启网页麦克风</span><br><span class="line">网页 -&gt;&gt; 服务器: 采集音频数据并推送</span><br><span class="line">服务器 -&gt;&gt; 设备: 将网页端音频转码，发送至设备</span><br></pre></td></tr></table></figure>

<h3 id="网页采集音频"><a href="#网页采集音频" class="headerlink" title="网页采集音频"></a>网页采集音频</h3><p>浏览器利用麦克风采集麦克风的方法，网上的代码有很多，方法也是如出一辙。<br>下面直接贴出代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> leftchannel = [];</span><br><span class="line"><span class="keyword">var</span> rightchannel = [];</span><br><span class="line"><span class="keyword">var</span> recorder = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> recording = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">var</span> recordingLength = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> volume = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> audioInput = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> sampleRate = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> audioContext = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> context = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> outputElement = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;output&#x27;</span>);    <span class="comment">// 用于提示当前录音状态</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!navigator.<span class="property">getUserMedia</span>)</span><br><span class="line">    navigator.<span class="property">getUserMedia</span> = navigator.<span class="property">getUserMedia</span> || navigator.<span class="property">webkitGetUserMedia</span> ||</span><br><span class="line">        navigator.<span class="property">mozGetUserMedia</span> || navigator.<span class="property">msGetUserMedia</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (navigator.<span class="property">getUserMedia</span>) &#123;</span><br><span class="line">    navigator.<span class="title function_">getUserMedia</span>(&#123; <span class="attr">audio</span>: <span class="literal">true</span> &#125;, success, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&#x27;Error capturing audio.&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">alert</span>(<span class="string">&#x27;getUserMedia not supported in this browser.&#x27;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">interleave</span>(<span class="params">leftChannel, rightChannel</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> length = leftChannel.<span class="property">length</span> + rightChannel.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">new</span> <span class="title class_">Float32Array</span>(length);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> inputIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> index = <span class="number">0</span>; index &lt; length;) &#123;</span><br><span class="line">        result[index++] = leftChannel[inputIndex];</span><br><span class="line">        result[index++] = rightChannel[inputIndex];</span><br><span class="line">        inputIndex++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mergeBuffers</span>(<span class="params">channelBuffer, recordingLength</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">new</span> <span class="title class_">Float32Array</span>(recordingLength);</span><br><span class="line">    <span class="keyword">var</span> offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> lng = channelBuffer.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; lng; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> buffer = channelBuffer[i];</span><br><span class="line">        result.<span class="title function_">set</span>(buffer, offset);</span><br><span class="line">        offset += buffer.<span class="property">length</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">writeUTFBytes</span>(<span class="params">view, offset, string</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> lng = string.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; lng; i++) &#123;</span><br><span class="line">        view.<span class="title function_">setUint8</span>(offset + i, string.<span class="title function_">charCodeAt</span>(i));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">success</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Record Init Succcess!&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    audioContext = <span class="variable language_">window</span>.<span class="property">AudioContext</span> || <span class="variable language_">window</span>.<span class="property">webkitAudioContext</span>;</span><br><span class="line">    context = <span class="keyword">new</span> <span class="title function_">audioContext</span>();</span><br><span class="line">    sampleRate = context.<span class="property">sampleRate</span>;    <span class="comment">// 44100</span></span><br><span class="line">    volume = context.<span class="title function_">createGain</span>();</span><br><span class="line">    audioInput = context.<span class="title function_">createMediaStreamSource</span>(e);</span><br><span class="line"></span><br><span class="line">    audioInput.<span class="title function_">connect</span>(volume);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> bufferSize = <span class="number">2048</span>;</span><br><span class="line">    recorder = context.<span class="title function_">createScriptProcessor</span>(bufferSize, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    recorder.<span class="property">onaudioprocess</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!recording) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">var</span> left = e.<span class="property">inputBuffer</span>.<span class="title function_">getChannelData</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">var</span> right = e.<span class="property">inputBuffer</span>.<span class="title function_">getChannelData</span>(<span class="number">1</span>);</span><br><span class="line">        leftchannel.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">Float32Array</span>(left));</span><br><span class="line">        rightchannel.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">Float32Array</span>(right));</span><br><span class="line">        recordingLength += bufferSize;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;recording...&#x27;</span>);</span><br><span class="line">        <span class="title function_">combineAudio</span>([<span class="keyword">new</span> <span class="title class_">Float32Array</span>(left)], [<span class="keyword">new</span> <span class="title class_">Float32Array</span>(right)], bufferSize, sampleRate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    volume.<span class="title function_">connect</span>(recorder);</span><br><span class="line">    recorder.<span class="title function_">connect</span>(context.<span class="property">destination</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">combineAudio</span>(<span class="params">leftc, rightc, bfSize, sampleRate</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> leftBuffer = <span class="title function_">mergeBuffers</span>(leftc, bfSize);</span><br><span class="line">    <span class="keyword">var</span> rightBuffer = <span class="title function_">mergeBuffers</span>(rightc, bfSize);</span><br><span class="line">    <span class="keyword">var</span> interleaved = <span class="title function_">interleave</span>(leftBuffer, rightBuffer);</span><br><span class="line">    <span class="keyword">var</span> dataLen = interleaved.<span class="property">length</span> * <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">var</span> buffer, view, index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(dataLen);    </span><br><span class="line">    view = <span class="keyword">new</span> <span class="title class_">DataView</span>(buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> lng = interleaved.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">var</span> volume = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; lng; i++) &#123;</span><br><span class="line">        view.<span class="title function_">setInt16</span>(index, interleaved[i] * (<span class="number">0x7FFF</span> * volume), <span class="literal">true</span>);</span><br><span class="line">        index += <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([view], &#123; <span class="attr">type</span>: <span class="string">&#x27;audio/wave&#x27;</span> &#125;);    <span class="comment">// 最终音频数据</span></span><br><span class="line">    <span class="comment">// 将blob写入 websocket, 略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码主要思路为通过改变全局变量 <strong>recording</strong> 控制录音，这个可以使用 <strong>button</strong> 元素实现。开启录音后，浏览器采集左右声道的音频数据，将数据存入Buffer后，合并两通道数据然后通过 <strong>DataView</strong> 和 <strong>Blob</strong> 包装后的数据发送至服务器。为了保证实时性，我这里使用的是 <strong>websocket</strong> 发送至后台。上述代码得到的音频数据为 <strong>PCMS16LE</strong> 原始数据，默认采样率为44.1k，所以体积比较巨大。可以通过减少声道数量和降低采样率，或者直接在浏览器端重新编码来减少体积。</p>
<h3 id="音频转码"><a href="#音频转码" class="headerlink" title="音频转码"></a>音频转码</h3><p>音频转码涉及两个部分，一是将网页端采集的音频数据转换成设备支持的格式发送给设备；二是将设备端发送的音频数据转成网页端支持的格式进行播放。<br>设备支持什么格式呢？由于设备的不同，可能初始默认的音频格式都不尽相同。最方便的肯定是直接操作设备进行查看了。还可以在下达双向对讲指令后，解析RTP包参照1078 <strong>表12</strong> 进行查看。我手里这台设备的音频格式是 <strong>G726LE</strong>.<br>首先进行网页端播放设备音频流的实现。有了上一篇文章的经验，音视频服务器和网页端播放器都是准备好的，一下子省去了很多的工作，只需要将设备音频数据转码发送给音视频服务器即可。然后，网页端从音视频服务器提供的地址拉流就能进行播放了。看起来很简单有木有，突然有点小兴奋。<br>接下来的思路与视频处理相似，使用子进程开启 <strong>FFmpeg</strong> 进行转码并推流。由于推流要使用 <strong>flv</strong> 格式的 <strong>RTMP</strong> 流，而 <strong>flv</strong> 支持的音频格式是有限的（<a target="_blank" rel="noopener" href="https://trac.ffmpeg.org/wiki/SupportedMediaTypesInFormats">点击查看</a>），光是进行音频转码就占用了一个FFmpeg子进程，所以还需要另一个进程将转码后的数据推流出去。听起来很麻烦，但FFmpeg支持数据流处理，所以实现起来非常简单，只需要将两个子进程的STDIN, STDOUT pipe 起来就行了，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; spawn &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FFMPEG</span> = <span class="string">&#x27;/usr/bin/ffmpeg&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cmds1 = [</span><br><span class="line">    <span class="string">&#x27;-loglevel&#x27;</span>, <span class="string">&#x27;panic&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-probesize&#x27;</span>, <span class="string">&#x27;32&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;g726le&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-code_size&#x27;</span>, <span class="string">&#x27;5&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-ar&#x27;</span>, <span class="string">&#x27;8000&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-ac&#x27;</span>, <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-i&#x27;</span>, <span class="string">&#x27;-&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-ar&#x27;</span>, <span class="string">&#x27;44100&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-acodec&#x27;</span>, <span class="string">&#x27;libmp3lame&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;mp3&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;pipe:1&#x27;</span></span><br><span class="line">];</span><br><span class="line"><span class="keyword">var</span> cmds2 = [</span><br><span class="line">    <span class="string">&#x27;-i&#x27;</span>, <span class="string">&#x27;-&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-vn&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;copy&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;flv&#x27;</span>,</span><br><span class="line">    rtmpUrl</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> child1 = <span class="title function_">spawn</span>(<span class="variable constant_">FFMPEG</span>, cmds1);</span><br><span class="line"><span class="keyword">var</span> child2 = <span class="title function_">spawn</span>(<span class="variable constant_">FFMPEG</span>, cmds2);</span><br><span class="line"></span><br><span class="line">child1.<span class="property">stdin</span>.<span class="title function_">write</span>(data);</span><br><span class="line">child1.<span class="property">stdout</span>.<span class="title function_">pipe</span>(child2.<span class="property">stdin</span>);</span><br></pre></td></tr></table></figure>

<p>这样，网页端播放器就能使用 <strong>RTMP</strong> 链接播放设备的音频数据了。<br>回来处理网页端到设备端的部分，思路也清晰了起来，只需将音频数据写到设备就行了。已经知道了设备支持的编码格式是 <strong>G726LE</strong>，所以首先需要将音频转码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; spawn &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FFMPEG</span> = <span class="string">&#x27;/usr/bin/ffmpeg&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cmds = [</span><br><span class="line">    <span class="string">&#x27;-loglevel&#x27;</span>, <span class="string">&#x27;panic&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;s16le&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-ar&#x27;</span>, <span class="string">&#x27;44.1k&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-ac&#x27;</span>, <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-i&#x27;</span>, <span class="string">&#x27;-&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-acodec&#x27;</span>, <span class="string">&#x27;g726le&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-code_size&#x27;</span>, <span class="string">&#x27;5&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-ar&#x27;</span>, <span class="string">&#x27;8k&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-ac&#x27;</span>, <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;g726le&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;pipe:1&#x27;</span></span><br><span class="line">];</span><br><span class="line"><span class="keyword">var</span> _process = <span class="title function_">spawn</span>(<span class="variable constant_">FFMPEG</span>, cmds);</span><br></pre></td></tr></table></figure>

<p>开启子进程后，将网页端数据写入进程STDIN，再将STDOUT数据写入设备连至服务器的TCP连接即可。因为流程中，是先下达指令，设备连接上来后，再进行网页端数据写入，设备的连接是很容易获取到的。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>实时视频和双向对讲的实现思路大体上是一致，区别在FFmpeg的参数不同，多开启了几个进程而已。不由得感叹FFmpeg的强大。前后两篇文章中，涉及到业务的代码都是一笔带过，而主要列举了FFmpeg的命令。不要小看这简单的几行命令，对于从没接触过FFmpeg和音视频知识几乎为零的我来说，花费了大量的时间来搜索和尝试。相比之下，业务上码代码花费的时间更少。业务代码中也有很多值得注意的点，如设备连接和断开时，FFmpeg进程的管理；FFmpeg进程写入时，EPIPE的处理（管理各个子进程的事件回调）；双向对讲状态的共享（Redis实现）等等。经过这一项目的一番折腾，也算是了解一些音视频方面的知识，也对这方面有了一番兴趣。打算借着没有减退的热度开个音视频相关的小项目，希望自己不要弃坑。</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-JT1078协议开发之实时视频后记" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2019/03/16/JT1078%E5%8D%8F%E8%AE%AE%E5%BC%80%E5%8F%91%E4%B9%8B%E5%AE%9E%E6%97%B6%E8%A7%86%E9%A2%91%E5%90%8E%E8%AE%B0/">JT1078协议开发之实时视频后记</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2019-03-15T16:00:00.000Z" itemprop="datePublished">三月 16, 2019, 12:00 凌晨</time>

          
            × <span class="article-word-count">2.6k words</span>
            
            × <span class="article-time-to-read">9 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>前几个月一直在进行JT&#x2F;T 1078协议（以下简称1078）相关项目的开发，其中涉及各种音视频协议和网络协议，还有音视频服务器和处理软件的知识。从一开始处于知识盲区的我，一路摸爬滚打，google和阅读书籍，挖坑填坑，总算是把项目需要的功能给研究出来了。当然，1078本身描述的功能很多，全部实现需要大量的人力和时间，一篇文章也不可能讲完。所以，打算用两篇文章主要记录一下实时视频和双向对讲的实现方法。这一篇为实时视频，双向对讲放在下一篇。功能皆使用 <strong>nodejs</strong> 和 <strong>FFmpeg</strong> 实现，系统环境为 <strong>Linux</strong> .</p>
<h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>项目需求简单地说就是，有一台支持1078协议的设备，接收特定指令后，通过协议内容将音视频数据发送至服务器（以下简称推流），服务器再将音视频数据转发出去，使得客户端或者网页播放器能够收看到设备发送的数据（以下简称拉流），以达到实时视频的效果。后面功能的实现皆为网页端操作。</p>
<p>所以至少要准备：</p>
<ul>
<li>1078协议文档</li>
<li>1078协议设备</li>
<li>音视频服务器</li>
<li>播放器</li>
</ul>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>实时视频流程大致如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">participant 网页</span><br><span class="line">participant 服务器</span><br><span class="line">participant 设备</span><br><span class="line"></span><br><span class="line">网页 -&gt;&gt; 设备: 下达推送视频指令</span><br><span class="line">设备 -&gt;&gt; 服务器: 推送视频数据</span><br><span class="line">服务器 -&gt;&gt; 网页: 转换为网页支持的格式</span><br></pre></td></tr></table></figure>

<h3 id="音视频服务器与解析"><a href="#音视频服务器与解析" class="headerlink" title="音视频服务器与解析"></a>音视频服务器与解析</h3><p>下达推送指令部分可按照协议要求的格式轻松搞定，主要问题在于如何将设备的音视频数据推流至服务器。服务器再转换为网页端能够拉流播放的格式。说到视频直播，推流拉流，首先想到的是RTMP。在搜索引擎中搜一搜，支持RTMP的音视频服务器，无论是开源还是闭源，都有很多。首先找到一个部署方便的，放在服务器上待命。<br>部署完成之后，可以使用FFmpeg推送本地文件至服务器测试好不好用。</p>
<p>FFmpeg命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -re -i localFile.mp4 -c copy -f flv rtmp://server:1935/live/streamName</span><br></pre></td></tr></table></figure>

<p>RTMP链接后部分可能根据服务器有所不同。端口一般为1935.<br>播放RTMP链接，可以使用FFmpeg内置的ffplay，或者其他在线播放网站即可。</p>
<p>由1078文档内容可知，设备的音视频传输方式，定义在 <strong>5.5.3</strong> 部分。</p>
<blockquote>
<p>实时音视频流数据的传输参考RTP协议，使用UDP或TCP承载。</p>
</blockquote>
<p>可知，设备推流并不是RTMP协议，而是魔改的RTP协议，具体内容在表19中。这和服务器接收的数据协议不同，所以需要将设备推流转换为服务器能够接收的协议格式。<br>第一次搞这种东西，只看文档一头雾水，没别的办法，搭建一个TCP服务，让设备把数据发过来，验证数据格式是否与文档中描述的一致。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">&#x27;net&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">HOST</span> = <span class="string">&#x27;xx&#x27;</span>, <span class="variable constant_">PORT</span> = <span class="string">&#x27;xx&#x27;</span>;    <span class="comment">// 在下发指令中指定</span></span><br><span class="line"><span class="keyword">const</span> server = net.<span class="title function_">createServer</span>(<span class="function"><span class="params">socket</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;TCP Server Created!&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;TCP Server Error ==&#x27;</span>, err);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function"><span class="params">_</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;TCP Server Closed.&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    socket.<span class="title function_">setKeepAlive</span>(<span class="literal">true</span>, <span class="number">2000</span>);</span><br><span class="line">    socket.<span class="built_in">setTimeout</span>(<span class="number">10000</span>, <span class="function"><span class="params">_</span> =&gt;</span> &#123;</span><br><span class="line">        socket.<span class="title function_">end</span>(<span class="string">&#x27;TCP Socket Broken.&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">server.<span class="title function_">listen</span>(<span class="variable constant_">PORT</span>, <span class="variable constant_">HOST</span>, <span class="function"><span class="params">_</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Server Start Successfully, Listen on <span class="subst">$&#123;PORT&#125;</span>.`</span>);</span><br><span class="line">&#125;);</span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>, <span class="function"><span class="params">socket</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> &#123; remoteAddress &#125; = socket, &#123; address, port &#125; = socket.<span class="title function_">address</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Address is &#x27;</span>, address, <span class="string">&#x27;. Port is&#x27;</span>, port, <span class="string">&#x27;. remoteAddress is &#x27;</span>, remoteAddress);</span><br><span class="line"></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// console.log(&#x27;TCP ON DATA&#x27;);</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function"><span class="params">_</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Bye&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>设备推流后会触发socket的on data 事件，由于data是Buffer，所以需要把data转换成 <strong>16进制</strong> 的数据才能对照文档分析。转换完成后，可以大致看到一些规律，与文档中描述的一致。一个data变量可能包含多个以 <strong>0x30 0x31 0x63 0x64</strong> 开头的数据，对应文档中的帧头标识。有没有可能在负载数据中也出现帧头呢，那就再往后取一个字节，降低概率。可以观察到第4至第5字节，都是 <strong>0x81</strong> .具体含义可以看 <strong>RFC 3550</strong>.每个RTP包除了前30字节（也有可能少于30）的数据描述外，就是媒体数据payload了。<br>接下来要做的是，从TCP数据中分离出每个RTP包。TCP是基于流式传输的（我真的很讨厌“粘包”这个词），每个data不一定以帧头开始，或者结束，而且中间可能包含多个RTP包。但是已经知道了帧头一定是 <strong>0x30 0x31 0x63 0x64 0x81</strong> , 所以可以用帧头来切分TCP数据。再将切分出来的RTP包传入到下一个函数中单独处理。这部分处理很简单，不再贴代码，需要注意的地方就是如何将两个TCP data中的RTP包数据组合再传入函数。<br>先假定现在是最理想的情况，即不需要考虑RTP包乱序，视频帧乱序的情况，以这种前提将payload存储下来看看能否正常播放。当然，上面的再取一个 <strong>0x81</strong> 也是在这种前提下考虑的。<br>接下来就是要分析RTP包的数据了。完全对照文档中的表19按字节读取即可。网络传输使用的是 <strong>大端模式</strong> ，nodejs中使用的函数主要为以下几个：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">buf.<span class="title function_">slice</span>([start[, end]])</span><br><span class="line">buf.<span class="title function_">readInt8</span>(offset)</span><br><span class="line">buf.<span class="title function_">readInt16BE</span>(offset)</span><br><span class="line">buf.<span class="title function_">readInt32BE</span>(offset)</span><br></pre></td></tr></table></figure>

<p>解析完成后，可以看到当前RTP包所承载的数据信息。如包序号，SIM卡号，通道号，数据类型，分包标记等。原子包不做处理，分包需要将后续的包组合成一个数据。从第5字节中的数据可知，当前包负载中的媒体类型，解析后对应表12查得可知，音频格式为 <strong>G.726</strong>，视频格式为 <strong>H.264</strong>.不同设备的格式可能有所不同。将音频包和视频包分别存储为音频和视频文件，再使用软件播放验证前面解析程序的正确性。全部正确的话，这些文件都是可以正常播放的。<br>接下来就需要想办法如何把这些数据推流到音视频服务器了。服务器接收的格式为RTMP流，需要把从RTP分离出的媒体数据转化为RTMP流推到服务器。由于本人还不能直接用nodejs撸出一个转码和推流服务的程序出来，接下来的工作便交给了 <strong>FFmpeg</strong> 处理。<br>先来看一下如何处理视频数据，用FFmpeg将本地文件推送至RTMP服务器，查官方文档可知，得到下面的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -loglevel panic \</span><br><span class="line">    -probesize 32 \</span><br><span class="line">    -re \</span><br><span class="line">    -r 16 \</span><br><span class="line">    -i localfile.h264 \</span><br><span class="line">    -c:v libx264 \</span><br><span class="line">    -preset ultrafast \</span><br><span class="line">    -tune zerolatency \</span><br><span class="line">    -profile:v baseline \</span><br><span class="line">    -f flv <span class="string">&quot;rtmp://xxx&quot;</span></span><br></pre></td></tr></table></figure>

<p>上面这条语句不止能推送文件，还是最终的优化版。<br>解释一下部分选项：</p>
<ul>
<li>-loglevel panic 用于屏蔽ffmpeg的输出内容</li>
<li>-probesize 32 用于降低ffmpeg转换延迟</li>
<li>-r 16 设置帧率，需要与设备端一致，否则会出现播放速度太快的问题</li>
<li>-f flv “” 输出rtmp链接，这里需要使用SIM卡号和通道号组合成特定链接</li>
</ul>
<p>有了这条命令，就该想办法如何把RTP中的payload输入到ffmpeg了。<br>ffmpeg支持从STDIN输入的数据，所以只需要将ffmpeg执行命令放入nodejs的child process子进程中，然后把payload数据写入该子进程的STDIN即可，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; spawn &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FFMPEG</span> = <span class="string">&#x27;/usr/bin/ffmpeg&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cmds = [</span><br><span class="line">    <span class="string">&#x27;-loglevel&#x27;</span>, <span class="string">&#x27;panic&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-probesize&#x27;</span>, <span class="string">&#x27;32&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-re&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-r&#x27;</span>, <span class="string">&#x27;16&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-i&#x27;</span>, <span class="string">&#x27;-&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-c:v&#x27;</span>, <span class="string">&#x27;libx264&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-preset&#x27;</span>, <span class="string">&#x27;ultrafast&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-tune&#x27;</span>, <span class="string">&#x27;zerolatency&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-profile:v&#x27;</span>, <span class="string">&#x27;baseline&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;flv&#x27;</span>,</span><br><span class="line">    rtmpUrl</span><br><span class="line">];</span><br><span class="line"><span class="keyword">var</span> child = <span class="title function_">spawn</span>(<span class="variable constant_">FFMPEG</span>, cmds);</span><br><span class="line">child.<span class="property">stdin</span>.<span class="title function_">write</span>(data);</span><br></pre></td></tr></table></figure>

<p>区别在于，将本地文件的名称换成了 - .ffmpeg会在子进程中将payload数据转化成rtmp推流到服务器。完成这一部分的代码之后，可以先尝试着将数据推流到音视频服务器，然后找一个能在线看rtmp的网站进行测试。程序无误的情况下，可以看到直播数据。在单台设备全通道的情况下，可以做到延迟 <strong>2-3s</strong> .说明上面的“大胆”假设是正确的，一下子感觉轻松了不少:)</p>
<p>再接下来需要进一步完善程序，如：</p>
<ul>
<li>设备收到停止视频推送指令后，需要关闭ffmpeg的子进程</li>
<li>多设备，多通道情况下的ffmpeg子进程管理</li>
</ul>
<p>这就与1078协议开发无关了，考验写程序功底的时候到了，本文不再赘述。</p>
<p>音频部分涉及到转码，留在与下一篇双向对讲功能一起说。</p>
<h3 id="网页端"><a href="#网页端" class="headerlink" title="网页端"></a>网页端</h3><p>网页端无论是Flash还是H5的视频播放器有很多，翻翻文档API就可以查到如何播放指定链接的视频。如果音视频服务器不仅能提供rtmp流，还能提供flv流，网页播放的实现可以更加灵活。</p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>1078协议实时视频的开发，说难不难，说简单不简单。它难就难在网上的资料居然如此之少，完全需要靠自己摸索验证。而且在开发验证的过程中，很容易走弯路。开发完成后，回头再看，发现只是需要按文档读取数据而已，并没有涉及音视频领域更深一层的知识。<br>本文并没有完全使用nodejs进行转码和推送的实现，而是使用了ffmpeg作为子进程进行推流。恕本人学识有限，音视频知识的学习任重而道远，暂时只能以这样的“笨”方法实现功能需求。新的学习计划已提上日程，希望在以后的日子里能够进一步改进。</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-2018都做了些什么" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2018/12/31/2018%E9%83%BD%E5%81%9A%E4%BA%86%E4%BA%9B%E4%BB%80%E4%B9%88/">2018都做了些什么</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2018-12-31T15:59:59.000Z" itemprop="datePublished">十二月 31, 2018, 11:59 晚上</time>

          
            × <span class="article-word-count">740 words</span>
            
            × <span class="article-time-to-read">2 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <blockquote>
<p>不要高估一天能做到的事，也不要低估一年能做到的事。</p>
</blockquote>
<p>我这个人是拒绝鸡汤的。偶然在V2里看到这句话，思考了一下，也确实有一些道理。回想到去年此时的自己，怎么也想不到会学习了这么多的新技能。每天学习一点点，日积月累，真的很重要。</p>
<p>回想这一年：</p>
<ul>
<li>印象最深的一本书，是<a target="_blank" rel="noopener" href="https://book.douban.com/subject/27081224/">《学会提问》</a>。书本身很小巧，几个小时就能读完，但是收获的内容可以说是受益终生。作者从提问的意义，到提问分类，再到优质提问的方法，阐述了学会做优质的提问是多么的重要。问题也可分为抛给对方还是抛给自己的。抛给对方的问题，能够带来有益的思考，还能解决自己的迷惑。而抛给自己的优质提问是有力的内驱力。</li>
<li>印象最深的影视剧，是<a target="_blank" rel="noopener" href="https://movie.douban.com/subject/26602304/">《重版出来！》</a>。有一点浮夸风的职场剧，毕竟是漫改。看罢，真是感觉热血到不行。也了解到了，一部漫画作品从创作到连载的艰辛。如果能够依靠自己的爱好赚钱，真是既痛苦又快乐的事情。以至于，看完剧的我买了几本《超级漫画素描技法》，然而并没有怎么看，放到书架上吃灰中（摊手）。</li>
</ul>
<p>回到上班摸鱼，除了几个从部署到完成业务的与深度学习相关的功能，还是在前端页面和后端增删改查之中打转。深度学习并没有深度学习，前后端相比以前熟悉了很多，四舍五入也算是进步了吧。在业余时间，学习了下docker的使用，这绝对是这一年最大的收获了。在部署服务和测试功能上，都有很大的帮助，绝对是早学早受益。</p>
<p>夏季之前，也尝试了下Unity3D.利用了半个月左右的下班后时间，制作出了极其简陋的第三人称射击游戏。游戏拥有基本的界面和操作，敌人不能动，但是能够随机地点重生。说的好像有点roguelike呢。深刻体会到了游戏制作的艰辛，由衷地钦佩能够包揽美术、音乐和策划的独立制作人。</p>
<p>这一年一直坚持下来的就是日语的学习了，受影视音乐文化的影响，也保持着高涨的热情。虽然进步缓慢，但督促自己能够坚持下去。年底接手了与音视频相关的项目，接触不少新知识，C&#x2F;C++的学习也提上了日程(虽然被《C++ Primer Plus》的厚度吓到劝退)。希望在新的一年里，珍惜时间，努力学习，想要放弃的时候，想想为什么要开始。</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-给console.log一点颜色看看" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2017/07/03/%E7%BB%99console.log%E4%B8%80%E7%82%B9%E9%A2%9C%E8%89%B2%E7%9C%8B%E7%9C%8B/">给console.log一点颜色看看</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2017-07-03T15:44:15.000Z" itemprop="datePublished">七月 3, 2017, 11:44 晚上</time>

          
            × <span class="article-word-count">302 words</span>
            
            × <span class="article-time-to-read">1 minute</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>开发中少不了使用console.log进行调试，那么如何使打印出的内容具有颜色呢？</p>
<p>首先要说明的是，这里指的打印是在命令行中进行输出的，而不是在chrome控制台中。</p>
<p>答案是，把console.log()第一个参数设置为ANSI转义码即可, 第二个参数为需要打印的内容。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 像这样</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\x1b[31m&quot;</span>, <span class="string">&quot;I&#x27;m green.&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当然，聪明而又懒惰的我们不会一个一个去敲这些字符，真是光看看就觉得麻烦啊，So...</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">FgRed</span> = <span class="string">&quot;\x1b[31m&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">FgRed</span>, <span class="string">&quot;I&#x27;m red.&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 真是雕虫小技啊:P</span></span><br><span class="line"><span class="comment">// 这里还有有更多的颜色</span></span><br><span class="line"><span class="title class_">Reset</span> = <span class="string">&quot;\x1b[0m&quot;</span>,</span><br><span class="line"><span class="title class_">Bright</span> = <span class="string">&quot;\x1b[1m&quot;</span>,</span><br><span class="line"><span class="title class_">Dim</span> = <span class="string">&quot;\x1b[2m&quot;</span>,</span><br><span class="line"><span class="title class_">Underscore</span> = <span class="string">&quot;\x1b[4m&quot;</span>,</span><br><span class="line"><span class="title class_">Blink</span> = <span class="string">&quot;\x1b[5m&quot;</span>,</span><br><span class="line"><span class="title class_">Reverse</span> = <span class="string">&quot;\x1b[7m&quot;</span>,</span><br><span class="line"><span class="title class_">Hidden</span> = <span class="string">&quot;\x1b[8m&quot;</span>,</span><br><span class="line"><span class="title class_">FgBlack</span> = <span class="string">&quot;\x1b[30m&quot;</span>,</span><br><span class="line"><span class="title class_">FgRed</span> = <span class="string">&quot;\x1b[31m&quot;</span>,</span><br><span class="line"><span class="title class_">FgGreen</span> = <span class="string">&quot;\x1b[32m&quot;</span>,</span><br><span class="line"><span class="title class_">FgYellow</span> = <span class="string">&quot;\x1b[33m&quot;</span>,</span><br><span class="line"><span class="title class_">FgBlue</span> = <span class="string">&quot;\x1b[34m&quot;</span>,</span><br><span class="line"><span class="title class_">FgMagenta</span> = <span class="string">&quot;\x1b[35m&quot;</span>,</span><br><span class="line"><span class="title class_">FgCyan</span> = <span class="string">&quot;\x1b[36m&quot;</span>,</span><br><span class="line"><span class="title class_">FgWhite</span> = <span class="string">&quot;\x1b[37m&quot;</span>,</span><br><span class="line"><span class="title class_">BgBlack</span> = <span class="string">&quot;\x1b[40m&quot;</span>,</span><br><span class="line"><span class="title class_">BgRed</span> = <span class="string">&quot;\x1b[41m&quot;</span>,</span><br><span class="line"><span class="title class_">BgGreen</span> = <span class="string">&quot;\x1b[42m&quot;</span>,</span><br><span class="line"><span class="title class_">BgYellow</span> = <span class="string">&quot;\x1b[43m&quot;</span>,</span><br><span class="line"><span class="title class_">BgBlue</span> = <span class="string">&quot;\x1b[44m&quot;</span>,</span><br><span class="line"><span class="title class_">BgMagenta</span> = <span class="string">&quot;\x1b[45m&quot;</span>,</span><br><span class="line"><span class="title class_">BgCyan</span> = <span class="string">&quot;\x1b[46m&quot;</span>,</span><br><span class="line"><span class="title class_">BgWhite</span> = <span class="string">&quot;\x1b[47m&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>拓展阅读:<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/ANSI_escape_code">ANSI escape code</a></p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-JS野生程序员进修指南" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2017/05/15/JS%E9%87%8E%E7%94%9F%E7%A8%8B%E5%BA%8F%E5%91%98%E8%BF%9B%E4%BF%AE%E6%8C%87%E5%8D%97/">JS野生程序员进修指南</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2017-05-15T13:08:00.000Z" itemprop="datePublished">五月 15, 2017, 9:08 晚上</time>

          
            × <span class="article-word-count">855 words</span>
            
            × <span class="article-time-to-read">3 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <h3 id="基本"><a href="#基本" class="headerlink" title="基本"></a>基本</h3><p><code>缩进</code><br>4个空格，而不是一个制表符</p>
<p><code>结尾</code><br>分号结尾</p>
<p><code>行长度</code><br>80个字符</p>
<p><code>换行</code><br>符号结尾，第二行追加2单位(8字符)缩进</p>
<p><code>空行</code></p>
<ul>
<li>方法之间</li>
<li>方法中局部变量和第一条语句之间</li>
<li>注释之前</li>
<li>逻辑片段之间</li>
</ul>
<p><code>命名</code></p>
<ul>
<li>Camel Case</li>
<li>变量前缀为名词</li>
<li>函数前缀为动词</li>
<li>表数量 count, length, size</li>
<li>循环体 i, j, k</li>
<li>常量使用大写字母，下划线分隔单词</li>
<li>构造函数使用Pascal Case</li>
</ul>
<p><code>函数名参考</code></p>
<table>
<thead>
<tr>
<th>动词</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>can</td>
<td>返回布尔值</td>
</tr>
<tr>
<td>has</td>
<td>返回布尔值</td>
</tr>
<tr>
<td>is</td>
<td>返回布尔值</td>
</tr>
<tr>
<td>get</td>
<td>返回非布尔值</td>
</tr>
<tr>
<td>set</td>
<td>保存一个值</td>
</tr>
</tbody></table>
<p><code>直接量</code></p>
<ul>
<li>字符串 单引号、双引号皆可</li>
<li>数字，不使用八进制；不以小数点结尾</li>
</ul>
<p><code>null</code></p>
<ul>
<li>对象占位符</li>
<li>不要 检测是否传入某个参数</li>
<li>不要 检测一个未初始化的变量</li>
</ul>
<p><code>undefined</code><br>未被初始化的变量初始值</p>
<p><code>对象直接量</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不好的写法</span></span><br><span class="line"><span class="keyword">var</span> book = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">book.<span class="property">title</span> = <span class="string">&quot;JavaScript&quot;</span>;</span><br><span class="line">book.<span class="property">author</span> = <span class="string">&quot;Mike&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//好的写法</span></span><br><span class="line"><span class="keyword">var</span> book = &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;JavaScript&quot;</span>,</span><br><span class="line">    <span class="attr">author</span>: <span class="string">&quot;Mike&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>数组直接量</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不好的写法</span></span><br><span class="line"><span class="keyword">var</span> colors = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="string">&quot;red&quot;</span>, <span class="string">&quot;blue&quot;</span>, <span class="string">&quot;green&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> numbers = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//好的写法</span></span><br><span class="line"><span class="keyword">var</span> colors = [<span class="string">&quot;red&quot;</span>, <span class="string">&quot;blue&quot;</span>, <span class="string">&quot;green&quot;</span>];</span><br><span class="line"><span class="keyword">var</span> numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br></pre></td></tr></table></figure>

<h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><p><code>单行注释</code><br>&#x2F;&#x2F;something</p>
<ul>
<li>独占一行，解释下一行，注释前留一空行，缩进与下一行保持一致</li>
<li>尾部注释与代码保持一单位缩进，不应超过最大长度限制</li>
</ul>
<p><code>多行注释</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 第一行注释</span></span><br><span class="line"><span class="comment"> * 第二行注释</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p><code>注释时机</code></p>
<ul>
<li>难于理解的代码</li>
<li>可能被理解错误的代码</li>
<li>浏览器兼容性</li>
</ul>
<p><code>文档注释</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">这是一个文档注释</span></span><br><span class="line"><span class="comment">**/</span></span><br></pre></td></tr></table></figure>

<h3 id="语句和表达式"><a href="#语句和表达式" class="headerlink" title="语句和表达式"></a>语句和表达式</h3><p><code>基本</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//好的写法</span></span><br><span class="line"><span class="keyword">if</span> (condition) &#123;</span><br><span class="line">    <span class="title function_">doSomething</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//不好的写法</span></span><br><span class="line"><span class="keyword">if</span> (condition)</span><br><span class="line">    <span class="title function_">doSomething</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (condition) <span class="title function_">doSomething</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (condition) &#123; <span class="title function_">doSomething</span>(); &#125;</span><br></pre></td></tr></table></figure>
<p>缩进应对齐<br>所有块语句都应使用花括号</p>
<ul>
<li>if</li>
<li>for</li>
<li>while</li>
<li>do…while…</li>
<li>try…catch…finally</li>
</ul>
<p><code>花括号对齐方式</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//好的写法</span></span><br><span class="line"><span class="keyword">if</span> (condition) &#123;</span><br><span class="line">    <span class="title function_">doSomething</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">doSomethingElse</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//不好的写法</span></span><br><span class="line"><span class="keyword">if</span> (condition)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_">doSomething</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_">doSomethingElse</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>块语句间隔</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//好的写法</span></span><br><span class="line"><span class="keyword">if</span> (condition) &#123;</span><br><span class="line">    <span class="title function_">doSomething</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//不好的写法</span></span><br><span class="line"><span class="keyword">if</span>(condition)&#123;</span><br><span class="line">    <span class="title function_">doSomething</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( condition ) &#123;</span><br><span class="line">    <span class="title function_">doSomething</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>switch</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>(condition) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;first&quot;</span>:</span><br><span class="line">         <span class="comment">//代码</span></span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;second&quot;</span>:</span><br><span class="line">         <span class="comment">//代码</span></span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;third&quot;</span>:</span><br><span class="line">         <span class="comment">//代码</span></span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">         <span class="comment">//代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>with</code><br>禁用</p>
<p><code>for</code><br>避免使用continue</p>
<p><code>for-in</code><br>不应遍历数组</p>
<h3 id="变量、函数和运算符"><a href="#变量、函数和运算符" class="headerlink" title="变量、函数和运算符"></a>变量、函数和运算符</h3><p><code>变量声明</code></p>
<ul>
<li>注意提升机制</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//好的写法</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">doSomethingWithItems</span>(<span class="params">items</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> value = <span class="number">10</span>,</span><br><span class="line">        result = value + <span class="number">10</span>,</span><br><span class="line">        i,</span><br><span class="line">        len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>, len=items.<span class="property">length</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="title function_">doSomething</span>(items[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>函数声明</code></p>
<ul>
<li>先定义后使用</li>
<li>不应在块语句内定义</li>
<li>函数名与左括号间无空格</li>
</ul>
<p><code>立即调用函数</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//好的写法</span></span><br><span class="line"><span class="keyword">var</span> value = (<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">//函数体</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;Done&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;());</span><br></pre></td></tr></table></figure>

<p><code>严格模式</code></p>
<ul>
<li>应在函数体内使用，而非全局</li>
</ul>
<p><code>相等</code></p>
<ul>
<li>应使用 ‘&#x3D;&#x3D;&#x3D;’, ‘!&#x3D;&#x3D;’, 而不是 ‘&#x3D;&#x3D;’, ‘!&#x3D;’</li>
</ul>
<p><code>eval()</code></p>
<ul>
<li>避免使用 eval(), Function<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不好的写法</span></span><br><span class="line"><span class="keyword">var</span> myfunc = <span class="keyword">new</span> <span class="title class_">Function</span>(<span class="string">&quot;alert(&#x27;Hi!&#x27;)&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="string">&quot;document.body.style.background=&#x27;red&#x27;&quot;</span>, <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="string">&quot;document.title = &#x27;It is now&#x27;&quot;</span> + (<span class="keyword">new</span> <span class="title class_">Date</span>()), <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//而应使用匿名函数代替</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">style</span>.<span class="property">background</span>=<span class="string">&#x27;red&#x27;</span>;</span><br><span class="line">&#125;, <span class="number">50</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<p><code>原始包装类型</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不好的写法</span></span><br><span class="line"><span class="keyword">var</span> name = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;Mike&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> author = <span class="keyword">new</span> <span class="title class_">Boolean</span>(ture);</span><br><span class="line"><span class="keyword">var</span> count = <span class="keyword">new</span> <span class="title class_">Number</span>(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-码农札记" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2017/05/15/%E7%A0%81%E5%86%9C%E6%9C%AD%E8%AE%B0/">码农札记</a>
      
        
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2017-05-15T13:00:00.000Z" itemprop="datePublished">五月 15, 2017, 9:00 晚上</time>

          
            × <span class="article-word-count">1.4k words</span>
            
            × <span class="article-time-to-read">6 minutes</span>
            
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <h3 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h3><h4 id="日常操作"><a href="#日常操作" class="headerlink" title="日常操作"></a>日常操作</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取远端代码</span></span><br><span class="line">git fetch upstream xxxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将远端代码合并到本地</span></span><br><span class="line">git merge upstream/xxxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取并合并代码</span></span><br><span class="line">git pull</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看不同(工作区与暂存区)</span></span><br><span class="line">git diff</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看工作区修改的文件</span></span><br><span class="line">git status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 放弃工作区的修改</span></span><br><span class="line">git checkout</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将修改的文件提交到暂存区</span></span><br><span class="line">git add</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交更改</span></span><br><span class="line">git commit -m <span class="string">&quot;# 注释&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交到远端</span></span><br><span class="line">git push origin xxxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看提交日志</span></span><br><span class="line">git <span class="built_in">log</span> (--pretty=oneline)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 版本回退</span></span><br><span class="line">git reset --hard HEAD^   <span class="comment"># 上一个版本</span></span><br><span class="line">git reset --hard HEAD^^  <span class="comment"># 上上一个版本</span></span><br><span class="line">git reset --hard HEAD~20 <span class="comment"># 上20个版本</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 回到未来</span></span><br><span class="line">git reflog</span><br><span class="line">git reset</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除文件</span></span><br><span class="line">git <span class="built_in">rm</span></span><br><span class="line">git commit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并一个commit</span></span><br><span class="line">git cherry-pick [commitId]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改上一次commit注释</span></span><br><span class="line">git commit --amend -m <span class="string">&#x27;# 新的注释&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示将要删除的文件</span></span><br><span class="line">git clean -n</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除没有track的文件，不包含.gitignore</span></span><br><span class="line">git clean -f</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除指定路径下没有track的文件</span></span><br><span class="line">git clean -f &lt;path&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除当前目录下没有track的文件和文件夹</span></span><br><span class="line">git clean -fd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暂存更改</span></span><br><span class="line">git stash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 弹出暂存</span></span><br><span class="line">git stash pop</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 远程仓库</span></span><br><span class="line"><span class="comment"># 创建SSH KEY</span></span><br><span class="line"><span class="comment"># 用户目录 .ssh/</span></span><br><span class="line"><span class="comment"># id_rsa 私钥</span></span><br><span class="line"><span class="comment"># id_rsa.pub 公钥</span></span><br><span class="line">ssh-keygen -t rsa -C <span class="string">&quot;my@email.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在Github上 Add SSH Key, 粘贴公钥内容</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 克隆远端代码</span></span><br><span class="line">git <span class="built_in">clone</span> some_url</span><br></pre></td></tr></table></figure>

<h4 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建并切换到分支</span></span><br><span class="line">git checkout -b dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 等同于</span></span><br><span class="line">git branch dev</span><br><span class="line">git checkout dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看分支</span></span><br><span class="line">git branch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并分支</span></span><br><span class="line">git merge</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除分支</span></span><br><span class="line">git branch -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看分支合并图</span></span><br><span class="line">git <span class="built_in">log</span> --graph</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分支策略</span></span><br><span class="line">git merge --no-ff -m <span class="string">&quot;注释&quot;</span> dev</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Bug分支</span></span><br><span class="line"><span class="comment"># 暂存修改</span></span><br><span class="line">git stash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回到master，并创建新分支，修复后提交</span></span><br><span class="line">git checkout master</span><br><span class="line">git checkout -b issue-101</span><br><span class="line">git commit -m <span class="string">&quot;fix-issue-101&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并bug分支并删除</span></span><br><span class="line">git checkout master</span><br><span class="line">git merge --no-ff -m <span class="string">&quot;m-merge-issue-101&quot;</span> issue-101</span><br><span class="line">git branch -d issue-101</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将修复bug后的master合并到dev</span></span><br><span class="line">git checkout dev</span><br><span class="line">git merge --no-ff -m <span class="string">&quot;dev-merge-m&quot;</span> master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 弹出暂存的修改</span></span><br><span class="line">git stash pop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修复冲突</span></span><br><span class="line">git commit -m <span class="string">&quot;fixconflict &amp; append something&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 完成后提交</span></span><br><span class="line">git checkout master</span><br><span class="line">git merge --no-ff -m <span class="string">&quot;m-merge-dev&quot;</span> dev</span><br><span class="line">git branch -d dev</span><br></pre></td></tr></table></figure>
<h4 id="标签管理"><a href="#标签管理" class="headerlink" title="标签管理"></a>标签管理</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建标签，默认HEAD，也可指定commit id</span></span><br><span class="line">git tag &lt;name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定标签信息</span></span><br><span class="line">git tag -a &lt;tagname&gt; -m <span class="string">&quot;message&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PGP签名标签</span></span><br><span class="line">git tag -s &lt;tagname&gt; -m <span class="string">&quot;message&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有标签</span></span><br><span class="line">git tag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送本地标签</span></span><br><span class="line">git push origin &lt;tagname&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送全部本地未推送的标签</span></span><br><span class="line">git push origin --tags</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除一个本地标签</span></span><br><span class="line">git tag -d &lt;tagname&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除一个远程标签</span></span><br><span class="line">git push origin :refs/tags/&lt;tagname&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><h4 id="文件命令"><a href="#文件命令" class="headerlink" title="文件命令"></a>文件命令</h4><table>
<thead>
<tr>
<th>命令</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>ls</td>
<td>列出目录</td>
</tr>
<tr>
<td>ls -al</td>
<td>使用格式化列出隐藏文件</td>
</tr>
<tr>
<td>cd dir</td>
<td>更改目录到dir</td>
</tr>
<tr>
<td>cd</td>
<td>更改到home目录</td>
</tr>
<tr>
<td>pwd</td>
<td>显示当前目录</td>
</tr>
<tr>
<td>mkdir dir</td>
<td>创建目录dir</td>
</tr>
<tr>
<td>rm file</td>
<td>删除file</td>
</tr>
<tr>
<td>rm -r dir</td>
<td>删除目录dir</td>
</tr>
<tr>
<td>rm -f file</td>
<td>强制删除file</td>
</tr>
<tr>
<td>rm -rf dir</td>
<td>强制删除目录dir</td>
</tr>
<tr>
<td>cp file1 file2</td>
<td>将file1复制到file2</td>
</tr>
<tr>
<td>cp -r dir1 dir2</td>
<td>将file1复制到dir2，如果dir2不存在则创建它</td>
</tr>
<tr>
<td>mv file1 file2</td>
<td>将file1重命名或移动到file2，若file2存在则移动</td>
</tr>
<tr>
<td>ln -s file link</td>
<td>创建file的符号连接link</td>
</tr>
<tr>
<td>touch file</td>
<td>创建file</td>
</tr>
<tr>
<td>cat &gt; file</td>
<td>将标准输入添加到file</td>
</tr>
<tr>
<td>more file</td>
<td>查看file的内容</td>
</tr>
<tr>
<td>head file</td>
<td>查看file的前10行</td>
</tr>
<tr>
<td>tail file</td>
<td>查看file的后10行</td>
</tr>
<tr>
<td>tail -f file</td>
<td>从后10行开始查看file的内容</td>
</tr>
</tbody></table>
<h4 id="进程管理"><a href="#进程管理" class="headerlink" title="进程管理"></a>进程管理</h4><table>
<thead>
<tr>
<th>命令</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>ps</td>
<td>显示当前的活动进程</td>
</tr>
<tr>
<td>top</td>
<td>显示所有正在运行的进程</td>
</tr>
<tr>
<td>kill pid</td>
<td>杀掉进程id pid</td>
</tr>
<tr>
<td>killall proc</td>
<td>杀掉所有名为proc的进程</td>
</tr>
<tr>
<td>bg</td>
<td>列出已停止或后台的作业</td>
</tr>
<tr>
<td>fg</td>
<td>将最近的作业带到前台</td>
</tr>
<tr>
<td>fg n</td>
<td>将作业n带到前台</td>
</tr>
</tbody></table>
<h4 id="文件权限"><a href="#文件权限" class="headerlink" title="文件权限"></a>文件权限</h4><table>
<thead>
<tr>
<th>命令</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>chmod octal file</td>
<td>更改file的权限</td>
</tr>
</tbody></table>
<ul>
<li>4 读（r）</li>
<li>2 写（w）</li>
<li>1 执行（x）</li>
</ul>
<h4 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h4><table>
<thead>
<tr>
<th>命令</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>ssh user@host</td>
<td>以user用户连接到host</td>
</tr>
<tr>
<td>ssh -p port user@host</td>
<td>在端口port以user用户身份连接到host</td>
</tr>
<tr>
<td>ssh-copy-id user@host</td>
<td>将密钥添加到host以实现无密码登录</td>
</tr>
</tbody></table>
<h4 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h4><table>
<thead>
<tr>
<th>命令</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>grep pattern files</td>
<td>搜索files中匹配pattern的内容</td>
</tr>
<tr>
<td>grep -r pattern dir</td>
<td>递归搜索dir中匹配pattern的内容</td>
</tr>
<tr>
<td>command l grep pattern</td>
<td>搜索command输出中匹配pattern的内容</td>
</tr>
</tbody></table>
<h4 id="系统信息"><a href="#系统信息" class="headerlink" title="系统信息"></a>系统信息</h4><table>
<thead>
<tr>
<th>命令</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>date</td>
<td>显示当前日期和时间</td>
</tr>
<tr>
<td>cal</td>
<td>显示当月的日历</td>
</tr>
<tr>
<td>uptime</td>
<td>显示系统从开机到现在所运行的时间</td>
</tr>
<tr>
<td>w</td>
<td>显示登录的用户</td>
</tr>
<tr>
<td>whoami</td>
<td>查看你的当前用户名</td>
</tr>
<tr>
<td>finger user</td>
<td>显示user的相关信息</td>
</tr>
<tr>
<td>uname -a</td>
<td>显示内核信息</td>
</tr>
<tr>
<td>cat &#x2F;proc&#x2F;cpuinfo</td>
<td>查看cpu的信息</td>
</tr>
<tr>
<td>cat &#x2F;proc&#x2F;meminfo</td>
<td>查看内存信息</td>
</tr>
<tr>
<td>man command</td>
<td>显示command的说明手册</td>
</tr>
<tr>
<td>df</td>
<td>显示磁盘占用情况</td>
</tr>
<tr>
<td>du</td>
<td>显示目录空间占用情况</td>
</tr>
<tr>
<td>free</td>
<td>显示内存及交换区占用情况</td>
</tr>
</tbody></table>
<h4 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h4><table>
<thead>
<tr>
<th>命令</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>tar cf file.tar files</td>
<td>创建包含files的tar文件file.tar</td>
</tr>
<tr>
<td>tar xf file.tar</td>
<td>从file.tar提取文件</td>
</tr>
<tr>
<td>tar czf file.tar.gz files</td>
<td>使用Gzip压缩创建tar文件</td>
</tr>
<tr>
<td>tar xzf file.tar.gz</td>
<td>使用Gzip提取tar文件</td>
</tr>
<tr>
<td>tar cjf file.tar.bz2</td>
<td>使用Bzip2压缩创建tar文件</td>
</tr>
<tr>
<td>tar xjf file.tar.bz2</td>
<td>使用Bzip2提取tar文件</td>
</tr>
<tr>
<td>gzip file</td>
<td>压缩file并重命名为file.gz</td>
</tr>
<tr>
<td>gzip -d file.gz</td>
<td>将file.gz解压缩为file</td>
</tr>
</tbody></table>
<h4 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h4><table>
<thead>
<tr>
<th>命令</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>ping host</td>
<td>ping host并输出结果</td>
</tr>
<tr>
<td>whois domain</td>
<td>获取domain的whois信息</td>
</tr>
<tr>
<td>dig domain</td>
<td>获取domain的DNS信息</td>
</tr>
<tr>
<td>dig -x host</td>
<td>逆向查询host</td>
</tr>
<tr>
<td>wget file</td>
<td>下载file</td>
</tr>
<tr>
<td>wget -c file</td>
<td>断点续传</td>
</tr>
</tbody></table>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>从源代码安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line">dpkg -i pkg.deb</span><br><span class="line">rpm -Uvh pkg.rpm</span><br></pre></td></tr></table></figure>

<h4 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h4><table>
<thead>
<tr>
<th>命令</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>Ctrl + C</td>
<td>停止当前命令</td>
</tr>
<tr>
<td>Ctrl + Z</td>
<td>停止当前命令，并使用fg恢复</td>
</tr>
<tr>
<td>Ctrl + D</td>
<td>注销当前会话，与exit相似</td>
</tr>
<tr>
<td>Ctrl + W</td>
<td>删除当前行中的字</td>
</tr>
<tr>
<td>Ctrl + U</td>
<td>删除整行</td>
</tr>
<tr>
<td>!!</td>
<td>重复上次的命令</td>
</tr>
<tr>
<td>exit</td>
<td>注销当前会话</td>
</tr>
</tbody></table>

      
    </div>
    
    
    
  </div>
</article>



  


  <nav id="page-nav" class="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next »</a>
  </nav>



    </div>
  </div>
  




<div id="settings-container">
  <div id="dark-mode">dark</div>
  <div id="sans-font">sans</div>
</div>
<script type="text/javascript">
let d=document,r=d.documentElement.style,f=r.setProperty.bind(r),l=localStorage,s=l.getItem('s')||(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches),n=l.getItem('n'),m=d.getElementById("dark-mode"),b=()=>{f('--bg-color','#fafafa');f('--code-bg-color','#f4f4f4');f('--text-color','#212121');f('--secondary-color','#808080');f('--tertiary-color','#b0b0b0');f('--link-color','#b5c8cf');f('--link-hover-color','#618794');f('--link-bg-color','#dae4e7');f('--selection-color','#dae4e7');m.innerHTML="dark"},c=()=>{f('--bg-color','#212121');f('--code-bg-color','#292929');f('--text-color','#fff');f('--secondary-color','#c0c0c0');f('--tertiary-color','#6e6e6e');f('--link-color','#4d6b75');f('--link-hover-color','#96b1bb');f('--link-bg-color','#5d828e');f('--selection-color','#acc1c9');m.innerHTML="light"},o=d.getElementById("sans-font"),e=()=>{f('--body-stack','"Lora", "Georgia", "Times New Roman", serif');o.innerHTML="sans"},g=()=>{f('--body-stack','"Lato", "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", "Verdana", sans-serif');o.innerHTML="serif"};m.onclick=()=>{if(s==2){s=1;l.setItem('s',s);c()}else{s=2;l.setItem('s',s);b()}};o.onclick=()=>{if(n==2){n=1;l.setItem('n',n);g()}else{n=2;l.setItem('n',n);e()}};if(!s){s=2;l.setItem('s',2)};if(s==1){c()};if(!n){n=2;l.setItem('n',2)};if(n==1){g()};
</script>




</body>
</html>
